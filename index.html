<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>å³¶å¶¼å€™è»Šå®¤ï¼é–‹å¾€æ°‘ä¸»çš„è½‰å‹æ­£ç¾©åˆ—è»Š</title>
  <!-- Social / link preview -->
  <meta property="og:title" content="å³¶å¶¼å€™è»Šå®¤ï¼é–‹å¾€æ°‘ä¸»çš„è½‰å‹æ­£ç¾©åˆ—è»Š" />
  <meta property="og:description" content="åœ¨è»Šç«™å ´æ™¯ä¸­ï¼Œè·Ÿéš¨è§’è‰²ä¸€åŒå°‹æ‰¾è½‰å‹æ­£ç¾©çš„æ•…äº‹èˆ‡è¦‹è­‰é»ã€‚" />
  <meta property="og:image" content="assets/social_preview.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(180deg, #101318 0%, #05070a 100%);
      color: #111;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      min-height: 100vh;
      height: 100vh;
      height: 100dvh;
      width: 100%;
    }
    @media (min-width: 769px) {
      body {
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }

    /* Desktop layout: large main card + two stacked side cards */
    .layout-desktop {
      width: 100%;
      max-width: 1280px;
      display: flex;
      gap: 24px;
      padding: 24px;
      box-sizing: border-box;
      height: 100vh;
      margin: 0 auto;
    }
    .layout-main {
      flex: 1 1 auto;
      min-width: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 20px;
      box-sizing: border-box;
    }
    .game-canvas-wrap {
      width: 100%;
      height: 100%;
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    canvas {
      border: none;
      background: #000;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      display: block;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: none;
    }
    /* (åŸ infoBox æ¨£å¼å·²åˆªé™¤ï¼Œä¸å†é¡¯ç¤ºç•«é¢æç¤ºæ¡†) */

    /* Popup: åº•éƒ¨æŠ½å±œ Bottom Sheetï¼ˆæ‰‹æ©Ÿå„ªå…ˆï¼‰ */
    .popup-overlay {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      margin: 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 50;
    }
    .popup-overlay.hidden {
      display: none;
    }
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      max-height: 80vh;
      background: #f4e9d7;
      border: 2px solid #c2b59b;
      border-bottom: none;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
      padding-right: 0;
    }
    .bottom-sheet.open {
      transform: translateY(0);
    }
    .bottom-sheet-scroll {
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
      flex: 1;
      min-height: 0;
      padding-right: 14px;
    }
    .bottom-sheet-scroll::-webkit-scrollbar {
      display: none;
    }
    .drag-handle {
      width: 40px;
      height: 4px;
      margin: 10px auto 6px;
      background: #999;
      border-radius: 2px;
      flex-shrink: 0;
    }
    /* æ²å‹•é€²åº¦æ¢ï¼šå³å´å‚ç›´æ¢ */
    .scroll-progress-wrap {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      width: 8px;
      background: rgba(0, 51, 102, 0.1);
      border-radius: 8px 0 0 8px;
      overflow: hidden;
      cursor: pointer;
      z-index: 2;
      box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.06);
    }
    .scroll-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 20%;
      min-height: 24px;
      border-radius: 6px;
      background: linear-gradient(180deg, #00509e 0%, #004080 50%, #003366 100%);
      box-shadow: 0 0 8px rgba(0, 80, 128, 0.4);
      transition: top 0.12s ease-out;
    }
    .scroll-progress-wrap:hover {
      background: rgba(0, 51, 102, 0.18);
    }
    .popup-content {
      position: relative;
      padding: 8px 20px 20px;
      padding-top: max(8px, env(safe-area-inset-top, 0px));
    }
    .popup-title {
      font-size: clamp(26px, 4.6vw, 34px); /* larger title like the image */
      margin: 0 0 16px 0;
      color: #003366; /* deep blue similar to info.png title */
      letter-spacing: 0.06em;
      font-weight: 700;
      padding-bottom: 6px;
      border-bottom: 2px solid #ffffff; /* clear white underline under the title */
    }
    .popup-body {
      font-size: clamp(12px, 1.9vw, 16px); /* slightly smaller to fit more text */
      line-height: 1.8;
      color: #333333;
    }
    .popup-body p {
      margin: 0 0 10px 0;
    }
    .popup-figure {
      float: right;
      margin: 0 0 8px 12px;
      text-align: center;
    }
    .popup-figure img {
      display: block;
      max-width: 140px;
      width: 100%;
      height: auto;
    }
    .popup-figure span {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      color: #555;
    }
    /* é»ƒå®¶æ¯å¥³éš¨èº«åŒ…ï¼šå¯é¸è£åˆ‡ï¼Œè¨­ç‚º 0 å³åŸå°ºå¯¸ */
    .popup-figure--crop img {
      clip-path: inset(0);
    }
    @media (max-width: 600px) {
      .popup-figure {
        float: right;
        margin: 0 0 10px 12px;
      }
      .popup-figure img {
        max-width: 100px;
      }
    }
    .popup-close {
      position: absolute;
      top: 6px;
      right: 14px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #f4e9d7;
      color: #555;
      font-size: 18px;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      z-index: 3;
    }
    .popup-close:hover {
      background: #e2d6c1;
    }

    /* é›»è…¦ç‰ˆï¼šè·³çª—ç½®ä¸­ï¼ŒéæŠ½å±œ */
    @media (min-width: 769px) {
      .popup-overlay {
        align-items: center;
        justify-content: center;
      }
      .bottom-sheet {
        position: relative;
        left: auto;
        right: auto;
        bottom: auto;
        width: min(90vw, 520px);
        max-height: 85vh;
        margin: auto;
        border-radius: 16px;
        border: 2px solid #c2b59b;
        transform: none;
        transition: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .bottom-sheet.open {
        transform: none;
      }
      .drag-handle {
        display: none;
      }
    }

    .controls {
      position: relative;
      margin-top: 8px;
      display: grid;
      grid-template-columns: 52px 52px 52px;
      grid-template-rows: 52px 52px 52px;
      gap: 6px;
      touch-action: none;
      user-select: none;
      justify-content: center;
      margin-bottom: 8px;
    }

    /* Desktop-only help button on the right side */
    .help-button-desktop {
      position: fixed;
      right: 16px;
      top: 16px;
      transform: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #333;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
      z-index: 30;
    }

    /* DEBUG æ¨¡å¼æŒ‰éˆ•èˆ‡åº§æ¨™é¢æ¿ */
    .debug-btn {
      position: fixed;
      left: 16px;
      top: 16px;
      width: 48px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #2a2a2a;
      color: #0f0;
      font-size: 11px;
      font-family: monospace;
      cursor: pointer;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .debug-panel {
      position: fixed;
      left: 16px;
      top: 54px;
      min-width: 200px;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #444;
      border-radius: 6px;
      color: #0f0;
      font-size: 12px;
      font-family: monospace;
      line-height: 1.5;
      z-index: 31;
      white-space: pre;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
    }
    .debug-panel.hidden {
      display: none;
    }
    .debug-copy-btn {
      margin-top: 8px;
      padding: 4px 10px;
      width: 100%;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: #0f0;
      font-size: 12px;
      font-family: monospace;
      cursor: pointer;
    }
    .debug-copy-btn:hover {
      background: #444;
    }

    .help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 29;
    }
    .help-overlay.hidden {
      display: none;
    }
    .help-content {
      max-width: 480px;
      max-height: 80vh;
      padding: 16px 20px;
      background: #f4f4f4;
      color: #222;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
    }
    .help-content h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }
    .help-close {
      margin-top: 12px;
      display: inline-block;
      padding: 6px 12px;
      background: #333;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    /* Experience start screen */
    .start-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .start-overlay.hidden {
      display: none;
    }
    .start-card {
      max-width: 520px;
      padding: 20px 24px 18px;
      border-radius: 10px;
      background: #f4f4f4;
      color: #222;
      text-align: center;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
    }
    .start-card h1 {
      margin: 0 0 10px 0;
      font-size: 20px;
      line-height: 1.6;
    }
    .start-card p {
      margin: 0 0 14px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .start-button {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 18px;
      background: linear-gradient(to bottom, #f7f7f7 0%, #ffffff 70%);
      color: #222;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }
    .start-button:hover {
      background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 80%);
    }
    .btn {
      -webkit-appearance: none;
      appearance: none;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-variant-emoji: text;
      background: #444;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      border: 1px solid #666;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }
    .btn .arrow-icon {
      width: 28px;
      height: 28px;
      fill: currentColor;
      pointer-events: none;
    }
    .btn.active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
      background: #777;
    }

    /* Global soft fade-in animation */
    @keyframes fade-in-soft {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Apply fade-in to main cards and key UI elements */
    body,
    .layout-desktop,
    .game-wrapper,
    .side-card,
    #infoBox,
    .controls,
    .start-overlay,
    .help-overlay,
    #popup {
      animation: fade-in-soft 0.7s ease-out both;
    }

    @media (max-width: 768px) {
      body {
        font-size: 16px;
      }
      #infoBox {
        font-size: 16px;
      }
      .popup-title {
        font-size: clamp(20px, 5.2vw, 26px);
      }
      .popup-body {
        font-size: 15px;
      }
      .start-card h1 {
        font-size: 18px;
      }
      .start-card p {
        font-size: 15px;
      }
      .help-content {
        font-size: 15px;
      }
      /* æ‰‹æ©Ÿç›´å‘ï¼šæ»¿ç‰ˆï¼Œç„¡å·¦å³é–“è· */
      .layout-desktop {
        flex-direction: column;
        padding: 0;
        margin: 0;
        width: 100%;
        max-width: 100%;
        height: 100vh;
        height: 100dvh;
      }
      .layout-side {
        display: none;
      }
      .layout-main {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-rows: 3.6fr 1fr;
        grid-template-columns: 1fr;
        justify-items: stretch;
        align-items: start;
        gap: 0;
        min-height: 0;
        padding: 0;
        padding-bottom: max(1.5vh, env(safe-area-inset-bottom, 0px));
        box-sizing: border-box;
        overflow: hidden;
      }
      .game-canvas-wrap {
        min-height: 0;
        width: 100%;
        max-width: 100vw;
      }
      canvas {
        border-radius: 18px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      }
      #infoBox {
        position: absolute;
        left: 50%;
        bottom: 80px;
        transform: translateX(-50%);
        margin-top: 0;
        max-width: 90%;
      }
      .controls {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 35vh;
        min-height: 140px;
        margin: 0;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        z-index: 20;
        justify-content: center;
        align-content: center;
        grid-template-columns: 64px 64px 64px;
        grid-template-rows: 64px 64px 64px;
        gap: 8px;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.4) 30%,
          rgba(10, 12, 16, 0.85) 70%,
          rgba(10, 12, 16, 1) 100%
        );
      }
      .controls::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        pointer-events: none;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow:
          0 0 30px rgba(0, 0, 0, 0.6),
          0 0 10px rgba(255, 255, 255, 0.05) inset;
        z-index: -1;
      }
      .btn {
        font-size: 24px;
      }
      .btn .arrow-icon {
        width: 32px;
        height: 32px;
      }

      /* Mobile: hide help button (no hamburger / question mark on phone) */
      .help-button-desktop {
        display: none;
      }
    }
    /* æ¡Œæ©Ÿç‰ˆï¼šCanvas ä¾é«˜åº¦ç¸®æ”¾ï¼Œå¯¬åº¦è‡ªå‹•è¨ˆç®—ï¼Œä¸åšæ°´å¹³æ‹‰ä¼¸ï¼›æ–¹å‘éµå›ºå®šåœ¨å³ä¸‹è§’ */
    @media (min-width: 769px) {
      .layout-desktop {
        max-width: 100%;
        height: 100vh;
      }
      .layout-main,
      .layout-side {
        height: 100%;
      }
      .game-wrapper {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      .game-canvas-wrap {
        height: 90vh;
        width: 100%;
      }
      canvas {
        border-radius: 16px;
        overflow: hidden;
      }
      .controls {
        position: fixed;
        right: 40px;
        bottom: 40px;
        transform: none;
        margin: 0;
        z-index: 40;
        grid-template-columns: 52px 52px 52px;
        grid-template-rows: 52px 52px 52px;
        gap: 6px;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 190px;
        height: 190px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.85);
        z-index: -1;
      }
    }

    /* æ‰‹æ©Ÿæ©«å‘ï¼šéŠæˆ²å¡«æ»¿é«˜åº¦ã€ä¸Šæ–¹è²¼é½Šï¼Œæ–¹å‘éµåœ¨ç•«é¢å³ä¸‹è§’ï¼Œéš±è— ? æŒ‰éˆ•ï¼›å³å´å¡ç‰‡ä¸é¡¯ç¤º */
    @media (max-width: 1024px) and (orientation: landscape) {
      .layout-desktop {
        flex-direction: column;
        padding: 0;
        height: 100vh;
        height: 100dvh;
      }
      .layout-side {
        display: none;
      }
      .layout-main {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        justify-content: flex-start;
        align-items: center;
        overflow: hidden;
      }
      .game-wrapper {
        height: 100vh;
        height: 100dvh;
        padding: 0;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
      }
      .game-canvas-wrap {
        width: 100%;
        height: 100%;
        min-height: 0;
      }
      canvas {
        /* æ‰‹æ©Ÿæ©«å‘ï¼šç”± resizeCanvas + contain ç¹ªè£½ï¼Œä¸å¦ç”¨ CSS scale */
        margin: 0;
        display: block;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      }
      #infoBox {
        position: absolute;
        left: 50%;
        bottom: max(80px, env(safe-area-inset-bottom, 0px) + 80px);
        transform: translateX(-50%);
        margin-top: 0;
        max-width: 90%;
      }

      /* æ‰‹æ©Ÿæ©«å‘ï¼šè·³çª—æ¥è¿‘æ»¿ç‰ˆã€å¯æ²å‹• */
      .popup-content {
        width: min(96vw, 520px);
        max-width: 96vw;
        max-height: min(80vh, 720px);
      }
      .controls {
        /* æ‰‹æ©Ÿæ©«å‘ï¼šæ–¹å‘éµå›ºå®šåœ¨ç•«é¢å³ä¸‹è§’ */
        position: fixed;
        right: max(16px, env(safe-area-inset-right, 0px) + 12px);
        bottom: max(24px, env(safe-area-inset-bottom, 0px) + 16px);
        left: auto;
        transform: none;
        margin: 0;
        z-index: 30;
        grid-template-columns: 64px 64px 64px;
        grid-template-rows: 64px 64px 64px;
        gap: 8px;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.85);
        z-index: -1;
      }

      /* Landscape mobile: hide help button */
      .help-button-desktop {
        display: none;
      }
    }

    /* ç›´å‘è¢å¹•ï¼ˆå«å¹³æ¿ï¼‰ï¼šæ»¿ç‰ˆã€ç„¡å·¦å³é–“è· */
    @media (max-width: 1024px) and (orientation: portrait) {
      .layout-desktop {
        height: 100vh;
        height: 100dvh;
        padding: 0;
        margin: 0;
        max-width: 100%;
      }
      .layout-main {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-rows: 2.8fr 1fr;
        grid-template-columns: 1fr;
        justify-items: stretch;
        align-items: start;
        gap: 0;
        min-height: 0;
        padding: 0;
        padding-bottom: max(1.5vh, env(safe-area-inset-bottom, 0px));
        box-sizing: border-box;
        overflow: hidden;
      }
      .controls {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 35vh;
        min-height: 140px;
        margin: 0;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        z-index: 20;
        justify-content: center;
        align-content: center;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.4) 30%,
          rgba(10, 12, 16, 0.85) 70%,
          rgba(10, 12, 16, 1) 100%
        );
      }
      .controls::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        pointer-events: none;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow:
          0 0 30px rgba(0, 0, 0, 0.6),
          0 0 10px rgba(255, 255, 255, 0.05) inset;
        z-index: -1;
      }
    }
  </style>
</head>
<body>
  <div class="layout-desktop">
    <div class="layout-main">
      <div id="game-canvas-wrap" class="game-canvas-wrap">
        <canvas id="game"></canvas>
      </div>

      <!-- Popup: åº•éƒ¨æŠ½å±œ Bottom Sheet -->
      <div id="popup" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetZhou">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollZhou">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">å‘¨æ¸…æœˆçš„è¨˜è€…è­‰</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="assets/1_0.png" alt="å‘¨æ¸…æœˆçš„è¨˜è€…è­‰åœ–åƒ" />
                  <span>åœ–èªªï¼šå‘¨æ¸…æœˆçš„è¨˜è€…è­‰</span>
                </div>
                <p>æ°‘åœ‹ 70 å¹´ 7 æœˆ 3 æ—¥ï¼Œé™³æ–‡æˆæ•™æˆè¢«ç™¼ç¾é™³å±åœ¨è‡ºç£å¤§å­¸æ ¡å…§ã€‚è€Œå¾Œï¼Œä»–åœ¨ç¾åœ‹å¡å…§åŸºï¼æ¢…éš†å¤§å­¸çš„åŒäº‹â”€â”€æ³•é†«é­å¥‘èˆ‡çµ±è¨ˆç³»ä¸»ä»»ç‹„æ ¼é­¯ä¾†è‡ºï¼Œå°é™³æ–‡æˆä¹‹æ­»é€²è¡Œç¨ç«‹èª¿æŸ¥ã€‚</p>
                <p>é™³æ–‡æˆä¹‹æ­»å¼•èµ·åœ‹å…§å¤–å»£æ³›é—œæ³¨ï¼Œç¾è¯ç¤¾è¨˜è€…å‘¨æ¸…æœˆï¼ˆTina Chouï¼‰æ¡è¨ªé™³æ–‡æˆçš„çˆ¶è¦ªå¾Œï¼Œé‡å°ç‹„æ ¼é­¯èˆ‡é­å¥‘ä¾†è‡ºæ’°å¯«äº†å ±å°ã€‚å› ç‚ºé€™ç¯‡å ±å°ï¼Œå‘¨æ¸…æœˆè¢«æ–°èå±€ä»¥ã€Œåœ¨åœ‹éš›é–“åš´é‡æåŠä¸­è¯æ°‘åœ‹ä¸»æ¬Šèˆ‡æ³•å¾‹çš„å°Šåš´ã€ç‚ºç”±ï¼Œå–æ¶ˆäº†è¨˜è€…è­‰ï¼Œä¸¦ç¦æ­¢å¥¹å¾äº‹ä»»ä½•æ–°èå·¥ä½œã€‚</p>
                <p>å› ç‚ºå ±å°ä¸­æåˆ°é­å¥‘èˆ‡ç‹„æ ¼é­¯ä¾†è‡ºã€Œé©—å±ã€ï¼ˆautopsyï¼‰ï¼Œè€Œæ–°èå±€èªç‚ºå…©äººåƒ…æ˜¯ã€Œæª¢è¦–ã€ï¼ˆviewï¼‰å±é«”ï¼Œä¸¦éã€Œé©—å±ã€ã€‚</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressZhou" aria-label="é–±è®€é€²åº¦">
            <div class="scroll-progress-bar" id="scrollProgressBarZhou"></div>
          </div>
          <button id="popupClose" class="popup-close" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <!-- Popup: é»ƒå®¶æ¯å¥³çš„éš¨èº«åŒ… -->
      <div id="popupHuang" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetHuang">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollHuang">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">é»ƒå®¶æ¯å¥³çš„éš¨èº«åŒ…</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="è»Šå»‚1ç‰©ä»¶/é»ƒå®¶æ¯å¥³ç„¡äºº.png" alt="é»ƒå®¶æ¯å¥³çš„éš¨èº«åŒ…åœ–åƒ" />
                  <span>åœ–èªªï¼šé»ƒå®¶æ¯å¥³çš„éš¨èº«åŒ…</span>
                </div>
                <p>æ°‘åœ‹42å¹´ï¼Œé»ƒæº«æ­é­åˆ°æ§æ±ºï¼Œç•¶æ™‚ä»–çš„é•·å¥³é»ƒéˆ´è˜­å¹´åƒ…5æ­²ã€‚</p>
                <p>é»ƒæº«æ­æ˜¯è·¯ç«¹é„‰çš„é½’ç§‘é†«ç”Ÿï¼Œå› æ¶‰åŠã€Œçœå·¥å§”ç‡•å·¢ã€è·¯ç«¹æ”¯éƒ¨æ¡ˆã€è¢«åˆ¤åˆ‘ï¼Œç•™ä¸‹å¦»å­é»ƒæ¥Šæ¸…è“®å’Œä¸‰å€‹å­©å­ã€‚</p>
                <p>å§Šå§Šé»ƒéˆ´è˜­æˆé•·è¨˜æ†¶è£¡ï¼Œæ¯è¦ªç¸½æ˜¯éš¨èº«å¸¶ä¸€å€‹å°åŒ…åŒ…ï¼Œè£¡é¢æ”¾è‘—å„å¼è­‰ä»¶ï¼Œä»¥å‚™è­¦å¯Ÿæª¢æŸ¥ã€‚æ™šå¹´å¤±æ™ºæ™‚ï¼Œæ¯è¦ªå¸¸æª¢æŸ¥å®Œèº«åˆ†è­‰åˆé¦¬ä¸Šå¿˜è¨˜ï¼Œå¿˜è¨˜åˆå†æª¢æŸ¥ã€‚ç›´åˆ°è‡¨çµ‚ï¼Œæ¯è¦ªä¾èˆŠå°‡è£æ»¿è­‰ä»¶çš„å°åŒ…åŒ…æ”¾åœ¨åºŠé‚Šï¼Œçµ‚æ—¥ç”Ÿæ´»åœ¨ææ‡¼ä¸‹ã€‚</p>
                <p>è€Œå³ä½¿å§Šå¦¹å…©äººé•·å¤§æˆäººï¼Œæ­¥å…¥å©šå«ï¼Œä¾†è‡ªæ”¿åºœçš„ç›£æ§ä»æ²’æœ‰åœæ­¢ã€‚</p>
                <p>æ¯å‘¨éƒ½æœƒæœ‰è­¦å¯Ÿé€²è¡Œæˆ¶å£æŸ¥å¯Ÿï¼Œåœ¨å¸‚å ´åšç”Ÿæ„æ™‚ï¼Œè­¦å¯Ÿä¹Ÿåˆ©ç”¨å„ç¨®ç†ç”±æ‰“æ“¾ã€‚ä¾‹å¦‚è¦æ±‚å¯«å•å·èª¿æŸ¥ä¾†ç•™ä¸‹ç­†è·¡ï¼Œæ¯”è¼ƒç›´ç™½çš„è­¦å¯Ÿï¼Œé‚„æœƒç›´æ¥ç´¢å–ç…§ç‰‡ï¼Œé‚£ç¨®ç„¡å½¢çš„å£“åŠ›ï¼Œåœ¨å¿ƒä¸­åŸ‹è—å¾ˆä¹…ã€‚</p>
                <p>å¦¹å¦¹é»ƒæ˜¥è˜­å¶çˆ¾ä¹Ÿæœƒæƒ³ï¼šã€Œå…¶å¯¦æ•´å€‹äº‹æƒ…æ˜¯çˆ¶è¦ªä¸€å€‹äººåšçš„ï¼Œç‚ºä»€éº¼å®¶è£¡æ‰€æœ‰äººéƒ½è¦å—åˆ°é€™ç¨®ç›£æ§ï¼Ÿã€</p>
                <p>å°é»ƒå®¶çš„ç›£æ§è‡ªæ°‘åœ‹48å¹´é–‹å§‹ï¼Œè‡³79å¹´æ’¤éŠ·ï¼ŒæŒçºŒè¶…é30å¹´ã€‚</p>
                <p>æª”æ¡ˆè§£å¯†å¾Œï¼Œé»ƒæ˜¥è˜­åœ¨é–±è¦½æª”æ¡ˆæ™‚åˆ†äº«ï¼šã€Œæˆ‘å€‘æ”¿æ²»å—é›£è€…å®¶å±¬æœ€å¸¸è½åˆ°çš„ï¼Œå°±æ˜¯ã€äº‹æƒ…éƒ½é€™éº¼ä¹…äº†ï¼Œè©²æ”¾ä¸‹ï¼Œè¦èµ°å‡ºå»ï¼Œå¯æ˜¯ä½ å€‘ç‚ºä»€éº¼ä¸€ç›´ä¸èµ°éå»å‘¢ï¼Ÿç‚ºä»€éº¼ä¸€ç›´ä¸æ”¾ä¸‹ï¼Ÿã€æˆ‘è¦ºå¾—æ­·å²å°šæœªå®Œå…¨æ˜æœ—ï¼Œé€™ç¨®äº‹æƒ…å°æˆ‘å€‘ä¾†èªªå…¶å¯¦ç›¸ç•¶æ²‰é‡ï¼Œä¸æ˜¯æˆ‘å€‘ä¸æƒ³èµ°éå»ï¼Œæˆ‘ä¹Ÿå¸Œæœ›æœ‰éå¸¸å¿«æ¨‚çš„äººç”Ÿå‘€â€¦â€¦ã€</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressHuang" aria-label="é–±è®€é€²åº¦">
            <div class="scroll-progress-bar" id="scrollProgressBarHuang"></div>
          </div>
          <button id="popupHuangClose" class="popup-close" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <!-- Popup: æœå­ç”Ÿ -->
      <div id="popupDu" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetDu">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollDu">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">æœå­ç”Ÿçš„è½è¨ºå™¨</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="è»Šå»‚1ç‰©ä»¶/æœå­ç”Ÿç„¡äºº.png" alt="æœå­ç”Ÿçš„è½è¨ºå™¨åœ–åƒ" />
                  <span>åœ–èªªï¼šæœå­ç”Ÿçš„è½è¨ºå™¨</span>
                </div>
                <p>æ–°ç¾è¾²å ´çš„é–‹æ‹“ä¸¦ä¸å®¹æ˜“ï¼Œé„’æ—äººåˆ°é€™è£¡æ™‚ï¼ŒåœŸåœ°é‚„æ˜¯ä¸€ç‰‡æ£®æ—ã€‚</p>
                <p>ç•¶æ™‚é„’æ—äººç”Ÿæ´»å ´åŸŸèƒ½å¤ è€•ä½œçš„åœ°å¾ˆå°‘ä¸”é™¡å³­ï¼Œé˜¿é‡Œå±±é„’æ—é ˜è¢–é«˜ä¸€ç”Ÿèˆ‡èƒå¼Ÿæœå­ç”Ÿï¼ˆVoytte Toskttï¼‰ï¼Œå¸Œæœ›è®“æ—äººçš„ç”Ÿæ´»éå¾—æ›´å¥½ï¼Œæ‰€ä»¥ç”±é”é‚¦ï¼ˆtapangxï¼‰éƒ¨è½é·ç§»è‡³æ–°ç¾ï¼ˆyaisanaï¼‰è¾²å ´ã€‚</p>
                <p>æœå­ç”Ÿç•¢æ¥­æ–¼è‡ºåŒ—å¸åœ‹å¤§å­¸é™„å±¬é†«å­¸å°ˆé–€éƒ¨ï¼ŒåŒæ™‚å…¼ä»»å³é³³é„‰è¡›ç”Ÿæ‰€æ‰€é•·ï¼Œä»¥åŠæ–°ç¾è¾²å ´å ´é•·ã€‚</p>
                <p>ä¸€é–‹å§‹æ–°ç¾è¾²å ´å°šæœªæœ‰ç³§é£Ÿç”¢å‡ºï¼Œå› æ­¤ç¬¬ä¸€æ‰¹æ—äººæ¯ 10 å¤©å°±éœ€è¦å¾€è¿”é”é‚¦æ¬é‹åœ°ç“œç­‰ç‰©è³‡ä½œç‰©ï¼Œä¾›å¢¾è’ä¹‹ç”¨ã€‚è·¯é€”é™é ï¼Œç”šè‡³è¦ä¸­é€”éå¤œï¼Œé•·é”åŠå¹´ä¹‹ä¹…ã€‚</p>
                <p>æ°‘åœ‹ 41 å¹´ 9 æœˆï¼Œæœå­ç”Ÿèˆ‡é«˜ä¸€ç”Ÿè¢«ä»¥ã€Œä¸‹å±±é–‹æœƒã€ç‚ºç”±èª˜å‡ºï¼Œå¯¦ç‚ºæƒ…æ²»å–®ä½çš„èª˜æ•ã€‚é€®æ•å¾Œï¼Œç•¶å±€åœ¨éƒ¨è½å…§æ•£æ’­æŒ‡æ§æœå­ç”Ÿç­‰äººã€Œä¾µå æ–°ç¾è¾²å ´å…¬æ¬¾èˆ‡ç¨®å­ã€ã€Œä¾µå æ”¿åºœé…ç™¼è‚¥æ–™èˆ‡æ£‰å¸ƒã€ç­‰å®£å‚³ã€‚</p>
                <p>æœ¬æ‡‰ç”±æ™®é€šæ³•é™¢å¯©ç†çš„æ¡ˆä»¶ï¼Œåœ¨åƒè¬€ç¸½é•·å‘¨è‡³æŸ”è¦æ±‚ä¸‹æ”¹ç”±è»æ³•å¯©åˆ¤ã€‚è»æ³•å®˜æœªèª¿æŸ¥å°æœå­ç”Ÿæœ‰åˆ©çš„è­‰æ“šï¼Œæƒ…æ²»æ©Ÿé—œä¹Ÿæœªå–å¾—é—œéµè­‰æ“šã€Œæ–°ç¾è¾²å ´å¸³å†Šã€ã€‚æœå­ç”Ÿè¢«åˆ¤ 17 å¹´å¾’åˆ‘ã€‚</p>
                <p>å‡ºç„å¾Œå› å†¤åæœªé›ªï¼Œä¸è¢«éƒ¨è½æ¥ç´ï¼Œæœå­ç”Ÿå¾Œæ–¼å°æ±é–‹è¨­è¨ºæ‰€ã€‚æ”¿åºœå°é˜¿é‡Œå±±åŸä½æ°‘çš„æ”¿æ²»ç›£æ§æ„åœ¨å£“åˆ¶ç•°è­°ã€æ§åˆ¶åŸä½æ°‘æ—ï¼Œã€Œè²ªæ±¡ã€æ±¡åè‡³ä»Šä»å½±éŸ¿éƒ¨è½ã€‚</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressDu" aria-label="é–±è®€é€²åº¦">
            <div class="scroll-progress-bar" id="scrollProgressBarDu"></div>
          </div>
          <button id="popupDuClose" class="popup-close" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <!-- Popup: åŠ‰æ°¸ç¥¥ -->
      <div id="popupLiu" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetLiu">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollLiu">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">åŠ‰æ°¸ç¥¥çš„å­¸ç”Ÿè­‰</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="è»Šå»‚1ç‰©ä»¶/åŠ‰æ°¸ç¥¥ç„¡äºº.png" alt="åŠ‰æ°¸ç¥¥çš„å­¸ç”Ÿè­‰åœ–åƒ" />
                  <span>åœ–èªªï¼šåŠ‰æ°¸ç¥¥çš„å­¸ç”Ÿè­‰</span>
                </div>
                <p>åœ‹å…±å…§æˆ°çˆ†ç™¼å¾Œï¼Œæœ‰æ•¸åƒåå­¸ç”Ÿå¾é’å³¶æ’¤é€€ä¸Šæµ·ï¼Œè¼¾è½‰æ¹–å—ã€å»£æ±ï¼Œæœ€å¾Œå€‰çš‡é€ƒåˆ°æ¾æ¹–ï¼ŒåŠ‰æ°¸ç¥¥å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</p>
                <p>æ•™è‚²éƒ¨å’Œæ¾æ¹–é˜²å®ˆå¸ä»¤éƒ¨å•†å®šï¼Œè®“é€™ç¾¤ä¾†è‡ªå±±æ±çš„æµäº¡å­¸ç”Ÿ 17 æ­²ä»¥ä¸Šã€ŒåŠè¨“åŠè®€ã€ï¼Œ16 æ­²ä»¥ä¸‹å‰‡æ˜¯è¨­ç«‹ã€Œæ¾æ¹–é˜²å®ˆå¸ä»¤éƒ¨å­å¼Ÿå­¸æ ¡ã€ç¹¼çºŒä¸Šèª²ã€‚</p>
                <p>ä½†æ¾æ¹–é˜²è¡›å¸ä»¤éƒ¨ç‚ºè£œå……åœ‹å…±å…§æˆ°ä¸­è€—æçš„å…µå“¡ï¼Œä¸é¡§èˆ‡æ•™è‚²éƒ¨å•†å®šã€ŒåŠè¨“åŠè®€ã€çš„ä¿è­‰ï¼Œå°‡è¶…éåƒåæµäº¡å­¸ç”Ÿå¼·åˆ¶ç·¨å…¥éƒ¨éšŠï¼Œä¸¦ä»¥æ­¦åŠ›å£“åˆ¶åå°çš„è²éŸ³ï¼Œé€ æˆ 2 åå­¸ç”Ÿé­åˆºå‚·ã€‚</p>
                <p>è¢«å¼·åˆ¶ç·¨å…¥éƒ¨éšŠçš„å­¸ç”Ÿåœ¨æ›¸ä¿¡ä¸­è¡¨é”ä¸æ»¿ï¼Œæ¾æ¹–é˜²è¡›å¸ä»¤éƒ¨å»å°‡ä»–å€‘çš„è¨´æ±‚æ–¥ç‚ºã€Œæ»¿ç´™åŒªè«œåå‹•è¨€èªã€ã€‚æ¾æ¹–é˜²è¡›å¸ä»¤éƒ¨å°‡æ¡ˆä»¶ç§»é€è»æ³•å¯©åˆ¤æ™‚çš„ç´€éŒ„é¡¯ç¤ºï¼Œå…±æœ‰ 96 åå¸«ç”Ÿé­é€®æ•ï¼Œä¸¦å—åˆ°ã€Œç–²å‹åµè¨Šã€ã€‚</p>
                <p>æŒºèº«ç¶­è­·å­¸ç”Ÿæ¬Šç›Šçš„å…©ä½æ ¡é•·ï¼Œä»¥åŠåŠ‰æ°¸ç¥¥èˆ‡å¦å¤– 5 åå­¸ç”Ÿï¼Œè¢«èªå®šç‚ºã€Œä¸»è¦åŒªçŠ¯ã€ï¼Œåˆ¤è™•æ­»åˆ‘ï¼Œæ–¼æ–°åº—æºªç•”å ¤é˜²æ—çš„é¦¬å ´ç”ºåˆ‘å ´æ§æ±ºã€‚é€™èµ·äº‹ä»¶å³ç‚ºæ­·å²ä¸Šæ‰€ç¨±çš„ã€Œä¸ƒä¸€ä¸‰äº‹ä»¶ã€ã€‚</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressLiu" aria-label="é–±è®€é€²åº¦">
            <div class="scroll-progress-bar" id="scrollProgressBarLiu"></div>
          </div>
          <button id="popupLiuClose" class="popup-close" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <!-- Popup: æ¥Šç¿° -->
      <div id="popupYang" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetYang">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollYang">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">é™½ç¿°çš„æƒ…å ±å ±å‘Š</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="è»Šå»‚1ç‰©ä»¶/é™½ç¿°ç„¡äºº.png" alt="é™½ç¿°çš„æƒ…å ±å ±å‘Šåœ–åƒ" />
                  <span>åœ–èªªï¼šé™½ç¿°çš„æƒ…å ±å ±å‘Š</span>
                </div>
                <p>åœ¨ç›£æ§æª”æ¡ˆè£¡å¯«è‘—ï¼Œç·šæ°‘ã€Œé™½ç¿°ã€è² è²¬åœ¨ã€Šæ–°æ–‡åŒ–ã€‹é›œèªŒç¤¾ã€ã€Šè‡ºç£æ–‡è—ã€‹æƒ…è’ï¼Œè€Œé™½ç¿°çœŸå¯¦èº«åˆ†çš„æ¬„ä½ï¼Œå¯«æ˜¯å‰è¡›å‡ºç‰ˆç¤¾è² è²¬äººæ—æ–‡æ¬½ã€‚</p>
                <p>ä½†é€™ä»¶äº‹ï¼Œä»”ç´°æŸ¥çœ‹é™½ç¿°çš„æƒ…å ±å ±å‘Šï¼Œåˆæœƒçœ‹åˆ°ã€Œè‡ºç£æ–°æ–‡åŒ–é›œèªŒç¤¾å‹™å§”å“¡æ—æ–‡æ¬½æ–¼è¾¦å…¬å®¤è«‡è©±â€¦â€¦ã€é€™æ¨£çš„å…§å®¹ï¼Œç­‰æ–¼æ˜¯æ—æ–‡æ¬½è‡ªå·±åœ¨ç›£æ§è‡ªå·±ã€‚</p>
                <p>å†åŠ ä¸Šã€Šè‡ºç£æ–°æ–‡åŒ–ã€‹é›œèªŒå—æ”¿åºœç›£æ§ï¼Œå¤šæ¬¡åœåˆŠåŠæŸ¥æ‰£ï¼Œå¦‚æœæ—æ–‡æ¬½æ˜¯ç·šæ°‘ï¼Œå”åŠ©æ”¿åºœç›£æ§çµæœè‡ªå·±æå¤±æ…˜é‡ï¼Œä¹Ÿä¸ç¬¦å¸¸ç†ã€‚</p>
                <p>ç‚ºäº†ç¢ºèªæª”æ¡ˆå…§å®¹ï¼Œä¿ƒè½‰æœƒè«‹ä¸»ç®¡é€™ä»½æª”æ¡ˆçš„æƒ…æ²»æ©Ÿé—œäººå“¡èªªæ˜ï¼Œè©²äººå“¡å¦è¨€ï¼Œæª”æ¡ˆè£¡é›–ç„¶è¨»è¨˜é™½ç¿°æ˜¯æ—æ–‡æ¬½ï¼Œä½†äº‹å¯¦å»ä¸ç›¡æ˜¯ã€‚</p>
                <p>ã€Œã€ˆæƒ…å ±å ±å‘Šã€‰ä¸Šé¢æœ‰ä¸€å€‹æ ¼å¼ï¼Œä½ è¦å¯«ä¾†æºï¼Œä½ å°±æ›ä¸€å€‹åå­—ã€‚å¯¦éš›ä¸Šä½ è‡ªå·±å»è’å ±ï¼Œå»å•äººã€‚ã€</p>
                <p>ç‚ºä»€éº¼ç™½ç´™é»‘å­—çš„æª”æ¡ˆï¼Œæœƒå‡ºç¾é€™æ¨£çš„ç°è‰²åœ°å¸¶ï¼Ÿå¯èƒ½å› ç‚ºç·šæ°‘é™½ç¿°çš„èº«åˆ†å°å¤–ä¿å¯†ï¼Œå› æ­¤åœ¨èª¿æŸ¥äººå“¡ä¾¿è‡ªè¡Œè¡Œäº‹ï¼Œæª”æ¡ˆè¨˜è¼‰çš„ç›¸é—œè³‡è¨Šï¼Œå°±èƒŒé›¢äº†äº‹å¯¦ã€‚</p>
                <p>ä½†åƒé™½ç¿°çš„æƒ…æ³æ˜¯å¦åªæ˜¯å€‹æ¡ˆï¼Ÿåœ¨ç¼ºä¹å¤§è¦æ¨¡çš„æª”æ¡ˆç ”ç©¶èˆ‡æ ¸å¯¦å·¥ä½œä¹‹å‰ï¼Œé›£ä»¥å¦„ä¸‹è©•è«–ã€‚</p>
                <p>é‚„åŸæ­·å²çœŸç›¸çš„å·¥ä½œï¼Œä¾¿æ˜¯é€éæª”æ¡ˆè³‡æ–™æ ¸å¯¦çš„éç¨‹ï¼Œå°æª”æ¡ˆä¸­çš„ç°è‰²æ®µè½ä¿æŒè­¦æƒ•ï¼Œé€™æ˜¯å› æ‡‰æª”æ¡ˆé–‹æ”¾ä¸å¾—ä¸å¯©æ…é¢å°çš„é‡è¦å·¥ç¨‹ï¼Œå¦å‰‡ä¸ä½†å¯èƒ½é›£ä»¥é‚„åŸæ­·å²çœŸç›¸ï¼Œåè€Œæ‹›è‡´æ›´å¤šçš„èª¤è§£åŠå‚·å®³ã€‚</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressYang" aria-label="é–±è®€é€²åº¦">
            <div class="scroll-progress-bar" id="scrollProgressBarYang"></div>
          </div>
          <button id="popupYangClose" class="popup-close" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <!-- Popup: ç‹å†å‚³çš„é»¨å“¡æ‰‹å†Š -->
      <div id="popupWang" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetWang">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollWang">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">ç‹å†å‚³çš„é»¨å“¡æ‰‹å†Š</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="è»Šå»‚1ç‰©ä»¶/ç‹å†å‚³ç„¡äºº.png" alt="ç‹å†å‚³çš„é»¨å“¡æ‰‹å†Šåœ–åƒ" />
                  <span>åœ–èªªï¼šç‹å†å‚³çš„é»¨å“¡æ‰‹å†Š</span>
                </div>
                <p>æ­·å²ä¸Šçš„ã€Œé¹¿çªŸäº‹ä»¶ã€ï¼Œæ˜¯æŒ‡ç”±åœ‹é˜²éƒ¨ä¿å¯†å±€ä¸»å°ï¼Œåœ¨æ°‘åœ‹ 41ã€42 å¹´é–“ï¼Œé–å®šåœ¨æ±æ­¢ã€çŸ³ç¢‡ã€ç‘èŠ³ç­‰åœ°ç™¼å±•çš„å…±ç”¢é»¨çµ„ç¹”ï¼Œé€²è¡Œä¸€é€£ä¸²çš„èª¿æŸ¥ã€æœæ•åŠå¯©åˆ¤ã€‚</p>
                <p>ç‹å†å‚³è¢«èµ·è¨´æ›¾åœ¨å¤§å®‰å°åˆ·å» å……ç•¶å°åˆ·å·¥ï¼Œç¿»å°ã€Šé–‹åœ‹æ–‡ç»ã€‹ã€ã€Š28 é€±å¹´ç´€å¿µã€‹ã€ã€Šé»¨å“¡æ‰‹å†Šã€‹ç­‰æ›¸ï¼Œä»¥åŠåœ¨é¹¿çªŸåŸºåœ°å……ä»»æˆ°é¬¥å“¡ï¼Œå› æ­¤åˆ¤è™•æ­»åˆ‘ã€‚</p>
                <p>ç‹å†å‚³åƒèˆ‡å…±ç”¢é»¨çµ„ç¹”æˆ–è¨±æ˜¯äº‹å¯¦ï¼Œä½†èª¿é–±å¯©åˆ¤ç›¸é—œæª”æ¡ˆè³‡æ–™ï¼Œæœƒç™¼ç¾åˆ¤æ±ºå…§å®¹èˆ‡éç¨‹å­˜æœ‰çœ¾å¤šç–‘ç¾©ã€‚</p>
                <p>ç‹å†å‚³åœ¨å¯©åˆ¤ç´€éŒ„ä¸­è¡¨ç¤ºï¼šã€Œå› ç‚ºç•¶æ™‚ç”Ÿç—…æ²’æœ‰å—è¨“ï¼Œæˆ°é¬¥å“¡çš„éƒ¨åˆ†æ˜¯æ³•å®˜å•å¤§å®¶æœ‰æ²’æœ‰æˆ‘ä¹Ÿæœ‰ï¼Œä»–å€‘å¯«çš„ï¼Œæˆ‘æ²’æœ‰æ‰¿èªã€‚ã€</p>
                <p>ç‹å†å‚³æ¡ˆæœ€çµ‚å¯©ç†æ—¥æœŸç‚ºæ°‘åœ‹ 43 å¹´ 9 æœˆ 22 æ—¥ï¼Œä½†åˆ¤æ±ºæ›¸æ‰€è¼‰è¾¯è­·äººæ¥è¦‹æ—¥æœŸå»æ˜¯ 9 æœˆ 23 æ—¥ï¼Œæ„å³è¾¯è­·äººæœªå¯¦éš›æ¥è¦‹è¢«å‘Šå³æ’°å¯«è¾¯è­·æ„æ—¨æ›¸ï¼Œä¸¦ä»£ç‚ºã€Œè‡ªç™½èªç½ªã€ã€‚</p>
                <p>ä¾ã€Šæ‡²æ²»å›äº‚æ¢ä¾‹ã€‹å³ä¾¿ç¿»å°æ›¸ç±ã€å—è¨“ï¼ŒåƒåŠ å›äº‚çµ„ç¹”é€šå¸¸ç‚ºç„¡æœŸå¾’åˆ‘æˆ–åå¹´ä»¥ä¸Šæœ‰æœŸå¾’åˆ‘ï¼Œä½†åˆ¤æ±ºå»ä»¥ã€Œç›´æ¥ä»¥éæ³•ä¹‹æ–¹æ³•é¡›è¦†æ”¿åºœã€è«–è™•æ­»åˆ‘ã€‚</p>
                <p>å¯è¦‹ç•¶æ™‚çš„å¸æ³•å·²éä¿éšœäººæ¬Šçš„æœ€å¾Œé˜²ç·šï¼Œè€Œæ˜¯çµ±æ²»è€…æ•´è‚…ç•°å·±çš„æ©Ÿåˆ¶ï¼Œæ³•å®˜æœªä¾è­‰æ“šå®šç½ªï¼Œäº‹å¾Œæ•‘æ¿Ÿç„¡é–€ï¼Œé€ æˆä¸å°‘äººæ¬Šè¿«å®³ã€‚</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressWang" aria-label="é–±è®€é€²åº¦">
            <div class="scroll-progress-bar" id="scrollProgressBarWang"></div>
          </div>
          <button id="popupWangClose" class="popup-close" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <!-- Popup: æ–°ç«¹é«˜å·¥è£¡çš„å¡—é´‰ -->
      <div id="popupZhugong" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetZhugong">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollZhugong">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">æ–°ç«¹é«˜å·¥è£¡çš„å¡—é´‰</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="è»Šå»‚1ç‰©ä»¶/ç«¹å·¥ç„¡äºº.png" alt="æ–°ç«¹é«˜å·¥è£¡çš„å¡—é´‰åœ–åƒ" />
                  <span>åœ–èªªï¼šæ–°ç«¹é«˜å·¥è£¡çš„å¡—é´‰</span>
                </div>
                <p>æ°‘åœ‹ 70 å¹´ï¼Œæ–°ç«¹é«˜å·¥å»æ‰€è£¡æœ‰äººç”¨åŸå­ç­†å¯«ä¸‹ã€Œä¿¡ä»°é¦¬åˆ—ä¸»ç¾©ã€ã€ã€Œåå°ä¸­å¤®æ”¿åºœã€ã€ã€Œæ‰“æ“Šé»‘ç‹—ã€ç­‰å­—å¥ã€‚</p>
                <p>ã€Œæ‰“æ“Šé»‘ç‹—ã€çš„ã€Œé»‘ç‹—ã€æ˜¯è©²æ ¡æ•™å®˜çš„ç¶½è™Ÿï¼Œå¡—é´‰å¯èƒ½å‡ºè‡ªå°æ ¡åœ’ç”Ÿæ´»ä¸æ»¿çš„å­¸ç”Ÿã€‚å¦‚ä»Šçœ‹ä¾†æˆ–è¨±åªæ˜¯å»æ‰€å¡—é´‰ï¼Œç•¶æ™‚é€™é¡ã€Œä¸ç•¶æ–‡å­—ã€å»å¼•èµ·æƒ…æ²»æ©Ÿé—œé«˜åº¦é‡è¦–ã€‚</p>
                <p>æƒ…æ²»æ©Ÿé—œç‚ºæ‰¾å‡ºå»æ‰€å¡—é´‰çš„å­¸ç”Ÿï¼Œç™¼å‹•å…¨æ ¡æ€§çš„ç­†è·¡æ¯”å°ï¼Œæ”¶ç¹³å­¸ç”Ÿé€±è¨˜ã€ä½œæ¥­ç­‰é€²è¡Œæ¯”å°ã€‚ç­†è·¡é‘‘å®šä¸¦ä¸å®¹æ˜“ï¼Œç¶“å…¨é¢æ¯”å°å¸«ç”Ÿç­†è·¡å¾Œï¼Œå…ˆå¾Œç¯©å‡º 56 ä»½å¯ç–‘ç­†è·¡ï¼Œå†ç¶“ç´°éƒ¨æ¯”å°ï¼Œå»ç„¡ä¸€èˆ‡å»æ‰€å¡—é´‰ç­†è·¡ç›¸ç¬¦ã€‚</p>
                <p>æƒ…æ²»æ©Ÿé—œåˆé‡å°èˆ‡ç¶½è™Ÿã€Œé»‘ç‹—ã€çš„æ•™å®˜æœ‰è¡çªçš„å­¸ç”Ÿé€²è¡Œèª¿æŸ¥ï¼Œæ‡·ç–‘æ˜¯ä¸æ»¿å­¸ç”Ÿæ‰€ç‚ºï¼Œä»ç„¡æ³•é–å®šå¡—é´‰å­¸ç”Ÿã€‚</p>
                <p>å¡—é´‰ç™¼ç¾æ–¼æ°‘åœ‹ 70 å¹´ï¼Œæ•´èµ·èª¿æŸ¥èˆ‡ç­†è·¡æ”¶ç¹³è€—è²»å¤§é‡äººåŠ›ç‰©åŠ›ï¼Œæ¡ˆä»¶ç›´è‡³æ°‘åœ‹ 74 å¹´æ‰ä»¥æ”¾æ£„åµè¾¦çµæ¡ˆï¼Œå‰å¾Œé•·é”å››å¹´ã€‚</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressZhugong" aria-label="é–±è®€é€²åº¦">
            <div class="scroll-progress-bar" id="scrollProgressBarZhugong"></div>
          </div>
          <button id="popupZhugongClose" class="popup-close" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <!-- Direction controls: æ”¾åœ¨ layout-main è£¡ï¼Œæ–¹ä¾¿ç›´å‘æ™‚ç›¸å°å…§å®¹ç½®ä¸­ï¼›icon ç”¨ SVG é¿å… iOS emoji å­—å‹ -->
      <div class="controls" id="controls">
        <div></div>
        <div class="btn" data-dir="up" aria-label="ä¸Š">
          <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true"><polygon points="12,6 18,18 6,18" fill="currentColor"/></svg>
        </div>
        <div></div>

        <div class="btn" data-dir="left" aria-label="å·¦">
          <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true"><polygon points="6,12 18,6 18,18" fill="currentColor"/></svg>
        </div>
        <div></div>
        <div class="btn" data-dir="right" aria-label="å³">
          <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true"><polygon points="6,6 6,18 18,12" fill="currentColor"/></svg>
        </div>

        <div></div>
        <div class="btn" data-dir="down" aria-label="ä¸‹">
          <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true"><polygon points="6,6 18,6 12,18" fill="currentColor"/></svg>
        </div>
        <div></div>
      </div>
    </div>
  </div>

  <!-- Experience start overlay -->
  <!-- ä¸€é–‹å§‹å…ˆéš±è—ï¼Œä¹‹å¾Œä¾æµç¨‹é¡¯ç¤º -->
  <div class="start-overlay hidden" id="startOverlay">
    <div class="start-card">
      <h1>å³¶å¶¼å€™è»Šå®¤ï¼é–‹å¾€æ°‘ä¸»çš„è½‰å‹æ­£ç¾©åˆ—è»Š</h1>
      <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹é«”é©—é€™æ®µé—œæ–¼è½‰å‹æ­£ç¾©ã€è¨˜æ†¶èˆ‡å‰è¡Œçš„è»Šç«™æ—…ç¨‹ã€‚</p>
      <button class="start-button" id="startButton">é–‹å§‹é«”é©—</button>
    </div>
  </div>

  <!-- DEBUG æŒ‰éˆ•èˆ‡åº§æ¨™é¢æ¿ -->
  <button type="button" class="debug-btn" id="debugBtn" aria-label="DEBUG åº§æ¨™">DEBUG</button>
  <div class="debug-panel hidden" id="debugPanel">
    <div id="debugPanelText"></div>
    <button type="button" class="debug-copy-btn" id="debugCopyBtn">è¤‡è£½åº§æ¨™</button>
  </div>

  <!-- Desktop help button and overlay -->
  <div class="help-button-desktop" id="helpButton">?</div>
  <div class="help-overlay hidden" id="helpOverlay">
    <div class="help-content">
      <h3>é—œæ–¼æœ¬å°ˆæ¡ˆ</h3>
      <p><strong>è½‰å‹æ­£ç¾© Gather Town ç·šä¸Šå±•è¦½ï¼Œä¿ƒè½‰åˆ—è»Šæ¶å…ˆè©¦ä¹˜</strong></p>
      <p>å¦‚æœè½‰å‹æ­£ç¾©ï¼Œæ˜¯ä¸€å°é€šå¾€æ°‘ä¸»æœªä¾†çš„åˆ—è»Šâ€¦â€¦</p>
      <p>ä¿ƒè½‰æœƒçš„æ ¸å¿ƒç†å¿µä¹‹ä¸€ï¼Œæ˜¯å°‡ã€Œè½‰å‹æ­£ç¾©ã€çš„æˆæœèˆ‡ç¤¾æœƒå…±äº«ã€‚é™¤äº†å°‡ä¸‰å¹´ä»¥ä¾†çš„åŠªåŠ›æ•´ç†æˆè©³ç´°å ±å‘Šã€Šä»»å‹™æ¨å‹•åŠèª¿æŸ¥æˆæœå ±å‘Šæ›¸ã€‹ä¹‹å¤–ï¼Œæ›´å¸Œæœ›é€éå¤šå…ƒé€”å¾‘ï¼Œè®“åœ‹äººæ¥è§¸ã€èªè­˜ã€é€²ä¸€æ­¥åƒèˆ‡è½‰å‹æ­£ç¾©ã€‚</p>
      <p>å› æ­¤ä¿ƒè½‰æœƒé€é GatherTownï¼Œä½ˆç½®ç·šä¸Šå±•è¦½ã€Šå³¶å¶¼å€™è»Šå®¤ï¼é–‹å¾€æ°‘ä¸»çš„è½‰å‹æ­£ç¾©åˆ—è»Šã€‹ï¼Œå°‡å ±å‘Šæ›¸çš„å…§å®¹æ¯”å–»æˆã€Œè™›æ“¬ç«è»Šç«™ã€ï¼Œæ­éœ²å£“è¿«é«”åˆ¶è¼ªå»“ã€é‡è¿°æ¬Šå¨ä¸‹å—å®³è€…æ•…äº‹ï¼Œä»¥åŠæç¹ªæœªä¾†è½‰å‹æ­£ç¾©å·¥ç¨‹é¡˜æ™¯ã€‚</p>
      <p>ğŸš‡ ç¾åœ¨åªè¦ç•™è¨€ã€Œè©¦ä¹˜ã€ä¸¦åˆ†äº«æ­¤å‰‡è²¼æ–‡<br>
         ğŸš‡ å°±æœ‰æ©Ÿæœƒæ¶å…ˆåƒèˆ‡é«”é©—ç·šä¸Šå±•è¦½<br>
         ğŸš‡ é‚„æœ‰æ©Ÿæœƒç²å¾—ç‰¹è£½ç²¾ç¾å£ç½©</p>
      <p>é€éä½ çš„ã€Œè¦‹è­‰ã€èˆ‡ã€ŒçºŒå¯«ã€ï¼Œè®“æˆ‘å€‘ä¸€èµ·æˆç‚ºå¾Œäººè¨˜æ†¶ä¸­çš„å‰è¡Œè€…ï¼</p>
      <div class="help-close" id="helpClose">é—œé–‰</div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const popup = document.getElementById('popup');
    const popupClose = document.getElementById('popupClose');
    const popupContent = document.querySelector('.popup-content');
    const bottomSheet = document.querySelector('.bottom-sheet');
    const popupHuang = document.getElementById('popupHuang');
    const popupHuangClose = document.getElementById('popupHuangClose');
    const bottomSheetHuang = popupHuang ? popupHuang.querySelector('.bottom-sheet') : null;
    const popupDu = document.getElementById('popupDu');
    const popupDuClose = document.getElementById('popupDuClose');
    const bottomSheetDu = popupDu ? popupDu.querySelector('.bottom-sheet') : null;
    const popupLiu = document.getElementById('popupLiu');
    const popupLiuClose = document.getElementById('popupLiuClose');
    const bottomSheetLiu = popupLiu ? popupLiu.querySelector('.bottom-sheet') : null;
    const popupYang = document.getElementById('popupYang');
    const popupYangClose = document.getElementById('popupYangClose');
    const bottomSheetYang = popupYang ? popupYang.querySelector('.bottom-sheet') : null;
    const popupWang = document.getElementById('popupWang');
    const popupWangClose = document.getElementById('popupWangClose');
    const bottomSheetWang = popupWang ? popupWang.querySelector('.bottom-sheet') : null;
    const popupZhugong = document.getElementById('popupZhugong');
    const popupZhugongClose = document.getElementById('popupZhugongClose');
    const bottomSheetZhugong = popupZhugong ? popupZhugong.querySelector('.bottom-sheet') : null;
    var gameState = { inputLocked: false };
    const helpButton = document.getElementById('helpButton');
    const helpOverlay = document.getElementById('helpOverlay');
    const helpClose = document.getElementById('helpClose');
    const startOverlay = document.getElementById('startOverlay');
    const startButton = document.getElementById('startButton');
    const debugBtn = document.getElementById('debugBtn');
    const debugPanel = document.getElementById('debugPanel');
    const debugPanelText = document.getElementById('debugPanelText');
    const debugCopyBtn = document.getElementById('debugCopyBtn');

    // Logical game size; will be updated to match background image dimensions
    // World size (map) and view size (visible screen window in world coordinates)
    let WORLD_WIDTH = 1024;
    let WORLD_HEIGHT = 576;
    let VIEW_WIDTH = 1024;
    let VIEW_HEIGHT = 576;

    // Canvas é¡¯ç¤ºå°ºå¯¸èˆ‡ scaleï¼ˆç”± resizeCanvas è¨­å®šï¼Œä¾› draw ç½®ä¸­ç”¨ï¼‰
    let canvasCssWidth = 0;
    let canvasCssHeight = 0;
    let dpr = 1;
    let currentScale = 1;
    const TILE_SIZE = 32; // grid size for tile-based movement
    const MOVE_SPEED = 240; // pixels per second (frame-independent for consistent speed)

    // å‚³é€é»åº§æ¨™ï¼ˆä¾ col/rowï¼‰ï¼šDEBUG æ™‚ä»¥ç¶ è‰²æ–¹å¡Šé¡¯ç¤º
    const TRANSMISSION_ZONES = {
      platform: [
        { col1: 27, col2: 28, row1: 12, row2: 13 },   // æœˆå° è»Šå»‚é—œ â†’ è»Šå»‚é–‹ (entrance / open door)
        { col1: 27, col2: 28, row1: 14, row2: 14 },   // æœˆå° è»Šå»‚é–‹ â†’ è»Šå»‚é—œ (col 27-28, row 14)
        { col1: 51, col2: 51, row1: 10, row2: 11 }    // æœˆå° è»Šå»‚é–‹ â†’ è»Šå»‚2
      ],
      platformClosedToCar2: [                          // æœˆå° è»Šå»‚é—œ å³å´å…©æ ¼ â†’ è»Šå»‚2
        { col1: 50, col2: 50, row1: 10, row2: 11 },
        { col1: 51, col2: 51, row1: 10, row2: 11 }
      ],
      car2ToPlatformOpen: [                            // è»Šå»‚2 â†’ è¿”å›è»Šå»‚ä¸€ï¼ˆæœˆå° è»Šå»‚é–‹ï¼‰col 22, row 10-11
        { col1: 22, col2: 22, row1: 10, row2: 11 }
      ],
      car2ToCar3: [                                    // è»Šå»‚2 â†’ è»Šå»‚3 col 51, row 10-11
        { col1: 51, col2: 51, row1: 10, row2: 11 }
      ],
      car3ToCar2: [                                    // è»Šå»‚3 â†’ å‚³é€å›è»Šå»‚2 col 22, row 10-11
        { col1: 22, col2: 22, row1: 10, row2: 11 }
      ]
    };
    const CAR2_SPAWN = { x: 757, y: 352 }; // é€šå¾€è»Šå»‚2 çš„å‚³é€å‡ºç”Ÿé»ï¼ˆcol 23, row 11ï¼‰
    const CAR3_SPAWN = { x: 757, y: 352 }; // é€šå¾€è»Šå»‚3 çš„å‚³é€å‡ºç”Ÿé»ï¼ˆcol 23, row 11ï¼‰
    const CAR2_SPAWN_FROM_CAR3 = { x: 1621, y: 352 }; // å¾è»Šå»‚3 å›åˆ°è»Šå»‚2 çš„å‡ºç”Ÿé» xï¼ˆcol 50ï¼‰ï¼Œy ä¿æŒç•¶å‰ row
    const PLATFORM_OPEN_SPAWN_FROM_CAR2 = { x: 1612.8, y: 352 }; // å¾è»Šå»‚2 å›åˆ°æœˆå°ï¼ˆè»Šå»‚é–‹ï¼‰çš„å‡ºç”Ÿé»ï¼ˆcol 50, row 11ï¼‰

    // ä¸‰å¼µåœ°åœ–ï¼šæœˆå°ï¼ˆè»Šå»‚é—œ/è»Šå»‚é–‹åŒä¸€å¼µåœ°åœ–åªæ›åœ–ï¼‰ã€è»Šå»‚2ã€è»Šå»‚3ï¼ˆåº•åœ– + å‰æ™¯ï¼Œè»Šå»‚3 åƒ…åº•åœ–ï¼‰
    const MAP_LIST = [
      { name: 'æœˆå°', base: 'maps/æœˆå°åº•åœ–_è»Šå»‚é—œ.png', foreground: 'maps/æœˆå°å‰æ™¯_è»Šå»‚é—œ.png', mask: 'maps/æœˆå°åº•åœ–_è»Šå»‚_mask.png' },
      { name: 'è»Šå»‚2', base: 'maps/è»Šå»‚2åº•åœ–.png', foreground: 'maps/è»Šå»‚2å‰æ™¯.png', mask: 'maps/è»Šå»‚2åº•åœ–_mask.png' },
      { name: 'è»Šå»‚3', base: 'maps/è»Šå»‚3åº•åœ–.png', foreground: null, mask: 'maps/è»Šå»‚2åº•åœ–_mask.png' }
    ];
    let currentMapIndex = 0;
    let platformCarriageOpen = false; // æœˆå°ï¼šè»Šå»‚é—œ(false) / è»Šå»‚é–‹(true)
    const mapImages = MAP_LIST.map(m => ({
      base: new Image(),
      foreground: m.foreground ? new Image() : null,
      mask: new Image(),
      width: 0,
      height: 0
    }));
    // æœˆå°ã€Œè»Šå»‚é–‹ã€ç”¨åœ–ï¼ˆåŒä¸€å¼µåœ°åœ–ï¼Œåªæ›åœ–ï¼‰
    mapImages[0].baseOpen = new Image();
    mapImages[0].baseOpen.src = 'maps/æœˆå°åº•åœ–_è»Šå»‚é–‹.png';
    mapImages[0].foregroundOpen = new Image();
    mapImages[0].foregroundOpen.src = 'maps/æœˆå°å‰æ™¯_è»Šå»‚é–‹.png';
    mapImages[0].maskOpen = new Image();
    mapImages[0].maskOpen.onload = () => {
      if (currentMapIndex === 0 && platformCarriageOpen && WORLD_WIDTH > 0 && WORLD_HEIGHT > 0) prepareCollisionMask();
    };
    mapImages[0].maskOpen.src = 'maps/æœˆå°åº•åœ–_è»Šå»‚_mask.png';

    const maskCanvas = document.createElement('canvas');
    const maskCtx = maskCanvas.getContext('2d');
    let blockedTiles = []; // blockedTiles[row][col] === true => cannot walk

    function applyWorldSizeFromMap(index) {
      const m = mapImages[index];
      if (m.width > 0 && m.height > 0) {
        WORLD_WIDTH = m.width;
        WORLD_HEIGHT = m.height;
      }
    }

    function onFirstMapReady() {
      applyWorldSizeFromMap(0);
      const baseViewWidth = Math.min(WORLD_WIDTH, 1920);
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        const portraitAspect = 360 / 640;
        VIEW_HEIGHT = WORLD_HEIGHT;
        VIEW_WIDTH = Math.min(WORLD_WIDTH, Math.round(VIEW_HEIGHT * portraitAspect));
        VIEW_WIDTH = Math.max(VIEW_WIDTH, 10 * TILE_SIZE);
      } else {
        const desktopAspect = 2.1;
        const zoomFactor = 0.92;
        VIEW_WIDTH = baseViewWidth * zoomFactor;
        VIEW_HEIGHT = VIEW_WIDTH / desktopAspect;
      }
      updateLogicalPositions();
      resizeCanvas();
      prepareCollisionMask();
    }

    MAP_LIST.forEach((cfg, i) => {
      const m = mapImages[i];
      m.base.onload = () => {
        m.width = m.base.naturalWidth;
        m.height = m.base.naturalHeight;
        if (i === 0) onFirstMapReady();
      };
      m.base.src = cfg.base;
      if (m.foreground) m.foreground.src = cfg.foreground;
      m.mask.src = cfg.mask;
    });

    // é®ç½©è¼‰å…¥å®Œæˆå¾Œï¼Œè‹¥ç•¶å‰åœ°åœ–å°ºå¯¸å·²çŸ¥å‰‡å»ºç«‹ç¢°æ’
    MAP_LIST.forEach((cfg, i) => {
      mapImages[i].mask.onload = () => {
        if (currentMapIndex === i && WORLD_WIDTH > 0 && WORLD_HEIGHT > 0) prepareCollisionMask();
      };
    });

    // å‘¨æ¸…æœˆè¨˜è€…è­‰ï¼šé é›¢æ™‚ å‘¨æ¸…æœˆç„¡äºº.pngï¼Œé è¿‘æ™‚ å‘¨æ¸…æœˆ.png
    const cardIdleImage = new Image();
    const cardActiveImage = new Image();
    cardIdleImage.src = 'è»Šå»‚1ç‰©ä»¶/å‘¨æ¸…æœˆç„¡äºº.png';
    cardActiveImage.src = 'è»Šå»‚1ç‰©ä»¶/å‘¨æ¸…æœˆ.png';

    // é»ƒå®¶æ¯å¥³ï¼šé é›¢æ™‚ é»ƒå®¶æ¯å¥³ç„¡äºº.pngï¼Œé è¿‘æ™‚ é»ƒå®¶æ¯å¥³.png
    const huangIdleImage = new Image();
    const huangActiveImage = new Image();
    huangIdleImage.src = 'è»Šå»‚1ç‰©ä»¶/é»ƒå®¶æ¯å¥³ç„¡äºº.png';
    huangActiveImage.src = 'è»Šå»‚1ç‰©ä»¶/é»ƒå®¶æ¯å¥³.png';

    // æœå­ç”Ÿï¼šé é›¢æ™‚ æœå­ç”Ÿç„¡äºº.pngï¼Œé è¿‘æ™‚ æœå­ç”Ÿ.png
    const duIdleImage = new Image();
    const duActiveImage = new Image();
    duIdleImage.src = 'è»Šå»‚1ç‰©ä»¶/æœå­ç”Ÿç„¡äºº.png';
    duActiveImage.src = 'è»Šå»‚1ç‰©ä»¶/æœå­ç”Ÿ.png';

    // åŠ‰æ°¸ç¥¥ï¼šé é›¢æ™‚ åŠ‰æ°¸ç¥¥ç„¡äºº.pngï¼Œé è¿‘æ™‚ åŠ‰æ°¸ç¥¥.png
    const liuIdleImage = new Image();
    const liuActiveImage = new Image();
    liuIdleImage.src = 'è»Šå»‚1ç‰©ä»¶/åŠ‰æ°¸ç¥¥ç„¡äºº.png';
    liuActiveImage.src = 'è»Šå»‚1ç‰©ä»¶/åŠ‰æ°¸ç¥¥.png';

    // é™½ç¿°çš„æƒ…å ±å ±å‘Šï¼šèªªæ˜åœ–ï¼ˆé é›¢ï¼‰é™½ç¿°ç„¡äºº.pngï¼Œé è¿‘åœ– é™½ç¿°.pngï¼Œè§¸ç™¼é» col 33 row 10
    const yangIdleImage = new Image();
    const yangActiveImage = new Image();
    yangIdleImage.src = 'è»Šå»‚1ç‰©ä»¶/é™½ç¿°ç„¡äºº.png';
    yangActiveImage.src = 'è»Šå»‚1ç‰©ä»¶/é™½ç¿°.png';

    // ç‹å†å‚³çš„é»¨å“¡æ‰‹å†Šï¼šèªªæ˜åœ– ç‹å†å‚³ç„¡äºº.pngï¼Œé è¿‘åœ– ç‹å†å‚³.pngï¼Œè§¸ç™¼é» col 43 row 10
    const wangIdleImage = new Image();
    const wangActiveImage = new Image();
    wangIdleImage.src = 'è»Šå»‚1ç‰©ä»¶/ç‹å†å‚³ç„¡äºº.png';
    wangActiveImage.src = 'è»Šå»‚1ç‰©ä»¶/ç‹å†å‚³.png';

    // ç«¹å·¥ï¼ˆæ–°ç«¹é«˜å·¥çš„å¡—é´‰ï¼‰ï¼šèªªæ˜åœ– ç«¹å·¥ç„¡äºº.pngï¼Œé è¿‘åœ– ç«¹å·¥.pngï¼Œè§¸ç™¼ç¯„åœ col 45-46 row 10-11
    const zhugongIdleImage = new Image();
    const zhugongActiveImage = new Image();
    zhugongIdleImage.src = 'è»Šå»‚1ç‰©ä»¶/ç«¹å·¥ç„¡äºº.png';
    zhugongActiveImage.src = 'è»Šå»‚1ç‰©ä»¶/ç«¹å·¥.png';

    // Player directional sprites (32x32). Put these PNGs in the same folder.
    const playerSprites = {
      up: new Image(),
      down: new Image(),
      left: new Image(),
      right: new Image()
    };
    playerSprites.up.src = 'characters/player_up.png';
    playerSprites.down.src = 'characters/player_down.png';
    playerSprites.left.src = 'characters/player_left.png';
    playerSprites.right.src = 'characters/player_right.png';

    // å‡ºç”Ÿé»ï¼šxã€y ç‚ºåœ°åœ–ã€Œæ¯”ä¾‹ã€0ï½1ï¼ˆ0.18=å·¦å´18%ï¼Œ0.88=ä¸‹æ–¹88%ï¼‰ï¼›å‹¿ç”¨ 5.40 æœƒå‡ºç•Œ
    const PLAYER_POS = { x: 0.40, y: 0.80 };
    const ZONE_POS = { x: 1228.8 / 1792, y: 320 / 1600, w: 40, h: 30 }; // å‘¨æ¸…æœˆï¼šæœˆå° è»Šå»‚é–‹ col 38, row 10 (1228.8, 320)

    // Player: 32x64ï¼ˆå¯¬ä¸€æ ¼ã€é«˜å…©æ ¼ï¼‰çš„äººç‰©.
    const player = {
      x: WORLD_WIDTH * PLAYER_POS.x,
      y: WORLD_HEIGHT * PLAYER_POS.y,
      width: TILE_SIZE,        // 32px
      height: TILE_SIZE * 2,   // 64px
      moving: false,
      targetX: 0,
      targetY: 0,
      remainingDist: 0,
      speed: MOVE_SPEED,
      dir: 'down' // current facing direction: 'up' | 'down' | 'left' | 'right'
    };

    // Single interaction point: where the character is standing on the screenshot.
    // You can fineâ€‘tune these numbers later.
    const interactionZone = {
      x: WORLD_WIDTH * ZONE_POS.x - ZONE_POS.w / 2,
      y: WORLD_HEIGHT * ZONE_POS.y - ZONE_POS.h / 2,
      width: ZONE_POS.w,
      height: ZONE_POS.h,
      info: 'This is the key interaction point on the platform.'
    };

    // è§¸ç™¼å€åƒ…æ¶µè“‹ row 10ï¼ˆy 320ï½352ï¼‰ï¼Œåœ¨ row 11 æ™‚å› è·é›¢/ç¯„åœä¸é‡ç–Šæ•…ä¸è§¸ç™¼
    // é»ƒå®¶æ¯å¥³äº’å‹•å€ï¼šæœˆå° è»Šå»‚é–‹ col 23, row 10
    const huangZone = { x: 732, y: 320, width: 40, height: 32 };
    // æœå­ç”Ÿäº’å‹•å€ï¼šæœˆå° è»Šå»‚é–‹ col 26, row 10
    const duZone = { x: 828, y: 320, width: 40, height: 32 };
    // åŠ‰æ°¸ç¥¥äº’å‹•å€ï¼šæœˆå° è»Šå»‚é–‹ col 29, row 10
    const liuZone = { x: 924, y: 320, width: 40, height: 32 };
    // é™½ç¿°çš„æƒ…å ±å ±å‘Šè§¸ç™¼é»ï¼šæœˆå° è»Šå»‚é–‹ col 33, row 10
    const yangZone = { x: 1052, y: 320, width: 40, height: 32 };
    // ç‹å†å‚³çš„é»¨å“¡æ‰‹å†Šè§¸ç™¼é»ï¼šæœˆå° è»Šå»‚é–‹ col 43, row 10
    const wangZone = { x: 1372, y: 320, width: 40, height: 32 };
    // ç«¹å·¥ï¼ˆæ–°ç«¹é«˜å·¥çš„å¡—é´‰ï¼‰è§¸ç™¼ç¯„åœï¼šæœˆå° è»Šå»‚é–‹ col 45-46, row 10-11ï¼ˆ2x2 æ ¼ï¼‰
    const zhugongZone = { x: 1440, y: 320, width: 64, height: 64 };

    const keys = { up: false, down: false, left: false, right: false };
    let wasInZone = false;
    let isInZoneNow = false;
    let isNearZoneNow = false;
    let isNearHuangNow = false;
    let wasInHuangZone = false;
    let isNearDuNow = false;
    let wasInDuZone = false;
    let isNearLiuNow = false;
    let wasInLiuZone = false;
    let isNearYangNow = false;
    let wasInYangZone = false;
    let isNearWangNow = false;
    let wasInWangZone = false;
    let isNearZhugongNow = false;
    let wasInZhugongZone = false;

    // Camera: å·¦ä¸Šè§’ä¸–ç•Œåº§æ¨™ï¼›viewW/viewH ç‚ºå¯¦éš›å¯è¦–ç¯„åœï¼ˆcover æ™‚ = screen/scaleï¼‰
    const camera = { x: 0, y: 0, viewW: VIEW_WIDTH, viewH: VIEW_HEIGHT };

    // --- ç¬¬ä¸€æ­¥ï¼šæ­£ç¢º resize canvasï¼ˆå« devicePixelRatioï¼Œä¸æ‹‰ä¼¸ï¼‰---
    function getGameCanvasContainerSize() {
      var w = window.innerWidth;
      var wrap = document.getElementById('game-canvas-wrap');
      var h = (wrap && wrap.clientHeight > 0) ? wrap.clientHeight : window.innerHeight;
      return { width: w, height: h };
    }

    function resizeCanvas() {
      dpr = window.devicePixelRatio || 1;
      var size = getGameCanvasContainerSize();
      var screenW = Math.max(1, size.width);
      var screenH = Math.max(1, size.height);

      var DESIGN_W = VIEW_WIDTH;
      var DESIGN_H = VIEW_HEIGHT;
      var scale = Math.max(screenW / DESIGN_W, screenH / DESIGN_H);
      // é›»è…¦ç‰ˆï¼šä¾è¢å¹•å°ºå¯¸é™åˆ¶æœ€å¤§ç¸®æ”¾ï¼Œé¿å…éåº¦ zoom in
      if (screenW > 768) {
        var maxScale = 1.4 + 800 / Math.max(screenW, 800); // å¤§è¢å¹•ç´„ 1.4~1.9
        scale = Math.min(scale, maxScale);
      }

      camera.viewW = screenW / scale;
      camera.viewH = screenH / scale;
      camera.viewW = Math.max(1, camera.viewW);
      camera.viewH = Math.max(1, camera.viewH);
      currentScale = scale;

      canvas.style.width = screenW + 'px';
      canvas.style.height = screenH + 'px';

      canvas.width = Math.floor(screenW * dpr);
      canvas.height = Math.floor(screenH * dpr);

      ctx.setTransform(dpr * scale, 0, 0, dpr * scale, 0, 0);

      canvasCssWidth = camera.viewW;
      canvasCssHeight = camera.viewH;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const gameCanvasWrap = document.getElementById('game-canvas-wrap');
    if (gameCanvasWrap && typeof ResizeObserver !== 'undefined') {
      new ResizeObserver(resizeCanvas).observe(gameCanvasWrap);
    }

    function updateLogicalPositions() {
      // å¯é€šè¡Œå¸¶ï¼ˆæœˆå°åœ°æ¿ç¯„åœï¼‰
      const walkTop = WORLD_HEIGHT * 0.63;
      const walkBottom = WORLD_HEIGHT * 0.86;

      // å‡ºç”Ÿé»ï¼ˆç”± PLAYER_POS æ§åˆ¶ï¼‰
      player.x = WORLD_WIDTH * PLAYER_POS.x;
      player.y = WORLD_HEIGHT * PLAYER_POS.y;

      // Interaction zone stays roughly in the middle of the platform.
      interactionZone.x = WORLD_WIDTH * ZONE_POS.x - ZONE_POS.w / 2;
      interactionZone.y = 10 * TILE_SIZE;
      interactionZone.height = TILE_SIZE;

      // Cache walk band for collision checks.
      player.walkTop = walkTop;
      player.walkBottom = walkBottom;
    }

    updateLogicalPositions();

    // åˆ©ç”¨ç•¶å‰åœ°åœ–çš„é®ç½©å»ºç«‹ blockedTilesï¼›ç„¡é®ç½©æˆ–æœªè¼‰å…¥å‰‡å…¨éƒ¨å¯é€šè¡Œ
    // MASK åªé©ç”¨æ–¼è©²åœ°åœ–ï¼šåˆ‡æ›åœ°åœ–å¾Œå¿…é ˆå‘¼å«æœ¬å‡½å¼ï¼Œä»¥è©²åœ°åœ–çš„ mask é‡æ–°å»ºç«‹ç¦æ­¢é€šè¡Œå€åŸŸ
    // æœˆå°è»Šå»‚é—œï¼è»Šå»‚é–‹éƒ½è®€å– MASKï¼ˆæœˆå°åº•åœ–_è»Šå»‚_mask.pngï¼‰
    function prepareCollisionMask() {
      const cur = mapImages[currentMapIndex];
      const usePlatformOpenMask = currentMapIndex === 0 && platformCarriageOpen && cur.maskOpen && cur.maskOpen.complete && cur.maskOpen.naturalWidth > 0;
      const maskImg = usePlatformOpenMask ? cur.maskOpen : cur.mask;
      if (!maskImg.complete || maskImg.naturalWidth === 0) {
        blockedTiles = [];
        return;
      }
      maskCanvas.width = WORLD_WIDTH;
      maskCanvas.height = WORLD_HEIGHT;
      maskCtx.clearRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      maskCtx.drawImage(maskImg, 0, 0, WORLD_WIDTH, WORLD_HEIGHT);

      const cols = Math.ceil(WORLD_WIDTH / TILE_SIZE);
      const rows = Math.ceil(WORLD_HEIGHT / TILE_SIZE);
      blockedTiles = new Array(rows);

      const imgData = maskCtx.getImageData(0, 0, WORLD_WIDTH, WORLD_HEIGHT).data;

      // åªç®—ã€Œç´”é»‘ã€ä¸ç®—ç°ï¼›åªå–æ¯æ ¼ã€Œä¸­å¿ƒä¸€é»ã€ï¼Œé¿å…ç¯„åœéå¤§æŠŠéé»‘å€ä¹Ÿç®—é€²å»
      const BLACK = 18;
      for (let row = 0; row < rows; row++) {
        blockedTiles[row] = new Array(cols).fill(false);
        for (let col = 0; col < cols; col++) {
          const sampleX = Math.min(WORLD_WIDTH - 1, col * TILE_SIZE + Math.floor(TILE_SIZE / 2));
          const sampleY = Math.min(WORLD_HEIGHT - 1, row * TILE_SIZE + Math.floor(TILE_SIZE / 2));
          const idx = (sampleY * WORLD_WIDTH + sampleX) * 4;
          const r = imgData[idx], g = imgData[idx + 1], b = imgData[idx + 2], a = imgData[idx + 3];
          if (a > 0 && r < BLACK && g < BLACK && b < BLACK) blockedTiles[row][col] = true;
        }
      }
      // å¼·åˆ¶æŒ‡å®šåº§æ¨™æ‰€åœ¨æ ¼ç‚ºå¯é€šè¡Œï¼ˆDEBUG ç”¨ï¼‰
      const forceWalkX = 716, forceWalkY = 1184;
      const fc = Math.floor(forceWalkX / TILE_SIZE), fr = Math.floor(forceWalkY / TILE_SIZE);
      if (fr >= 0 && fr < blockedTiles.length && fc >= 0 && fc < blockedTiles[0].length) {
        blockedTiles[fr][fc] = false;
      }
      // æœˆå°ï¼šè¿”å›åœ°åœ–ä¸€æ™‚çš„å‡ºç”Ÿé»å¼·åˆ¶å¯é€šè¡Œï¼Œé¿å…å¡ä½
      if (currentMapIndex === 0) {
        const platformSpawnX = WORLD_WIDTH - 85;
        const platformSpawnY = WORLD_HEIGHT * 0.5;
        for (let or = -1; or <= 1; or++) {
          for (let oc = -1; oc <= 1; oc++) {
            const c = Math.floor(platformSpawnX / TILE_SIZE) + oc;
            const r = Math.floor(platformSpawnY / TILE_SIZE) + or;
            if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
              blockedTiles[r][c] = false;
            }
          }
        }
        if (platformCarriageOpen) {
          // æœˆå°è»Šå»‚é–‹ï¼šcol 21-23, row 10-12 å¼·åˆ¶ä¸å¯è¡Œèµ°
          for (let c = 21; c <= 23; c++) {
            for (let r = 10; r <= 12; r++) {
              if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
                blockedTiles[r][c] = true;
              }
            }
          }
          // æœˆå°è»Šå»‚é–‹ï¼šcol 22-23, row 10-11 é–‹æ”¾è¡Œèµ°
          for (let c = 22; c <= 23; c++) {
            for (let r = 10; r <= 11; r++) {
              if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
                blockedTiles[r][c] = false;
              }
            }
          }
        } else {
          // æœˆå°è»Šå»‚é—œï¼šcol 21-23, row 10-12 å¼·åˆ¶å¯é€šè¡Œ
          for (let c = 21; c <= 23; c++) {
            for (let r = 10; r <= 12; r++) {
              if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
                blockedTiles[r][c] = false;
              }
            }
          }
        }
      }
    }

    // --- Tile-based movement helpers ---
    function tryMove(dxTiles, dyTiles) {
      const dx = dxTiles * TILE_SIZE;
      const dy = dyTiles * TILE_SIZE;
      if (dx === 0 && dy === 0) return;
      if (player.moving) return; // wait until current step finishes

      let newX = player.x + dx;
      let newY = player.y + dy;

      const halfW = player.width / 2;
      const halfH = player.height / 2;

      // Clamp to world bounds
      newX = Math.max(halfW, Math.min(WORLD_WIDTH - halfW, newX));
      newY = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, newY));

      // ä¾ç…§é®ç½©åˆ¤æ–·ç›®æ¨™æ ¼æ˜¯å¦è¢«å°é–
      if (blockedTiles.length > 0) {
        const col = Math.floor(newX / TILE_SIZE);
        const row = Math.floor(newY / TILE_SIZE);
        if (
          row >= 0 &&
          row < blockedTiles.length &&
          col >= 0 &&
          col < blockedTiles[0].length &&
          blockedTiles[row][col]
        ) {
          // ç›®æ¨™æ˜¯é»‘è‰²å€å¡Šï¼Œå–æ¶ˆé€™ä¸€æ­¥
          return;
        }
      }

      const dist = Math.hypot(newX - player.x, newY - player.y);
      if (dist === 0) return;

      // Set up smooth movement towards the target tile
      player.targetX = newX;
      player.targetY = newY;
      player.remainingDist = dist;
      player.moving = true;
    }

    function moveFromDirection(dir) {
      switch (dir) {
        case 'up':
          player.dir = 'up';
          tryMove(0, -1); break;
        case 'down':
          player.dir = 'down';
          tryMove(0, 1); break;
        case 'left':
          player.dir = 'left';
          tryMove(-1, 0); break;
        case 'right':
          player.dir = 'right';
          tryMove(1, 0); break;
      }
    }

    // Keyboard input: keep direction pressed while key held down
    window.addEventListener('keydown', (e) => {
      switch (e.key) {
        case 'ArrowUp':
        case 'w':
        case 'W':
          keys.up = true; break;
        case 'ArrowDown':
        case 's':
        case 'S':
          keys.down = true; break;
        case 'ArrowLeft':
        case 'a':
        case 'A':
          keys.left = true; break;
        case 'ArrowRight':
        case 'd':
        case 'D':
          keys.right = true; break;
      }
    });

    window.addEventListener('keyup', (e) => {
      switch (e.key) {
        case 'ArrowUp':
        case 'w':
        case 'W':
          keys.up = false; break;
        case 'ArrowDown':
        case 's':
        case 'S':
          keys.down = false; break;
        case 'ArrowLeft':
        case 'a':
        case 'A':
          keys.left = false; break;
        case 'ArrowRight':
        case 'd':
        case 'D':
          keys.right = false; break;
      }
    });

    const controls = document.getElementById('controls');

    // Touch / mouse buttons: hold to keep moving in that directionï¼ˆå”¯ä¸€ä¸€çµ„æ–¹å‘éµï¼šHTML .controlsï¼‰
    if (controls) {
      controls.querySelectorAll('.btn').forEach(btn => {
        const dir = btn.dataset.dir;

        const start = (e) => {
          e.preventDefault();
          btn.classList.add('active');
          keys[dir] = true;
        };

        const end = (e) => {
          e.preventDefault();
          btn.classList.remove('active');
          keys[dir] = false;
        };

        btn.addEventListener('touchstart', start, { passive: false });
        btn.addEventListener('touchend', end, { passive: false });
        btn.addEventListener('touchcancel', end, { passive: false });

        btn.addEventListener('mousedown', start);
        window.addEventListener('mouseup', end);
      });
    }

    function update(dt) {
      player.dt = dt;
      // If not currently moving to a tile, check held directions and start a new step.
      if (!gameState.inputLocked && !player.moving) {
        let dir = null;
        if (keys.up) dir = 'up';
        else if (keys.down) dir = 'down';
        else if (keys.left) dir = 'left';
        else if (keys.right) dir = 'right';

        if (dir) {
          moveFromDirection(dir);
        }
      }

      // Smoothly move player towards target tile if currently moving (delta-time based)
      if (player.moving) {
        const dx = player.targetX - player.x;
        const dy = player.targetY - player.y;
        const dist = Math.hypot(dx, dy);
        const step = player.speed * (player.dt ?? 1/60); // pixels this frame

        if (dist <= step || dist === 0) {
          // Snap to tile and finish movement
          player.x = player.targetX;
          player.y = player.targetY;
          player.moving = false;
          player.remainingDist = 0;
        } else {
          const stepX = (dx / dist) * step;
          const stepY = (dy / dist) * step;
          player.x += stepX;
          player.y += stepY;
          player.remainingDist = dist - step;
        }
      }

      const halfW = player.width / 2;
      const halfH = player.height / 2;

      // åˆ‡æ›åœ°åœ–æ™‚æ¸…é™¤ç§»å‹•ç‹€æ…‹ï¼Œé¿å…é‚„å¾€èˆŠåœ°åœ–åº§æ¨™ç§»å‹•
      function onMapSwitch() {
        player.moving = false;
        player.targetX = player.x;
        player.targetY = player.y;
        player.remainingDist = 0;
      }

      // å‚³é€é»ä¾ col/row åˆ¤æ–·ï¼ˆèˆ‡ TRANSMISSION_ZONES ä¸€è‡´ï¼‰
      const playerCol = Math.floor(player.x / TILE_SIZE);
      const playerRow = Math.floor(player.y / TILE_SIZE);
      const platformZones = TRANSMISSION_ZONES.platform;
      const closedToCar2Zones = TRANSMISSION_ZONES.platformClosedToCar2 || [];
      const inZoneOpen = platformZones[0] && playerCol >= platformZones[0].col1 && playerCol <= platformZones[0].col2 && playerRow >= platformZones[0].row1 && playerRow <= platformZones[0].row2;
      const inZoneToClosed = platformZones[1] && playerCol >= platformZones[1].col1 && playerCol <= platformZones[1].col2 && playerRow >= platformZones[1].row1 && playerRow <= platformZones[1].row2;
      const inZoneCar2 = platformZones[2] && playerCol >= platformZones[2].col1 && playerCol <= platformZones[2].col2 && playerRow >= platformZones[2].row1 && playerRow <= platformZones[2].row2;
      const inZoneClosedToCar2 = closedToCar2Zones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      const car2ToPlatformOpenZones = TRANSMISSION_ZONES.car2ToPlatformOpen || [];
      const inZoneCar2ToPlatformOpen = car2ToPlatformOpenZones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      const car2ToCar3Zones = TRANSMISSION_ZONES.car2ToCar3 || [];
      const inZoneCar2ToCar3 = car2ToCar3Zones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      const car3ToCar2Zones = TRANSMISSION_ZONES.car3ToCar2 || [];
      const inZoneCar3ToCar2 = car3ToCar2Zones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      if (currentMapIndex === 0 && !platformCarriageOpen && inZoneOpen) {
        platformCarriageOpen = true;
        prepareCollisionMask(); // åˆ‡æ›ç‚ºè»Šå»‚é–‹å¾Œï¼Œæ”¹ç”¨è»Šå»‚é–‹ MASK
      } else if (currentMapIndex === 0 && platformCarriageOpen && inZoneToClosed) {
        platformCarriageOpen = false;
        prepareCollisionMask(); // åˆ‡å›è»Šå»‚é—œå¾Œï¼Œæ”¹ç”¨è»Šå»‚é—œ MASK
      } else if (currentMapIndex === 0 && !platformCarriageOpen && inZoneClosedToCar2 && mapImages[1].width > 0 && mapImages[1].height > 0) {
        currentMapIndex = 1;
        applyWorldSizeFromMap(1);
        player.x = CAR2_SPAWN.x;
        player.y = CAR2_SPAWN.y;
        onMapSwitch();
        prepareCollisionMask(); // åˆ‡æ›åˆ°è»Šå»‚2å¾Œï¼Œç”¨è©²åœ°åœ–çš„ MASK æ›´æ–°ç¦æ­¢é€šè¡Œå€åŸŸ
      } else if (currentMapIndex === 0 && platformCarriageOpen && inZoneCar2 && mapImages[1].width > 0 && mapImages[1].height > 0) {
        currentMapIndex = 1;
        applyWorldSizeFromMap(1);
        player.x = CAR2_SPAWN.x;
        player.y = CAR2_SPAWN.y;
        onMapSwitch();
        prepareCollisionMask(); // åˆ‡æ›åˆ°è»Šå»‚2å¾Œï¼Œç”¨è©²åœ°åœ–çš„ MASK æ›´æ–°ç¦æ­¢é€šè¡Œå€åŸŸ
      } else if (currentMapIndex === 1 && inZoneCar2ToPlatformOpen && mapImages[0].width > 0 && mapImages[0].height > 0) {
        currentMapIndex = 0;
        platformCarriageOpen = true; // è»Šå»‚ä¸€ = æœˆå° è»Šå»‚é–‹
        applyWorldSizeFromMap(0);
        player.x = PLATFORM_OPEN_SPAWN_FROM_CAR2.x;
        player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, player.y)); // ä¿æŒç•¶å‰ row å°æ‡‰çš„ yï¼ˆå¦‚ row 10â†’320, row 11â†’352ï¼‰
        onMapSwitch();
        prepareCollisionMask(); // åˆ‡æ›åˆ°æœˆå°å¾Œï¼Œç”¨è©²åœ°åœ–çš„ MASK æ›´æ–°ç¦æ­¢é€šè¡Œå€åŸŸ
      } else if (currentMapIndex === 1 && inZoneCar2ToCar3 && mapImages[2].width > 0 && mapImages[2].height > 0) {
        currentMapIndex = 2;
        applyWorldSizeFromMap(2);
        player.x = CAR3_SPAWN.x;
        player.y = CAR3_SPAWN.y;
        onMapSwitch();
        prepareCollisionMask(); // åˆ‡æ›åˆ°è»Šå»‚3å¾Œï¼Œç”¨è©²åœ°åœ–çš„ MASK æ›´æ–°ç¦æ­¢é€šè¡Œå€åŸŸ
      } else if (currentMapIndex === 2 && inZoneCar3ToCar2 && mapImages[1].width > 0 && mapImages[1].height > 0) {
        currentMapIndex = 1;
        applyWorldSizeFromMap(1);
        player.x = CAR2_SPAWN_FROM_CAR3.x;
        player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, player.y)); // ä¿æŒç•¶å‰ rowï¼ˆrow 10â†’320, row 11â†’352ï¼‰
        onMapSwitch();
        prepareCollisionMask(); // åˆ‡æ›åˆ°è»Šå»‚2å¾Œï¼Œç”¨è©²åœ°åœ–çš„ MASK æ›´æ–°ç¦æ­¢é€šè¡Œå€åŸŸ
      }

      const edgeW = 70;
      const spawnInset = 85; // åˆ‡æ›åœ°åœ–å¾Œå‡ºç”Ÿé»è¦æ¯” edgeW å¤§ï¼Œæ‰ä¸æœƒç«‹åˆ»è§¸ç™¼ã€Œå·¦é‚Šç·£å›ä¸Šä¸€å¼µã€
      if (player.x >= WORLD_WIDTH - edgeW && currentMapIndex < MAP_LIST.length - 1) {
        const next = mapImages[currentMapIndex + 1];
        if (next.width > 0 && next.height > 0) {
          currentMapIndex++;
          applyWorldSizeFromMap(currentMapIndex);
          player.x = spawnInset;
          player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, WORLD_HEIGHT * 0.5));
          onMapSwitch();
          prepareCollisionMask(); // åˆ‡æ›åœ°åœ–å¾Œï¼Œç”¨è©²åœ°åœ–çš„ MASK æ›´æ–°ç¦æ­¢é€šè¡Œå€åŸŸ
        }
      } else if (player.x <= edgeW && currentMapIndex > 0) {
        const prev = mapImages[currentMapIndex - 1];
        if (prev.width > 0 && prev.height > 0) {
          currentMapIndex--;
          if (currentMapIndex === 0) platformCarriageOpen = false; // å›æœˆå°æ™‚æ”¹å›è»Šå»‚é—œ
          applyWorldSizeFromMap(currentMapIndex);
          player.x = WORLD_WIDTH - spawnInset;
          player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, WORLD_HEIGHT * 0.5));
          onMapSwitch();
          prepareCollisionMask(); // åˆ‡æ›åœ°åœ–å¾Œï¼Œç”¨è©²åœ°åœ–çš„ MASK æ›´æ–°ç¦æ­¢é€šè¡Œå€åŸŸ
        }
      }

      player.x = Math.max(halfW, Math.min(WORLD_WIDTH - halfW, player.x));
      player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, player.y));

      var viewW = camera.viewW;
      var viewH = camera.viewH;
      camera.x = player.x + player.width / 2 - viewW / 2;
      camera.y = player.y + player.height / 2 - viewH / 2;
      var maxCamX = Math.max(0, WORLD_WIDTH - viewW);
      var maxCamY = Math.max(0, WORLD_HEIGHT - viewH);
      camera.x = Math.max(0, Math.min(camera.x, maxCamX));
      camera.y = Math.max(0, Math.min(camera.y, maxCamY));
      if (DEBUG_CAMERA && viewH > WORLD_HEIGHT) {
        console.warn('[camera] viewH > mapH', { mapH: WORLD_HEIGHT, viewH: viewH, cameraY: camera.y });
      }

      const objCenterX = interactionZone.x + interactionZone.width / 2;
      const objCenterY = 10 * TILE_SIZE; // èˆ‡åœ–ç¤ºåŒé«˜ï¼ˆ320ï¼‰ï¼Œå’Œå…¶ä»–ç‰©ä»¶ä¸€è‡´
      const dxCenter = player.x - objCenterX;
      const dyCenter = player.y - objCenterY;
      const distToCenter = Math.hypot(dxCenter, dyCenter);

      // é»ƒå®¶æ¯å¥³åœ–ç¤ºä½ç½®ï¼šæœˆå° è»Šå»‚é–‹ col 23, row 10 å¾€ä¸ŠåŠæ ¼
      const huangCenterX = 23 * TILE_SIZE + TILE_SIZE / 2;
      const huangCenterY = 10 * TILE_SIZE; // 320ï¼Œå‰›å¥½æ¯”æ ¼å­ä¸­å¿ƒå¾€ä¸ŠåŠæ ¼
      const dxHuang = player.x - huangCenterX;
      const dyHuang = player.y - huangCenterY;
      const distToHuang = Math.hypot(dxHuang, dyHuang);
      // æœå­ç”Ÿåœ–ç¤ºä½ç½®ï¼šæœˆå° è»Šå»‚é–‹ col 26, row 10
      const duCenterX = 26 * TILE_SIZE + TILE_SIZE / 2;
      const duCenterY = 10 * TILE_SIZE;
      const dxDu = player.x - duCenterX;
      const dyDu = player.y - duCenterY;
      const distToDu = Math.hypot(dxDu, dyDu);
      // åŠ‰æ°¸ç¥¥åœ–ç¤ºä½ç½®ï¼šæœˆå° è»Šå»‚é–‹ col 29, row 10
      const liuCenterX = 29 * TILE_SIZE + TILE_SIZE / 2;
      const liuCenterY = 10 * TILE_SIZE;
      const dxLiu = player.x - liuCenterX;
      const dyLiu = player.y - liuCenterY;
      const distToLiu = Math.hypot(dxLiu, dyLiu);
      // é™½ç¿°çš„æƒ…å ±å ±å‘Šåœ–ç¤ºä½ç½®ï¼šæœˆå° è»Šå»‚é–‹ col 33, row 10
      const yangCenterX = 33 * TILE_SIZE + TILE_SIZE / 2;
      const yangCenterY = 10 * TILE_SIZE;
      const dxYang = player.x - yangCenterX;
      const dyYang = player.y - yangCenterY;
      const distToYang = Math.hypot(dxYang, dyYang);
      // ç‹å†å‚³çš„é»¨å“¡æ‰‹å†Šåœ–ç¤ºä½ç½®ï¼šæœˆå° è»Šå»‚é–‹ col 43, row 10
      const wangCenterX = 43 * TILE_SIZE + TILE_SIZE / 2;
      const wangCenterY = 10 * TILE_SIZE;
      const dxWang = player.x - wangCenterX;
      const dyWang = player.y - wangCenterY;
      const distToWang = Math.hypot(dxWang, dyWang);
      // ç«¹å·¥ï¼ˆæ–°ç«¹é«˜å·¥çš„å¡—é´‰ï¼‰åœ–ç¤ºä½ç½®ï¼šcol 45-46 row 10-11 ä¸­å¿ƒ (1472, 352)
      const zhugongCenterX = 45 * TILE_SIZE + TILE_SIZE;  // 1472
      const zhugongCenterY = 10 * TILE_SIZE + TILE_SIZE;   // 352
      const dxZhugong = player.x - zhugongCenterX;
      const dyZhugong = player.y - zhugongCenterY;
      const distToZhugong = Math.hypot(dxZhugong, dyZhugong);

      // å‘¨æ¸…æœˆè¨˜è€…è­‰äº’å‹•åƒ…åœ¨æœˆå° è»Šå»‚é–‹ï¼ˆåœ°åœ– 0 ä¸” platformCarriageOpenï¼‰
      const onPlatformOpen = currentMapIndex === 0 && platformCarriageOpen;
      // é è¦½ï¼ˆå…‰æšˆ+é è¿‘åœ–ï¼‰ï¼šè·é›¢æ”¾å¤§ï¼Œè¼ƒé å³å¯çœ‹åˆ°
      const NEAR_PREVIEW_DIST = 96;
      // å…­å€‹ç‰©ä»¶ï¼šç”¨ã€Œç©å®¶ä¸­å¿ƒé»åœ¨å€å…§ã€åˆ¤å®šï¼›è§¸ç™¼å€ y åªå« row 10ï¼Œæ•… row 11 è‡ªç„¶ä¸æœƒè§¸ç™¼ï¼ˆæ¸¬é‡è·é›¢é”æˆï¼‰
      isNearZoneNow = onPlatformOpen && distToCenter < NEAR_PREVIEW_DIST;
      const inZone = onPlatformOpen && isPlayerCenterInZone(player, interactionZone);
      isNearHuangNow = onPlatformOpen && distToHuang < NEAR_PREVIEW_DIST;
      const inHuangZone = onPlatformOpen && isPlayerCenterInZone(player, huangZone);
      isNearDuNow = onPlatformOpen && distToDu < NEAR_PREVIEW_DIST;
      const inDuZone = onPlatformOpen && isPlayerCenterInZone(player, duZone);
      isNearLiuNow = onPlatformOpen && distToLiu < NEAR_PREVIEW_DIST;
      const inLiuZone = onPlatformOpen && isPlayerCenterInZone(player, liuZone);
      isNearYangNow = onPlatformOpen && distToYang < NEAR_PREVIEW_DIST;
      const inYangZone = onPlatformOpen && isPlayerCenterInZone(player, yangZone);
      isNearWangNow = onPlatformOpen && distToWang < NEAR_PREVIEW_DIST;
      const inWangZone = onPlatformOpen && isPlayerCenterInZone(player, wangZone);
      // ç«¹å·¥ï¼ˆæ–°ç«¹é«˜å·¥çš„å¡—é´‰ï¼‰ï¼šç”¨ bbox é‡ç–Šï¼Œrow 10 æˆ– 11 çš†å¯è§¸ç™¼ï¼Œé è¦½è·é›¢åŒ
      isNearZhugongNow = onPlatformOpen && distToZhugong < NEAR_PREVIEW_DIST;
      const inZhugongZone = onPlatformOpen && isPlayerInZone(player, zhugongZone);
      isInZoneNow = inZone;
      if (inZone && !wasInZone) {
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetScrollZhou) bottomSheetScrollZhou.scrollTop = 0;
        popup.classList.remove('hidden');
        gameState.inputLocked = true;
        requestAnimationFrame(function () {
          if (bottomSheet) bottomSheet.classList.add('open');
          if (scrollProgressBarZhou) scrollProgressBarZhou.style.top = '0%';
        });
      } else if (!inZone && wasInZone) {
        if (bottomSheet) bottomSheet.classList.remove('open');
        gameState.inputLocked = false;
        setTimeout(function () { popup.classList.add('hidden'); }, 300);
      }
      if (inHuangZone && !wasInHuangZone) {
        popup.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetScrollHuang) bottomSheetScrollHuang.scrollTop = 0;
        if (popupHuang) popupHuang.classList.remove('hidden');
        gameState.inputLocked = true;
        requestAnimationFrame(function () {
          if (bottomSheetHuang) bottomSheetHuang.classList.add('open');
          if (scrollProgressBarHuang) scrollProgressBarHuang.style.top = '0%';
        });
      } else if (!inHuangZone && wasInHuangZone) {
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        gameState.inputLocked = false;
        setTimeout(function () { if (popupHuang) popupHuang.classList.add('hidden'); }, 300);
      }
      if (inDuZone && !wasInDuZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetScrollDu) bottomSheetScrollDu.scrollTop = 0;
        if (popupDu) popupDu.classList.remove('hidden');
        gameState.inputLocked = true;
        requestAnimationFrame(function () {
          if (bottomSheetDu) bottomSheetDu.classList.add('open');
          if (scrollProgressBarDu) scrollProgressBarDu.style.top = '0%';
        });
      } else if (!inDuZone && wasInDuZone) {
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        gameState.inputLocked = false;
        setTimeout(function () { if (popupDu) popupDu.classList.add('hidden'); }, 300);
      }
      if (inLiuZone && !wasInLiuZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetScrollLiu) bottomSheetScrollLiu.scrollTop = 0;
        if (popupLiu) popupLiu.classList.remove('hidden');
        gameState.inputLocked = true;
        requestAnimationFrame(function () {
          if (bottomSheetLiu) bottomSheetLiu.classList.add('open');
          if (scrollProgressBarLiu) scrollProgressBarLiu.style.top = '0%';
        });
      } else if (!inLiuZone && wasInLiuZone) {
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        gameState.inputLocked = false;
        setTimeout(function () { if (popupLiu) popupLiu.classList.add('hidden'); }, 300);
      }
      if (inYangZone && !wasInYangZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetScrollYang) bottomSheetScrollYang.scrollTop = 0;
        if (popupYang) popupYang.classList.remove('hidden');
        gameState.inputLocked = true;
        requestAnimationFrame(function () {
          if (bottomSheetYang) bottomSheetYang.classList.add('open');
          if (scrollProgressBarYang) scrollProgressBarYang.style.top = '0%';
        });
      } else if (!inYangZone && wasInYangZone) {
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        gameState.inputLocked = false;
        setTimeout(function () { if (popupYang) popupYang.classList.add('hidden'); }, 300);
      }
      if (inWangZone && !wasInWangZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetScrollWang) bottomSheetScrollWang.scrollTop = 0;
        if (popupWang) popupWang.classList.remove('hidden');
        gameState.inputLocked = true;
        requestAnimationFrame(function () {
          if (bottomSheetWang) bottomSheetWang.classList.add('open');
          if (scrollProgressBarWang) scrollProgressBarWang.style.top = '0%';
        });
      } else if (!inWangZone && wasInWangZone) {
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        gameState.inputLocked = false;
        setTimeout(function () { if (popupWang) popupWang.classList.add('hidden'); }, 300);
      }
      if (inZhugongZone && !wasInZhugongZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetScrollZhugong) bottomSheetScrollZhugong.scrollTop = 0;
        if (popupZhugong) popupZhugong.classList.remove('hidden');
        gameState.inputLocked = true;
        requestAnimationFrame(function () {
          if (bottomSheetZhugong) bottomSheetZhugong.classList.add('open');
          if (scrollProgressBarZhugong) scrollProgressBarZhugong.style.top = '0%';
        });
      } else if (!inZhugongZone && wasInZhugongZone) {
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        gameState.inputLocked = false;
        setTimeout(function () { if (popupZhugong) popupZhugong.classList.add('hidden'); }, 300);
      }
      wasInZone = inZone;
      wasInHuangZone = inHuangZone;
      wasInDuZone = inDuZone;
      wasInLiuZone = inLiuZone;
      wasInYangZone = inYangZone;
      wasInWangZone = inWangZone;
      wasInZhugongZone = inZhugongZone;
    }

    var DEBUG_CAMERA = false;

    function draw() {
      var viewW = camera.viewW;
      var viewH = camera.viewH;
      if (viewW <= 0 || viewH <= 0) return;

      ctx.setTransform(dpr * currentScale, 0, 0, dpr * currentScale, 0, 0);

      ctx.clearRect(0, 0, viewW, viewH);

      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, viewW, viewH);

      ctx.save();
      ctx.beginPath();
      ctx.rect(0, 0, viewW, viewH);
      ctx.clip();
      ctx.translate(-camera.x, -camera.y);

      const cur = mapImages[currentMapIndex];
      const usePlatformOpen = currentMapIndex === 0 && platformCarriageOpen && cur.baseOpen && cur.baseOpen.complete && cur.baseOpen.naturalWidth > 0;
      const drawBase = usePlatformOpen ? cur.baseOpen : cur.base;
      const drawForeground = usePlatformOpen ? cur.foregroundOpen : cur.foreground;
      if (drawBase.complete && drawBase.naturalWidth > 0) {
        ctx.drawImage(drawBase, 0, 0, WORLD_WIDTH, WORLD_HEIGHT, 0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      } else {
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      }

      if (debugPanel && !debugPanel.classList.contains('hidden') && blockedTiles.length > 0) {
        ctx.fillStyle = 'rgba(255, 0, 0, 0.4)';
        for (let row = 0; row < blockedTiles.length; row++) {
          for (let col = 0; col < blockedTiles[row].length; col++) {
            if (blockedTiles[row][col]) {
              ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
          }
        }
      }

      // DEBUG: green square = transmission point (teleport zone by col/row)
      if (debugPanel && !debugPanel.classList.contains('hidden')) {
        ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
        if (currentMapIndex === 0) {
          if (TRANSMISSION_ZONES.platform) {
            TRANSMISSION_ZONES.platform.forEach(function (z) {
              for (let col = z.col1; col <= z.col2; col++) {
                for (let row = z.row1; row <= z.row2; row++) {
                  ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
          if (TRANSMISSION_ZONES.platformClosedToCar2) {
            TRANSMISSION_ZONES.platformClosedToCar2.forEach(function (z) {
              for (let col = z.col1; col <= z.col2; col++) {
                for (let row = z.row1; row <= z.row2; row++) {
                  ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
        }
        if (currentMapIndex === 1) {
          if (TRANSMISSION_ZONES.car2ToPlatformOpen) {
            TRANSMISSION_ZONES.car2ToPlatformOpen.forEach(function (z) {
              for (let c = z.col1; c <= z.col2; c++) {
                for (let r = z.row1; r <= z.row2; r++) {
                  ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
          if (TRANSMISSION_ZONES.car2ToCar3) {
            TRANSMISSION_ZONES.car2ToCar3.forEach(function (z) {
              for (let c = z.col1; c <= z.col2; c++) {
                for (let r = z.row1; r <= z.row2; r++) {
                  ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
        }
        if (currentMapIndex === 2 && TRANSMISSION_ZONES.car3ToCar2) {
          TRANSMISSION_ZONES.car3ToCar2.forEach(function (z) {
            for (let c = z.col1; c <= z.col2; c++) {
              for (let r = z.row1; r <= z.row2; r++) {
                ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
              }
            }
          });
        }
      }

      if (currentMapIndex === 0 && platformCarriageOpen) {
        // å‘¨æ¸…æœˆï¼šèˆ‡å…¶ä»–ç‰©ä»¶åŒé«˜ï¼ˆrow 10 ä¸Šç·£ y=320ï¼‰
        var objX = interactionZone.x + interactionZone.width / 2;
        var zhouY = 10 * TILE_SIZE; // 320ï¼Œèˆ‡é»ƒå®¶æ¯å¥³ç­‰ä¸€è‡´
        if (isNearZoneNow || isInZoneNow) {
          var t = Date.now() / 300;
          var pulse = (Math.sin(t) + 1) / 2;
          var baseRadius = isInZoneNow ? 30 : 22;
          var extra = isInZoneNow ? 10 : 6;
          var radius = baseRadius + extra * pulse;
          var gradient = ctx.createRadialGradient(
            objX, zhouY, 4,
            objX, zhouY, radius
          );
          gradient.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradient.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(objX, zhouY, radius, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var maxCardSize = 120; // æ”¾å¤§ 2 å€é¡¯ç¤ºåœ–ç¤º

        // å‘¨æ¸…æœˆåœ–ç¤º
        var useActive = isNearZoneNow || isInZoneNow;
        var icon = useActive ? cardActiveImage : cardIdleImage;
        if (icon.complete && icon.naturalWidth > 0) {
          var nw = icon.naturalWidth;
          var nh = icon.naturalHeight;
          var scale = Math.min(maxCardSize / nw, maxCardSize / nh, 1);
          var drawW = nw * scale;
          var drawH = nh * scale;
          ctx.drawImage(icon, objX - drawW / 2, zhouY - drawH / 2, drawW, drawH);
        }

        // é»ƒå®¶æ¯å¥³åœ–ç¤ºï¼šä½ç½®å›ºå®šåœ¨ col 23, row 10ï¼Œå¾€ä¸ŠåŠæ ¼
        var huangX = 23 * TILE_SIZE + TILE_SIZE / 2;
        var huangY = 10 * TILE_SIZE; // 320
        if (isNearHuangNow) {
          var tH = Date.now() / 300;
          var pulseH = (Math.sin(tH) + 1) / 2;
          var radiusH = 22 + 6 * pulseH;
          var gradH = ctx.createRadialGradient(huangX, huangY, 4, huangX, huangY, radiusH);
          gradH.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradH.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradH;
          ctx.beginPath();
          ctx.arc(huangX, huangY, radiusH, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var huangIcon = isNearHuangNow ? huangActiveImage : huangIdleImage;
        if (huangIcon.complete && huangIcon.naturalWidth > 0) {
          var hnw = huangIcon.naturalWidth;
          var hnh = huangIcon.naturalHeight;
          var hscale = Math.min(maxCardSize / hnw, maxCardSize / hnh, 1);
          var hW = hnw * hscale;
          var hH = hnh * hscale;
          ctx.drawImage(huangIcon, huangX - hW / 2, huangY - hH / 2, hW, hH);
        }
        // æœå­ç”Ÿåœ–ç¤ºï¼šä½ç½® col 26, row 10
        var duX = 26 * TILE_SIZE + TILE_SIZE / 2;
        var duY = 10 * TILE_SIZE;
        if (isNearDuNow) {
          var tD = Date.now() / 300;
          var pulseD = (Math.sin(tD) + 1) / 2;
          var radiusD = 22 + 6 * pulseD;
          var gradD = ctx.createRadialGradient(duX, duY, 4, duX, duY, radiusD);
          gradD.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradD.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradD;
          ctx.beginPath();
          ctx.arc(duX, duY, radiusD, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var duIcon = isNearDuNow ? duActiveImage : duIdleImage;
        if (duIcon.complete && duIcon.naturalWidth > 0) {
          var dnw = duIcon.naturalWidth;
          var dnh = duIcon.naturalHeight;
          var dscale = Math.min(maxCardSize / dnw, maxCardSize / dnh, 1);
          var dW = dnw * dscale;
          var dH = dnh * dscale;
          ctx.drawImage(duIcon, duX - dW / 2, duY - dH / 2, dW, dH);
        }
        // åŠ‰æ°¸ç¥¥åœ–ç¤ºï¼šä½ç½® col 29, row 10
        var liuX = 29 * TILE_SIZE + TILE_SIZE / 2;
        var liuY = 10 * TILE_SIZE;
        if (isNearLiuNow) {
          var tL = Date.now() / 300;
          var pulseL = (Math.sin(tL) + 1) / 2;
          var radiusL = 22 + 6 * pulseL;
          var gradL = ctx.createRadialGradient(liuX, liuY, 4, liuX, liuY, radiusL);
          gradL.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradL.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradL;
          ctx.beginPath();
          ctx.arc(liuX, liuY, radiusL, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var liuIcon = isNearLiuNow ? liuActiveImage : liuIdleImage;
        if (liuIcon.complete && liuIcon.naturalWidth > 0) {
          var lnw = liuIcon.naturalWidth;
          var lnh = liuIcon.naturalHeight;
          var lscale = Math.min(maxCardSize / lnw, maxCardSize / lnh, 1);
          var lW = lnw * lscale;
          var lH = lnh * lscale;
          ctx.drawImage(liuIcon, liuX - lW / 2, liuY - lH / 2, lW, lH);
        }
        // é™½ç¿°çš„æƒ…å ±å ±å‘Šï¼šé è¿‘åœ– / èªªæ˜åœ–ï¼Œä½ç½® col 33, row 10
        var yangX = 33 * TILE_SIZE + TILE_SIZE / 2;
        var yangY = 10 * TILE_SIZE;
        if (isNearYangNow) {
          var tY = Date.now() / 300;
          var pulseY = (Math.sin(tY) + 1) / 2;
          var radiusY = 22 + 6 * pulseY;
          var gradY = ctx.createRadialGradient(yangX, yangY, 4, yangX, yangY, radiusY);
          gradY.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradY.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradY;
          ctx.beginPath();
          ctx.arc(yangX, yangY, radiusY, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var yangIcon = isNearYangNow ? yangActiveImage : yangIdleImage;
        if (yangIcon.complete && yangIcon.naturalWidth > 0) {
          var ynw = yangIcon.naturalWidth;
          var ynh = yangIcon.naturalHeight;
          var yscale = Math.min(maxCardSize / ynw, maxCardSize / ynh, 1);
          var yW = ynw * yscale;
          var yH = ynh * yscale;
          ctx.drawImage(yangIcon, yangX - yW / 2, yangY - yH / 2, yW, yH);
        }
        // ç‹å†å‚³çš„é»¨å“¡æ‰‹å†Šï¼šä½ç½® col 43, row 10
        var wangX = 43 * TILE_SIZE + TILE_SIZE / 2;
        var wangY = 10 * TILE_SIZE;
        if (isNearWangNow) {
          var tW = Date.now() / 300;
          var pulseW = (Math.sin(tW) + 1) / 2;
          var radiusW = 22 + 6 * pulseW;
          var gradW = ctx.createRadialGradient(wangX, wangY, 4, wangX, wangY, radiusW);
          gradW.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradW.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradW;
          ctx.beginPath();
          ctx.arc(wangX, wangY, radiusW, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var wangIcon = isNearWangNow ? wangActiveImage : wangIdleImage;
        if (wangIcon.complete && wangIcon.naturalWidth > 0) {
          var wnw = wangIcon.naturalWidth;
          var wnh = wangIcon.naturalHeight;
          var wscale = Math.min(maxCardSize / wnw, maxCardSize / wnh, 1);
          var wW = wnw * wscale;
          var wH = wnh * wscale;
          ctx.drawImage(wangIcon, wangX - wW / 2, wangY - wH / 2, wW, wH);
        }
        // ç«¹å·¥ï¼ˆæ–°ç«¹é«˜å·¥çš„å¡—é´‰ï¼‰ï¼šä½ç½® col 45-46 row 10-11 ä¸­å¿ƒ
        var zhugongX = 45 * TILE_SIZE + TILE_SIZE;
        var zhugongY = 10 * TILE_SIZE + TILE_SIZE;
        if (isNearZhugongNow) {
          var tZg = Date.now() / 300;
          var pulseZg = (Math.sin(tZg) + 1) / 2;
          var radiusZg = 22 + 6 * pulseZg;
          var gradZg = ctx.createRadialGradient(zhugongX, zhugongY, 4, zhugongX, zhugongY, radiusZg);
          gradZg.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradZg.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradZg;
          ctx.beginPath();
          ctx.arc(zhugongX, zhugongY, radiusZg, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var zhugongIcon = isNearZhugongNow ? zhugongActiveImage : zhugongIdleImage;
        if (zhugongIcon.complete && zhugongIcon.naturalWidth > 0) {
          var zgnw = zhugongIcon.naturalWidth;
          var zgnh = zhugongIcon.naturalHeight;
          var zgscale = Math.min(maxCardSize / zgnw, maxCardSize / zgnh, 1);
          var zgW = zgnw * zgscale;
          var zgH = zgnh * zgscale;
          ctx.drawImage(zhugongIcon, zhugongX - zgW / 2, zhugongY - zgH / 2, zgW, zgH);
        }
      }

      drawPlayer({
        x: player.x,
        y: player.y,
        width: player.width,
        height: player.height
      });

      if (drawForeground && drawForeground.complete && drawForeground.naturalWidth > 0) {
        ctx.drawImage(drawForeground, 0, 0, WORLD_WIDTH, WORLD_HEIGHT, 0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      }

      ctx.restore();

      if (debugPanel && debugPanelText && !debugPanel.classList.contains('hidden')) {
        const col = Math.floor(player.x / TILE_SIZE);
        const row = Math.floor(player.y / TILE_SIZE);
        debugPanelText.textContent = [
          'åœ°åœ–: ' + (currentMapIndex + 1) + '/' + MAP_LIST.length + ' ' + (MAP_LIST[currentMapIndex] ? MAP_LIST[currentMapIndex].name : '?') + (currentMapIndex === 0 && platformCarriageOpen ? ' (è»Šå»‚é–‹)' : ''),
          'player.x: ' + player.x.toFixed(1),
          'player.y: ' + player.y.toFixed(1),
          'æ ¼å­ col: ' + col + ', row: ' + row,
          'ä¸–ç•Œ: ' + WORLD_WIDTH + ' x ' + WORLD_HEIGHT,
          'camera: ' + camera.x.toFixed(0) + ', ' + camera.y.toFixed(0)
        ].join('\n');
      }

      if (DEBUG_CAMERA) {
        var mapH = WORLD_HEIGHT;
        var mapW = WORLD_WIDTH;
        var diffH = mapH - camera.viewH;
        var viewLargerThanMap = camera.viewH > mapH;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.font = '10px monospace';
        ctx.fillStyle = '#0f0';
        ctx.fillText('mapH=' + mapH + ' viewH=' + camera.viewH + ' diff=' + diffH, 4, 12);
        ctx.fillText('camera.y=' + camera.y + ' view>map=' + viewLargerThanMap, 4, 24);
        ctx.setTransform(dpr * currentScale, 0, 0, dpr * currentScale, 0, 0);
      }
    }

    let lastFrameTime = 0;
    function loop(now) {
      now = now ?? performance.now();
      if (lastFrameTime === 0) lastFrameTime = now;
      const dt = Math.min((now - lastFrameTime) / 1000, 0.1); // seconds, cap to avoid jump after tab focus
      lastFrameTime = now;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    function drawPlayer(p) {
      const halfW = p.width / 2;
      const halfH = p.height / 2;
      const x = p.x - halfW;
      const y = p.y - halfH;

      const sprite = playerSprites[player.dir];
      if (sprite && sprite.complete && sprite.naturalWidth > 0) {
        // Use directional sprite image with a soft glow
        ctx.save();
        ctx.shadowColor = 'rgba(255, 255, 200, 0.8)';
        ctx.shadowBlur = 15;
        ctx.drawImage(sprite, x, y, p.width, p.height);
        ctx.restore();
        return;
      }

      // Fallback: simple placeholder if sprites not found
      ctx.fillStyle = '#3b7cff';
      ctx.fillRect(x + p.width * 0.2, y + p.height * 0.3, p.width * 0.6, p.height * 0.5);

      const headRadius = p.width * 0.3;
      ctx.fillStyle = '#ffddaa';
      ctx.beginPath();
      ctx.arc(p.x, y + headRadius + 2, headRadius, 0, Math.PI * 2);
      ctx.fill();

      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(p.x - p.width * 0.15, y + p.height * 0.8);
      ctx.lineTo(p.x - p.width * 0.15, y + p.height);
      ctx.moveTo(p.x + p.width * 0.15, y + p.height * 0.8);
      ctx.lineTo(p.x + p.width * 0.15, y + p.height);
      ctx.stroke();
    }

    function isPlayerInZone(p, zone) {
      const halfW = p.width / 2;
      const halfH = p.height / 2;
      const left = p.x - halfW;
      const right = p.x + halfW;
      const top = p.y - halfH;
      const bottom = p.y + halfH;

      return !(
        right < zone.x ||
        left > zone.x + zone.width ||
        bottom < zone.y ||
        top > zone.y + zone.height
      );
    }

    // åƒ…ç”¨ç©å®¶ã€Œä¸­å¿ƒé»ã€æ˜¯å¦åœ¨å€å…§åˆ¤å®šï¼ˆè§¸ç™¼å€ y åªå« row 10 æ™‚ï¼Œrow 11 è‡ªç„¶åœ¨å€å¤–ï¼‰
    function isPlayerCenterInZone(p, zone) {
      return p.x >= zone.x && p.x < zone.x + zone.width &&
             p.y >= zone.y && p.y < zone.y + zone.height;
    }

    // Start loop immediately; background will appear once loaded.
    loop();

    // --- Popup (Bottom Sheet) behavior ---
    function closeModal() {
      if (bottomSheet) bottomSheet.classList.remove('open');
      gameState.inputLocked = false;
      setTimeout(function () { popup.classList.add('hidden'); }, 300);
    }
    function closeModalHuang() {
      if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
      gameState.inputLocked = false;
      setTimeout(function () { if (popupHuang) popupHuang.classList.add('hidden'); }, 300);
    }
    function closeModalDu() {
      if (bottomSheetDu) bottomSheetDu.classList.remove('open');
      gameState.inputLocked = false;
      setTimeout(function () { if (popupDu) popupDu.classList.add('hidden'); }, 300);
    }
    function closeModalLiu() {
      if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
      gameState.inputLocked = false;
      setTimeout(function () { if (popupLiu) popupLiu.classList.add('hidden'); }, 300);
    }
    function closeModalYang() {
      if (bottomSheetYang) bottomSheetYang.classList.remove('open');
      gameState.inputLocked = false;
      setTimeout(function () { if (popupYang) popupYang.classList.add('hidden'); }, 300);
    }
    function closeModalWang() {
      if (bottomSheetWang) bottomSheetWang.classList.remove('open');
      gameState.inputLocked = false;
      setTimeout(function () { if (popupWang) popupWang.classList.add('hidden'); }, 300);
    }
    function closeModalZhugong() {
      if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
      gameState.inputLocked = false;
      setTimeout(function () { if (popupZhugong) popupZhugong.classList.add('hidden'); }, 300);
    }

    popup.addEventListener('click', function (e) {
      if (e.target === popup) closeModal();
    });
    popupClose.addEventListener('click', function (e) {
      e.stopPropagation();
      closeModal();
    });
    if (bottomSheet) {
      bottomSheet.addEventListener('click', function (e) { e.stopPropagation(); });
    }

    // æ²å‹•é€²åº¦æ¢ï¼ˆå³å´ç›´æ¢ï¼‰ï¼šå›ºå®šé«˜åº¦è—è‰²å€å¡Šï¼Œéš¨æ²å‹•å¾€ä¸‹ç§»å‹•ï¼Œé»æ“Šå¯è·³è½‰
    const SCROLL_THUMB_HEIGHT_PCT = 20; // è—è‰²å€å¡Šä½”è»Œé“é«˜åº¦æ¯”ä¾‹
    function updateScrollProgress(scrollEl, bar) {
      if (!scrollEl || !bar) return;
      const max = scrollEl.scrollHeight - scrollEl.clientHeight;
      const pct = max <= 0 ? 0 : scrollEl.scrollTop / max;
      const topPct = pct * (100 - SCROLL_THUMB_HEIGHT_PCT);
      bar.style.top = topPct.toFixed(1) + '%';
    }
    function setupScrollProgress(scrollEl, wrap, bar) {
      if (!scrollEl || !bar) return;
      scrollEl.addEventListener('scroll', function () { updateScrollProgress(scrollEl, bar); });
      if (wrap) {
        wrap.addEventListener('click', function (e) {
          const rect = wrap.getBoundingClientRect();
          const yFromBottom = rect.bottom - e.clientY;
          const pct = Math.max(0, Math.min(1, yFromBottom / rect.height));
          const max = scrollEl.scrollHeight - scrollEl.clientHeight;
          scrollEl.scrollTop = pct * max;
          updateScrollProgress(scrollEl, bar);
        });
      }
    }
    const bottomSheetScrollZhou = document.getElementById('bottomSheetScrollZhou');
    const scrollProgressBarZhou = document.getElementById('scrollProgressBarZhou');
    const scrollProgressWrapZhou = document.getElementById('scrollProgressZhou');
    const bottomSheetScrollHuang = document.getElementById('bottomSheetScrollHuang');
    const scrollProgressBarHuang = document.getElementById('scrollProgressBarHuang');
    const scrollProgressWrapHuang = document.getElementById('scrollProgressHuang');
    const bottomSheetScrollDu = document.getElementById('bottomSheetScrollDu');
    const scrollProgressBarDu = document.getElementById('scrollProgressBarDu');
    const scrollProgressWrapDu = document.getElementById('scrollProgressDu');
    const bottomSheetScrollLiu = document.getElementById('bottomSheetScrollLiu');
    const scrollProgressBarLiu = document.getElementById('scrollProgressBarLiu');
    const scrollProgressWrapLiu = document.getElementById('scrollProgressLiu');
    const bottomSheetScrollYang = document.getElementById('bottomSheetScrollYang');
    const scrollProgressBarYang = document.getElementById('scrollProgressBarYang');
    const scrollProgressWrapYang = document.getElementById('scrollProgressYang');
    const bottomSheetScrollWang = document.getElementById('bottomSheetScrollWang');
    const scrollProgressBarWang = document.getElementById('scrollProgressBarWang');
    const scrollProgressWrapWang = document.getElementById('scrollProgressWang');
    const bottomSheetScrollZhugong = document.getElementById('bottomSheetScrollZhugong');
    const scrollProgressBarZhugong = document.getElementById('scrollProgressBarZhugong');
    const scrollProgressWrapZhugong = document.getElementById('scrollProgressZhugong');
    setupScrollProgress(bottomSheetScrollZhou, scrollProgressWrapZhou, scrollProgressBarZhou);
    setupScrollProgress(bottomSheetScrollHuang, scrollProgressWrapHuang, scrollProgressBarHuang);
    setupScrollProgress(bottomSheetScrollDu, scrollProgressWrapDu, scrollProgressBarDu);
    setupScrollProgress(bottomSheetScrollLiu, scrollProgressWrapLiu, scrollProgressBarLiu);
    setupScrollProgress(bottomSheetScrollYang, scrollProgressWrapYang, scrollProgressBarYang);
    setupScrollProgress(bottomSheetScrollWang, scrollProgressWrapWang, scrollProgressBarWang);
    setupScrollProgress(bottomSheetScrollZhugong, scrollProgressWrapZhugong, scrollProgressBarZhugong);

    if (popupHuang) {
      popupHuang.addEventListener('click', function (e) {
        if (e.target === popupHuang) closeModalHuang();
      });
    }
    if (popupHuangClose) {
      popupHuangClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalHuang();
      });
    }
    if (bottomSheetHuang) {
      bottomSheetHuang.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupDu) {
      popupDu.addEventListener('click', function (e) {
        if (e.target === popupDu) closeModalDu();
      });
    }
    if (popupDuClose) {
      popupDuClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalDu();
      });
    }
    if (bottomSheetDu) {
      bottomSheetDu.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupLiu) {
      popupLiu.addEventListener('click', function (e) {
        if (e.target === popupLiu) closeModalLiu();
      });
    }
    if (popupLiuClose) {
      popupLiuClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalLiu();
      });
    }
    if (bottomSheetLiu) {
      bottomSheetLiu.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupYang) {
      popupYang.addEventListener('click', function (e) {
        if (e.target === popupYang) closeModalYang();
      });
    }
    if (popupYangClose) {
      popupYangClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalYang();
      });
    }
    if (bottomSheetYang) {
      bottomSheetYang.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupWang) {
      popupWang.addEventListener('click', function (e) {
        if (e.target === popupWang) closeModalWang();
      });
    }
    if (popupWangClose) {
      popupWangClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalWang();
      });
    }
    if (bottomSheetWang) {
      bottomSheetWang.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupZhugong) {
      popupZhugong.addEventListener('click', function (e) {
        if (e.target === popupZhugong) closeModalZhugong();
      });
    }
    if (popupZhugongClose) {
      popupZhugongClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalZhugong();
      });
    }
    if (bottomSheetZhugong) {
      bottomSheetZhugong.addEventListener('click', function (e) { e.stopPropagation(); });
    }

    // --- Help overlay behavior (desktop) ---
    helpButton.addEventListener('click', () => {
      helpOverlay.classList.remove('hidden');
    });
    helpClose.addEventListener('click', () => {
      helpOverlay.classList.add('hidden');
    });

    if (debugBtn && debugPanel) {
      debugBtn.addEventListener('click', () => {
        debugPanel.classList.toggle('hidden');
      });
    }
    if (debugCopyBtn) {
      debugCopyBtn.addEventListener('click', () => {
        const col = Math.floor(player.x / TILE_SIZE);
        const row = Math.floor(player.y / TILE_SIZE);
        const text = [
          'åœ°åœ–: ' + (currentMapIndex + 1) + '/' + MAP_LIST.length + ' ' + (MAP_LIST[currentMapIndex] ? MAP_LIST[currentMapIndex].name : '?') + (currentMapIndex === 0 && platformCarriageOpen ? ' (è»Šå»‚é–‹)' : ''),
          'player.x: ' + player.x.toFixed(1),
          'player.y: ' + player.y.toFixed(1),
          'æ ¼å­ col: ' + col + ', row: ' + row,
          'ä¸–ç•Œ: ' + WORLD_WIDTH + ' x ' + WORLD_HEIGHT,
          'camera: ' + camera.x.toFixed(0) + ', ' + camera.y.toFixed(0)
        ].join('\n');
        const done = () => {
          debugCopyBtn.textContent = 'å·²è¤‡è£½!';
          setTimeout(() => { debugCopyBtn.textContent = 'è¤‡è£½åº§æ¨™'; }, 1500);
        };
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(done).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); done(); } catch (e) { debugCopyBtn.textContent = 'è¤‡è£½å¤±æ•—'; setTimeout(() => { debugCopyBtn.textContent = 'è¤‡è£½åº§æ¨™'; }, 1500); }
            document.body.removeChild(ta);
          });
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand('copy'); done(); } catch (e) { debugCopyBtn.textContent = 'è¤‡è£½å¤±æ•—'; setTimeout(() => { debugCopyBtn.textContent = 'è¤‡è£½åº§æ¨™'; }, 1500); }
          document.body.removeChild(ta);
        }
      });
    }
    helpOverlay.addEventListener('click', () => {
      helpOverlay.classList.add('hidden');
    });

    // --- Start overlay behavior ---
    let hasShownStart = false;
    function showStartOverlayIfNeeded() {
      if (!hasShownStart) {
        startOverlay.classList.remove('hidden');
        hasShownStart = true;
      }
    }
    function hideStartOverlay() {
      startOverlay.classList.add('hidden');
    }
    startButton.addEventListener('click', hideStartOverlay);
    startOverlay.addEventListener('click', hideStartOverlay);

    showStartOverlayIfNeeded();
  </script>
</body>
</html>

