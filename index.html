<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>《島嶼候車室》線上體驗展：開往民主的轉型正義列車即將發車！</title>
  <!-- Social / link preview (absolute URL required for crawlers) -->
  <meta property="og:url" content="https://sam0404044.github.io/Island-waiting-room/" />
  <meta property="og:title" content="《島嶼候車室》線上體驗展：開往民主的轉型正義列車即將發車！" />
  <meta property="og:description" content="在靜謐的候車室裡，威權歷史是如何成為日常的？點擊進入，領取你的民主快車票。" />
  <meta property="og:image" content="https://sam0404044.github.io/Island-waiting-room/assets/social_preview.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="《島嶼候車室》線上體驗展：開往民主的轉型正義列車即將發車！" />
  <meta name="twitter:description" content="在靜謐的候車室裡，威權歷史是如何成為日常的？點擊進入，領取你的民主快車票。" />
  <meta name="twitter:image" content="https://sam0404044.github.io/Island-waiting-room/assets/social_preview.png" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(180deg, #101318 0%, #05070a 100%);
      color: #111;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      min-height: 100vh;
      height: 100vh;
      height: 100dvh;
      width: 100%;
    }
    @media (min-width: 769px) {
      body {
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }

    /* Desktop layout: large main card + two stacked side cards */
    .layout-desktop {
      width: 100%;
      max-width: 1280px;
      display: flex;
      gap: 24px;
      padding: 24px;
      box-sizing: border-box;
      height: 100vh;
      margin: 0 auto;
    }
    .layout-main {
      flex: 1 1 auto;
      min-width: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 20px;
      box-sizing: border-box;
    }
    .game-canvas-wrap {
      width: 100%;
      height: 100%;
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    canvas {
      border: none;
      background: #000;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      display: block;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: none;
    }
    /* (原 infoBox 樣式已刪除，不再顯示畫面提示框) */

    /* Popup: 底部抽屜 Bottom Sheet（手機優先） */
    .popup-overlay {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      margin: 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 50;
    }
    .popup-overlay.hidden {
      display: none;
    }
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      max-height: 80vh;
      background: #f4e9d7;
      border: 2px solid #c2b59b;
      border-bottom: none;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
      padding-right: 0;
    }
    .bottom-sheet.open {
      transform: translateY(0);
    }
    .bottom-sheet-scroll {
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
      flex: 1;
      min-height: 0;
      padding-right: 14px;
    }
    .bottom-sheet-scroll::-webkit-scrollbar {
      display: none;
    }
    .drag-handle {
      width: 40px;
      height: 4px;
      margin: 10px auto 6px;
      background: #999;
      border-radius: 2px;
      flex-shrink: 0;
    }
    /* 捲動進度條：右側垂直條 */
    .scroll-progress-wrap {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      width: 8px;
      background: rgba(0, 51, 102, 0.1);
      border-radius: 8px 0 0 8px;
      overflow: hidden;
      cursor: pointer;
      z-index: 2;
      box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.06);
    }
    .scroll-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 20%;
      min-height: 24px;
      border-radius: 6px;
      background: linear-gradient(180deg, #00509e 0%, #004080 50%, #003366 100%);
      box-shadow: 0 0 8px rgba(0, 80, 128, 0.4);
      transition: top 0.12s ease-out;
    }
    .scroll-progress-wrap:hover {
      background: rgba(0, 51, 102, 0.18);
    }
    /* 內容不足以捲動時隱藏拉條 */
    .scroll-progress-wrap.no-scroll {
      display: none;
    }
    .popup-content {
      position: relative;
      padding: 8px 20px 20px;
      padding-top: max(8px, env(safe-area-inset-top, 0px));
    }
    .popup-title {
      font-size: clamp(26px, 4.6vw, 34px); /* larger title like the image */
      margin: 0 0 16px 0;
      color: #003366; /* deep blue similar to info.png title */
      letter-spacing: 0.06em;
      font-weight: 700;
      padding-bottom: 6px;
      border-bottom: 2px solid #ffffff; /* clear white underline under the title */
    }
    .popup-body {
      font-size: clamp(12px, 1.9vw, 16px); /* slightly smaller to fit more text */
      line-height: 1.8;
      color: #333333;
    }
    .popup-body p {
      margin: 0 0 10px 0;
    }
    .popup-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0 14px 0;
      font-size: clamp(11px, 1.6vw, 14px);
    }
    .popup-table th,
    .popup-table td {
      border: 1px solid #999;
      padding: 6px 8px;
      text-align: left;
    }
    .popup-table th { background: #e8e8e8; font-weight: 700; }
    .popup-table--compact td:first-child { font-weight: 500; }
    .popup-subtitle { font-size: 1em; margin: 0 0 8px 0; color: #003366; }
    .popup-next-wrap { margin-top: 12px; text-align: right; }
    .popup-next-btn {
      padding: 8px 14px;
      background: #003366;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .popup-next-btn:hover { background: #004080; }
    .popup-figure {
      float: right;
      margin: 0 0 8px 12px;
      text-align: center;
    }
    .popup-figure img {
      display: block;
      max-width: 140px;
      width: 100%;
      height: auto;
    }
    .popup-figure span {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      color: #555;
    }
    /* 黃家母女隨身包：可選裁切，設為 0 即原尺寸 */
    .popup-figure--crop img {
      clip-path: inset(0);
    }
    @media (max-width: 600px) {
      .popup-figure {
        float: right;
        margin: 0 0 10px 12px;
      }
      .popup-figure img {
        max-width: 100px;
      }
    }
    .popup-close {
      position: absolute;
      top: 6px;
      right: 14px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #f4e9d7;
      color: #555;
      font-size: 18px;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      z-index: 3;
    }
    .popup-close:hover {
      background: #e2d6c1;
    }

    /* 電腦版：跳窗置中，非抽屜 */
    @media (min-width: 769px) {
      .popup-overlay {
        align-items: center;
        justify-content: center;
      }
      .bottom-sheet {
        position: relative;
        left: auto;
        right: auto;
        bottom: auto;
        width: min(90vw, 520px);
        max-height: 85vh;
        margin: auto;
        border-radius: 16px;
        border: 2px solid #c2b59b;
        transform: none;
        transition: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .bottom-sheet.open {
        transform: none;
      }
      .drag-handle {
        display: none;
      }
    }

    .controls {
      position: relative;
      margin-top: 8px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
      user-select: none;
    }

    /* Desktop-only help button on the right side；選單打開時隱藏 */
    .help-button-desktop {
      position: fixed;
      right: 16px;
      top: 16px;
      transform: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #333;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
      z-index: 30;
    }
    .help-button-desktop.menu-open {
      display: none !important;
    }

    /* DEBUG 模式按鈕與座標面板 */
    .debug-btn {
      position: fixed;
      left: 16px;
      top: 16px;
      width: 48px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #2a2a2a;
      color: #0f0;
      font-size: 11px;
      font-family: monospace;
      cursor: pointer;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .debug-panel {
      position: fixed;
      left: 16px;
      top: 54px;
      min-width: 200px;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #444;
      border-radius: 6px;
      color: #0f0;
      font-size: 12px;
      font-family: monospace;
      line-height: 1.5;
      z-index: 31;
      white-space: pre;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
    }
    .debug-panel.hidden {
      display: none;
    }
    .debug-copy-btn {
      margin-top: 8px;
      padding: 4px 10px;
      width: 100%;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: #0f0;
      font-size: 12px;
      font-family: monospace;
      cursor: pointer;
    }
    .debug-copy-btn:hover {
      background: #444;
    }

    /* 主要行動按鈕（例如：複製遊戲連結） */
    .primary-button {
      -webkit-appearance: none;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      margin-top: 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #1d72f2, #3ac7c9);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }
    .primary-button:hover {
      filter: brightness(1.05);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }
    .primary-button:active {
      filter: brightness(0.97);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25);
      transform: translateY(1px);
    }

    /* 右側漢堡選單：滑入面板 */
    .help-overlay {
      position: fixed;
      inset: 0;
      z-index: 29;
      pointer-events: none;
    }
    .help-overlay.hidden {
      display: none;
    }
    .help-overlay:not(.hidden) {
      pointer-events: auto;
    }
    .menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .help-overlay:not(.hidden) .menu-backdrop {
      opacity: 1;
    }
    .menu-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: min(90vw, 360px);
      max-width: 360px;
      height: 100vh;
      height: 100dvh;
      background: #f4f4f4;
      color: #222;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      z-index: 30;
    }
    .help-overlay:not(.hidden) .menu-panel {
      transform: translateX(0);
    }
    .menu-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      flex-shrink: 0;
    }
    .menu-panel-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }
    .menu-close {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      background: #e0e0e0;
      color: #333;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .menu-close:hover {
      background: #ccc;
    }
    .menu-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      flex-shrink: 0;
    }
    .menu-tab {
      flex: 1;
      padding: 10px 12px;
      border: none;
      background: transparent;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }
    .menu-tab.active {
      color: #003366;
      font-weight: 600;
      border-bottom: 2px solid #003366;
      margin-bottom: -1px;
    }
    .menu-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      min-height: 0;
    }
    .menu-tab-content[data-tab="achievement"] { display: block; }
    .menu-tab-content[data-tab="about"] { display: none; }
    .menu-panel[data-active="about"] .menu-tab-content[data-tab="about"] { display: block; }
    .menu-panel[data-active="about"] .menu-tab-content[data-tab="achievement"] { display: none; }
    .menu-panel[data-active="achievement"] .menu-tab-content[data-tab="achievement"] { display: block; }
    .menu-panel[data-active="achievement"] .menu-tab-content[data-tab="about"] { display: none; }

    .help-content {
      max-width: 100%;
      padding: 0;
      background: transparent;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
    }
    .help-content h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .help-close {
      margin-top: 12px;
      display: inline-block;
      padding: 6px 12px;
      background: #333;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    /* 成就：一排三個 */
    .achievement-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .achievement-item {
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      background: #e8e4dc;
      border: 2px solid #c2b59b;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
    }
    .achievement-item .achievement-name {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 6px 4px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      font-size: 11px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    .achievement-item:hover .achievement-name,
    .achievement-item.show-name .achievement-name {
      opacity: 1;
    }
    .achievement-item.unlocked .achievement-img {
      display: block;
    }
    .achievement-item.unlocked .achievement-placeholder {
      display: none;
    }
    .achievement-item .achievement-img {
      display: none;
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 6px;
    }
    .achievement-placeholder {
      font-size: 2rem;
      color: #888;
      font-weight: 700;
    }
    .achievement-progress-wrap {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #ddd;
      flex-shrink: 0;
    }
    .achievement-progress-label {
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
    }
    .achievement-progress-bar {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
    }
    .achievement-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #003366 0%, #00509e 100%);
      border-radius: 5px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Experience start screen */
    .start-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .start-overlay.hidden {
      display: none;
    }
    .start-card {
      max-width: 520px;
      padding: 20px 24px 18px;
      border-radius: 10px;
      background: #f4f4f4;
      color: #222;
      text-align: center;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
    }
    .start-card h1 {
      margin: 0 0 10px 0;
      font-size: 20px;
      line-height: 1.6;
    }
    .start-card p {
      margin: 0 0 14px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .start-button {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 18px;
      background: linear-gradient(to bottom, #f7f7f7 0%, #ffffff 70%);
      color: #222;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }
    .start-button:hover {
      background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 80%);
    }
    .character-pick {
      margin: 12px 0 16px 0;
    }
    .character-pick-label {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #444;
    }
    .character-options {
      display: flex;
      gap: 40px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    .character-option {
      padding: 10px;
      border: 2px solid #c2b59b;
      border-radius: 16px;
      background: #f4e9d7;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .character-option:hover {
      border-color: #8b7355;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .character-option.selected {
      border-color: #2a7a4a;
      box-shadow: 0 0 0 2px rgba(42, 122, 74, 0.4);
    }
    .character-option img {
      display: block;
      width: 56px;
      height: 112px;
      object-fit: contain;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .btn {
      -webkit-appearance: none;
      appearance: none;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-variant-emoji: text;
      background: #444;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      border: 1px solid #666;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }
    .btn .arrow-icon {
      width: 28px;
      height: 28px;
      fill: currentColor;
      pointer-events: none;
    }
    .btn.active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
      background: #777;
    }

    /* Joystick-style on-screen control */
    .joystick-area {
      position: relative;
      width: 180px;
      height: 180px;
      touch-action: none;
    }
    .joystick-knob {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #ffffff;
      border: 3px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.4);
      transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px)));
      transition: transform 0.08s ease;
    }
    .joystick-knob::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      width: 96px;
      height: 96px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.5);
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .joystick-area.active .joystick-knob {
      transition: none;
    }
    .joystick-arrow {
      position: absolute;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      opacity: 0.9;
      pointer-events: none;
    }
    .joystick-arrow .arrow-icon {
      width: 22px;
      height: 22px;
    }
    .joystick-arrow-up {
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
    }
    .joystick-arrow-down {
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
    }
    .joystick-arrow-left {
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
    }
    .joystick-arrow-right {
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
    }

    /* Global soft fade-in animation */
    @keyframes fade-in-soft {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Apply fade-in to main cards and key UI elements */
    body,
    .layout-desktop,
    .game-wrapper,
    .side-card,
    #infoBox,
    .controls,
    .start-overlay,
    .help-overlay,
    #popup {
      animation: fade-in-soft 0.7s ease-out both;
    }

    @media (max-width: 768px) {
      body {
        font-size: 16px;
      }
      #infoBox {
        font-size: 16px;
      }
      .popup-title {
        font-size: clamp(20px, 5.2vw, 26px);
      }
      .popup-body {
        font-size: 15px;
      }
      .start-card h1 {
        font-size: 18px;
      }
      .start-card p {
        font-size: 15px;
      }
      .help-content {
        font-size: 15px;
      }
      /* 手機直向：滿版，無左右間距 */
      .layout-desktop {
        flex-direction: column;
        padding: 0;
        margin: 0;
        width: 100%;
        max-width: 100%;
        height: 100vh;
        height: 100dvh;
      }
      .layout-side {
        display: none;
      }
      .layout-main {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-rows: 3.6fr 1fr;
        grid-template-columns: 1fr;
        justify-items: stretch;
        align-items: start;
        gap: 0;
        min-height: 0;
        padding: 0;
        padding-bottom: max(1.5vh, env(safe-area-inset-bottom, 0px));
        box-sizing: border-box;
        overflow: hidden;
      }
      .game-canvas-wrap {
        min-height: 0;
        width: 100%;
        max-width: 100vw;
      }
      canvas {
        border-radius: 18px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      }
      #infoBox {
        position: absolute;
        left: 50%;
        bottom: 80px;
        transform: translateX(-50%);
        margin-top: 0;
        max-width: 90%;
      }
      .controls {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 35vh;
        min-height: 140px;
        margin: 0;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        z-index: 20;
        justify-content: center;
        align-content: center;
        grid-template-columns: 64px 64px 64px;
        grid-template-rows: 64px 64px 64px;
        gap: 8px;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.4) 30%,
          rgba(10, 12, 16, 0.85) 70%,
          rgba(10, 12, 16, 1) 100%
        );
      }
      .controls::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        pointer-events: none;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow:
          0 0 30px rgba(0, 0, 0, 0.6),
          0 0 10px rgba(255, 255, 255, 0.05) inset;
        z-index: -1;
      }
      .btn {
        font-size: 24px;
      }
      .btn .arrow-icon {
        width: 32px;
        height: 32px;
      }

      /* 手機也顯示漢堡選單（可查看成就） */
      .help-button-desktop {
        display: flex;
        right: max(12px, env(safe-area-inset-right, 0px) + 8px);
        top: max(12px, env(safe-area-inset-top, 0px) + 8px);
      }
    }
    /* 桌機版：Canvas 依高度縮放，寬度自動計算，不做水平拉伸；方向鍵固定在右下角 */
    @media (min-width: 769px) {
      .layout-desktop {
        max-width: 100%;
        height: 100vh;
      }
      .layout-main,
      .layout-side {
        height: 100%;
      }
      .game-wrapper {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      .game-canvas-wrap {
        height: 90vh;
        width: 100%;
      }
      canvas {
        border-radius: 16px;
        overflow: hidden;
      }
      .controls {
        position: fixed;
        right: 40px;
        bottom: 40px;
        transform: none;
        margin: 0;
        z-index: 40;
        grid-template-columns: 52px 52px 52px;
        grid-template-rows: 52px 52px 52px;
        gap: 6px;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 190px;
        height: 190px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.85);
        z-index: -1;
      }
    }

    /* 手機橫向：遊戲填滿高度、上方貼齊，方向鍵在畫面右下角，隱藏 ? 按鈕；右側卡片不顯示 */
    @media (max-width: 1024px) and (orientation: landscape) {
      .layout-desktop {
        flex-direction: column;
        padding: 0;
        height: 100vh;
        height: 100dvh;
      }
      .layout-side {
        display: none;
      }
      .layout-main {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        justify-content: flex-start;
        align-items: center;
        overflow: hidden;
      }
      .game-wrapper {
        height: 100vh;
        height: 100dvh;
        padding: 0;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
      }
      .game-canvas-wrap {
        width: 100%;
        height: 100%;
        min-height: 0;
      }
      canvas {
        /* 手機橫向：由 resizeCanvas + contain 繪製，不另用 CSS scale */
        margin: 0;
        display: block;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      }
      #infoBox {
        position: absolute;
        left: 50%;
        bottom: max(80px, env(safe-area-inset-bottom, 0px) + 80px);
        transform: translateX(-50%);
        margin-top: 0;
        max-width: 90%;
      }

      /* 手機橫向：跳窗接近滿版、可捲動 */
      .popup-content {
        width: min(96vw, 520px);
        max-width: 96vw;
        max-height: min(80vh, 720px);
      }
      .controls {
        /* 手機橫向：方向鍵固定在畫面右下角 */
        position: fixed;
        right: max(16px, env(safe-area-inset-right, 0px) + 12px);
        bottom: max(24px, env(safe-area-inset-bottom, 0px) + 16px);
        left: auto;
        transform: none;
        margin: 0;
        z-index: 30;
        grid-template-columns: 64px 64px 64px;
        grid-template-rows: 64px 64px 64px;
        gap: 8px;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.85);
        z-index: -1;
      }

      /* 橫向手機也顯示漢堡選單 */
      .help-button-desktop {
        display: flex;
      }
    }

    /* 直向螢幕（含平板）：滿版、無左右間距 */
    @media (max-width: 1024px) and (orientation: portrait) {
      .layout-desktop {
        height: 100vh;
        height: 100dvh;
        padding: 0;
        margin: 0;
        max-width: 100%;
      }
      .layout-main {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-rows: 2.8fr 1fr;
        grid-template-columns: 1fr;
        justify-items: stretch;
        align-items: start;
        gap: 0;
        min-height: 0;
        padding: 0;
        padding-bottom: max(1.5vh, env(safe-area-inset-bottom, 0px));
        box-sizing: border-box;
        overflow: hidden;
      }
      .controls {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 35vh;
        min-height: 140px;
        margin: 0;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        z-index: 20;
        justify-content: center;
        align-content: center;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.4) 30%,
          rgba(10, 12, 16, 0.85) 70%,
          rgba(10, 12, 16, 1) 100%
        );
      }
      .controls::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        pointer-events: none;
      }
      .controls::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        box-shadow:
          0 0 30px rgba(0, 0, 0, 0.6),
          0 0 10px rgba(255, 255, 255, 0.05) inset;
        z-index: -1;
      }
    }
  </style>
</head>
<body>
  <div class="layout-desktop">
    <div class="layout-main">
      <div id="game-canvas-wrap" class="game-canvas-wrap">
        <canvas id="game"></canvas>
      </div>

      <!-- Popup: 底部抽屜 Bottom Sheet -->
      <div id="popup" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetZhou">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollZhou">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">周清月的記者證</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="assets/1_0.png" alt="周清月的記者證圖像" />
                  <span>圖說：周清月的記者證</span>
                </div>
                <p>民國 70 年 7 月 3 日，陳文成教授被發現陳屍在臺灣大學校內。而後，他在美國卡內基．梅隆大學的同事──法醫魏契與統計系主任狄格魯來臺，對陳文成之死進行獨立調查。</p>
                <p>陳文成之死引起國內外廣泛關注，美聯社記者周清月（Tina Chou）採訪陳文成的父親後，針對狄格魯與魏契來臺撰寫了報導。因為這篇報導，周清月被新聞局以「在國際間嚴重損及中華民國主權與法律的尊嚴」為由，取消了記者證，並禁止她從事任何新聞工作。</p>
                <p>因為報導中提到魏契與狄格魯來臺「驗屍」（autopsy），而新聞局認為兩人僅是「檢視」（view）屍體，並非「驗屍」。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressZhou" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarZhou"></div>
          </div>
          <button id="popupClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 黃家母女的隨身包 -->
      <div id="popupHuang" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetHuang">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollHuang">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">黃家母女的隨身包</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="車廂1物件/黃家母女無人.png" alt="黃家母女的隨身包圖像" />
                  <span>圖說：黃家母女的隨身包</span>
                </div>
                <p>民國42年，黃溫恭遭到槍決，當時他的長女黃鈴蘭年僅5歲。</p>
                <p>黃溫恭是路竹鄉的齒科醫生，因涉及「省工委燕巢、路竹支部案」被判刑，留下妻子黃楊清蓮和三個孩子。</p>
                <p>姊姊黃鈴蘭成長記憶裡，母親總是隨身帶一個小包包，裡面放著各式證件，以備警察檢查。晚年失智時，母親常檢查完身分證又馬上忘記，忘記又再檢查。直到臨終，母親依舊將裝滿證件的小包包放在床邊，終日生活在恐懼下。</p>
                <p>而即使姊妹兩人長大成人，步入婚嫁，來自政府的監控仍沒有停止。</p>
                <p>每周都會有警察進行戶口查察，在市場做生意時，警察也利用各種理由打擾。例如要求寫問卷調查來留下筆跡，比較直白的警察，還會直接索取照片，那種無形的壓力，在心中埋藏很久。</p>
                <p>妹妹黃春蘭偶爾也會想：「其實整個事情是父親一個人做的，為什麼家裡所有人都要受到這種監控？」</p>
                <p>對黃家的監控自民國48年開始，至79年撤銷，持續超過30年。</p>
                <p>檔案解密後，黃春蘭在閱覽檔案時分享：「我們政治受難者家屬最常聽到的，就是『事情都這麼久了，該放下，要走出去，可是你們為什麼一直不走過去呢？為什麼一直不放下？』我覺得歷史尚未完全明朗，這種事情對我們來說其實相當沉重，不是我們不想走過去，我也希望有非常快樂的人生呀……」</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressHuang" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarHuang"></div>
          </div>
          <button id="popupHuangClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 杜孝生 -->
      <div id="popupDu" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetDu">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollDu">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">杜孝生的聽診器</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="車廂1物件/杜孝生無人.png" alt="杜孝生的聽診器圖像" />
                  <span>圖說：杜孝生的聽診器</span>
                </div>
                <p>新美農場的開拓並不容易，鄒族人到這裡時，土地還是一片森林。</p>
                <p>當時鄒族人生活場域能夠耕作的地很少且陡峭，阿里山鄒族領袖高一生與胞弟杜孝生（Voytte Tosktt），希望讓族人的生活過得更好，所以由達邦（tapangx）部落遷移至新美（yaisana）農場。</p>
                <p>杜孝生畢業於臺北帝國大學附屬醫學專門部，同時兼任吳鳳鄉衛生所所長，以及新美農場場長。</p>
                <p>一開始新美農場尚未有糧食產出，因此第一批族人每 10 天就需要往返達邦搬運地瓜等物資作物，供墾荒之用。路途遙遠，甚至要中途過夜，長達半年之久。</p>
                <p>民國 41 年 9 月，杜孝生與高一生被以「下山開會」為由誘出，實為情治單位的誘捕。逮捕後，當局在部落內散播指控杜孝生等人「侵占新美農場公款與種子」「侵占政府配發肥料與棉布」等宣傳。</p>
                <p>本應由普通法院審理的案件，在參謀總長周至柔要求下改由軍法審判。軍法官未調查對杜孝生有利的證據，情治機關也未取得關鍵證據「新美農場帳冊」。杜孝生被判 17 年徒刑。</p>
                <p>出獄後因冤名未雪，不被部落接納，杜孝生後於台東開設診所。政府對阿里山原住民的政治監控意在壓制異議、控制原住民族，「貪污」污名至今仍影響部落。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressDu" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarDu"></div>
          </div>
          <button id="popupDuClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 劉永祥 -->
      <div id="popupLiu" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetLiu">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollLiu">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">劉永祥的學生證</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="車廂1物件/劉永祥無人.png" alt="劉永祥的學生證圖像" />
                  <span>圖說：劉永祥的學生證</span>
                </div>
                <p>國共內戰爆發後，有數千名學生從青島撤退上海，輾轉湖南、廣東，最後倉皇逃到澎湖，劉永祥就是其中之一。</p>
                <p>教育部和澎湖防守司令部商定，讓這群來自山東的流亡學生 17 歲以上「半訓半讀」，16 歲以下則是設立「澎湖防守司令部子弟學校」繼續上課。</p>
                <p>但澎湖防衛司令部為補充國共內戰中耗損的兵員，不顧與教育部商定「半訓半讀」的保證，將超過千名流亡學生強制編入部隊，並以武力壓制反對的聲音，造成 2 名學生遭刺傷。</p>
                <p>被強制編入部隊的學生在書信中表達不滿，澎湖防衛司令部卻將他們的訴求斥為「滿紙匪諜反動言語」。澎湖防衛司令部將案件移送軍法審判時的紀錄顯示，共有 96 名師生遭逮捕，並受到「疲勞偵訊」。</p>
                <p>挺身維護學生權益的兩位校長，以及劉永祥與另外 5 名學生，被認定為「主要匪犯」，判處死刑，於新店溪畔堤防旁的馬場町刑場槍決。這起事件即為歷史上所稱的「七一三事件」。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressLiu" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarLiu"></div>
          </div>
          <button id="popupLiuClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 楊翰 -->
      <div id="popupYang" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetYang">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollYang">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">陽翰的情報報告</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="車廂1物件/陽翰無人.png" alt="陽翰的情報報告圖像" />
                  <span>圖說：陽翰的情報報告</span>
                </div>
                <p>在監控檔案裡寫著，線民「陽翰」負責在《新文化》雜誌社、《臺灣文藝》情蒐，而陽翰真實身分的欄位，寫是前衛出版社負責人林文欽。</p>
                <p>但這件事，仔細查看陽翰的情報報告，又會看到「臺灣新文化雜誌社務委員林文欽於辦公室談話……」這樣的內容，等於是林文欽自己在監控自己。</p>
                <p>再加上《臺灣新文化》雜誌受政府監控，多次停刊及查扣，如果林文欽是線民，協助政府監控結果自己損失慘重，也不符常理。</p>
                <p>為了確認檔案內容，促轉會請主管這份檔案的情治機關人員說明，該人員坦言，檔案裡雖然註記陽翰是林文欽，但事實卻不盡是。</p>
                <p>「〈情報報告〉上面有一個格式，你要寫來源，你就掛一個名字。實際上你自己去蒐報，去問人。」</p>
                <p>為什麼白紙黑字的檔案，會出現這樣的灰色地帶？可能因為線民陽翰的身分對外保密，因此在調查人員便自行行事，檔案記載的相關資訊，就背離了事實。</p>
                <p>但像陽翰的情況是否只是個案？在缺乏大規模的檔案研究與核實工作之前，難以妄下評論。</p>
                <p>還原歷史真相的工作，便是透過檔案資料核實的過程，對檔案中的灰色段落保持警惕，這是因應檔案開放不得不審慎面對的重要工程，否則不但可能難以還原歷史真相，反而招致更多的誤解及傷害。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressYang" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarYang"></div>
          </div>
          <button id="popupYangClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 王再傳的黨員手冊 -->
      <div id="popupWang" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetWang">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollWang">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">王再傳的黨員手冊</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="車廂1物件/王再傳無人.png" alt="王再傳的黨員手冊圖像" />
                  <span>圖說：王再傳的黨員手冊</span>
                </div>
                <p>歷史上的「鹿窟事件」，是指由國防部保密局主導，在民國 41、42 年間，鎖定在汐止、石碇、瑞芳等地發展的共產黨組織，進行一連串的調查、搜捕及審判。</p>
                <p>王再傳被起訴曾在大安印刷廠充當印刷工，翻印《開國文獻》、《28 週年紀念》、《黨員手冊》等書，以及在鹿窟基地充任戰鬥員，因此判處死刑。</p>
                <p>王再傳參與共產黨組織或許是事實，但調閱審判相關檔案資料，會發現判決內容與過程存有眾多疑義。</p>
                <p>王再傳在審判紀錄中表示：「因為當時生病沒有受訓，戰鬥員的部分是法官問大家有沒有我也有，他們寫的，我沒有承認。」</p>
                <p>王再傳案最終審理日期為民國 43 年 9 月 22 日，但判決書所載辯護人接見日期卻是 9 月 23 日，意即辯護人未實際接見被告即撰寫辯護意旨書，並代為「自白認罪」。</p>
                <p>依《懲治叛亂條例》即便翻印書籍、受訓，參加叛亂組織通常為無期徒刑或十年以上有期徒刑，但判決卻以「直接以非法之方法顛覆政府」論處死刑。</p>
                <p>可見當時的司法已非保障人權的最後防線，而是統治者整肅異己的機制，法官未依證據定罪，事後救濟無門，造成不少人權迫害。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressWang" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarWang"></div>
          </div>
          <button id="popupWangClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 許宗力的海外學人回國服務登記表 -->
      <div id="popupXu" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetXu">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollXu">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">許宗力的海外學人回國服務登記表</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="車廂1物件/許宗力無人.png" alt="許宗力的海外學人回國服務登記表圖像" />
                  <span>圖說：許宗力的海外學人回國服務登記表</span>
                </div>
                <p>海外歸國的學者，時常是被監控的對象，例如在德國攻讀法學博士學位的許宗力，畢業後想要返國執教，在民國75年2月，填了青輔會的「海外學人回國服務登記表」尋求推介。</p>
                <p>情治機關在安全查核過程留下了這樣的紀錄：「許某於七十一年六月赴德進修迄今......平日專心研讀，甚少參加其他活動，在思想言行上未發現不良情事。」</p>
                <p>可見得，即使身處海外，留學生的言行舉止都會列入審查，而且不僅是留學時的紀錄，情治機關還從軍中、校安等不同情治系統所留存的檔案中，調出許宗力過往種種的「不妥言行」。</p>
                <p>例如他曾擔任台大「法言社」社長，撰寫〈從亡斧談起〉一文，被審查者認為「偏激」而遭修改或禁止。預官訓練期間於政戰學校，歷經兩個月的輔導與約談，仍拒絕加入國民黨，表示「法官是超然的，入黨對個人而言並無好處。」這些求學與服役的經歷，都被情治機關列為「涉嫌情形」，使他返國後無法進入國立大學任教。</p>
                <p>許宗力其後多次爭取進入台大法律系，情治機關仍指示系主任「約束許員言行，並予疏導轉化」。即便開始任教後，對許宗力的監控仍未停止，情治機關留有他參加學術研討會、投書報刊、在課堂上與學生討論時事等紀錄，監控直到民國85年仍有數筆監控紀錄留於檔案中，監控時間至少長達十年。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressXu" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarXu"></div>
          </div>
          <button id="popupXuClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 新竹高工裡的塗鴉 -->
      <div id="popupZhugong" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetZhugong">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollZhugong">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">新竹高工裡的塗鴉</h3>
              <div class="popup-body">
                <div class="popup-figure">
                  <img src="車廂1物件/竹工無人.png" alt="新竹高工裡的塗鴉圖像" />
                  <span>圖說：新竹高工裡的塗鴉</span>
                </div>
                <p>民國 70 年，新竹高工廁所裡有人用原子筆寫下「信仰馬列主義」、「反對中央政府」、「打擊黑狗」等字句。</p>
                <p>「打擊黑狗」的「黑狗」是該校教官的綽號，塗鴉可能出自對校園生活不滿的學生。如今看來或許只是廁所塗鴉，當時這類「不當文字」卻引起情治機關高度重視。</p>
                <p>情治機關為找出廁所塗鴉的學生，發動全校性的筆跡比對，收繳學生週記、作業等進行比對。筆跡鑑定並不容易，經全面比對師生筆跡後，先後篩出 56 份可疑筆跡，再經細部比對，卻無一與廁所塗鴉筆跡相符。</p>
                <p>情治機關又針對與綽號「黑狗」的教官有衝突的學生進行調查，懷疑是不滿學生所為，仍無法鎖定塗鴉學生。</p>
                <p>塗鴉發現於民國 70 年，整起調查與筆跡收繳耗費大量人力物力，案件直至民國 74 年才以放棄偵辦結案，前後長達四年。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressZhugong" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarZhugong"></div>
          </div>
          <button id="popupZhugongClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 便當攤（終審判決結果，單頁全部呈現） -->
      <div id="popupBento" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetBento">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollBento">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">終審判決結果</h3>
              <div class="popup-body">
                <p class="popup-broadcast">審判人員參與次數</p>
                <table class="popup-table">
                  <thead>
                    <tr><th>排名</th><th>姓名</th><th>職稱</th><th>參與次數</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>1</td><td>蔣中正</td><td>總統</td><td>4,101 次</td></tr>
                    <tr><td>2</td><td>殷敬文</td><td>軍法官</td><td>3,233 次</td></tr>
                    <tr><td>3</td><td>周至柔</td><td>參謀總長</td><td>3,152 次</td></tr>
                    <tr><td>4</td><td>周咸慶</td><td>軍法官</td><td>2,887 次</td></tr>
                    <tr><td>5</td><td>邢炎初</td><td>軍法官</td><td>2,689 次</td></tr>
                    <tr><td>6</td><td>范明</td><td>軍法官</td><td>2,675 次</td></tr>
                    <tr><td>7</td><td>彭國壎</td><td>軍法官</td><td>2,161 次</td></tr>
                    <tr><td>8</td><td>王名馴</td><td>總統府參軍長</td><td>2,160 次</td></tr>
                    <tr><td>9</td><td>桂永清</td><td>總統府參軍長</td><td>1,993 次</td></tr>
                    <tr><td>10</td><td>張羣</td><td>總統府秘書長</td><td>1,566 次</td></tr>
                  </tbody>
                </table>
                <h4 class="popup-subtitle">終審判決為死刑的案件</h4>
                <table class="popup-table popup-table--compact">
                  <tr><td>終審判決為死刑的案件</td><td>1,151 件</td></tr>
                  <tr><td>蔣中正經手過的死刑案件</td><td>970 件（佔死刑案件 84.27%）</td></tr>
                  <tr><td>經蔣中正核覆後改判案件</td><td>790 件</td></tr>
                  <tr><td>改判死刑</td><td>259 件（佔改判案件 32.78%）</td></tr>
                </table>
                <p>政治案件審判決策的參與次數最多的是蔣中正（總統），顯見其對審判過程的介入程度，其次除軍法官以外，參謀總長、總統府參軍長、總統府秘書長等參與程度亦高。</p>
                <h4 class="popup-subtitle">終審判決引用法條</h4>
                <table class="popup-table popup-table--compact">
                  <tr><td>懲治叛亂防制條例第5條</td><td>1,860 次（14.67%）</td></tr>
                  <tr><td>懲治叛亂防制條例第2條第1項</td><td>1,415 次（11.16%）</td></tr>
                </table>
                <p>而終審判決中引用次數最多的法條，刑度為無期徒刑或 10 年以上有期徒刑，以及處死刑，顯示多為重刑。</p>
              </div>
            </div>
          </div>
          <button id="popupBentoClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 廁所（案件當事人性別 OCR） -->
      <div id="popupToilet" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetToilet">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollToilet">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">案件當事人性別</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/廁所.png" alt="案件當事人性別圖像" />
                  <span>圖說：案件當事人性別</span>
                </div>
                <table class="popup-table popup-table--compact">
                  <tr><td>男性</td><td>96%</td></tr>
                  <tr><td>女性</td><td>4%</td></tr>
                </table>
                <p>男女比例極為懸殊，反映出威權統治時期生命、自由權直接受到侵害的當事人以男性為主，但這也反映出另一個面向是，「獄外之囚」以女性為主的情形。</p>
              </div>
            </div>
          </div>
          <button id="popupToiletClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 售票機（政治案件當事人年齡／遭判刑度 OCR） -->
      <div id="popupTicket" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetTicket">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollTicket">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">政治案件當事人統計</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/售票機.png" alt="售票機圖像" />
                  <span>圖說：售票機</span>
                </div>
                <h4 class="popup-subtitle">政治案件當事人年齡</h4>
                <table class="popup-table">
                  <thead>
                    <tr><th>年齡層</th><th>人數</th><th>%</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>18歲含以下</td><td>383人</td><td>3.24%</td></tr>
                    <tr><td>19-29歲</td><td>5,051人</td><td>42.67%</td></tr>
                    <tr><td>30-39歲</td><td>3,488人</td><td>29.47%</td></tr>
                    <tr><td>40-49歲</td><td>1,889人</td><td>15.96%</td></tr>
                    <tr><td>50-59歲</td><td>807人</td><td>6.82%</td></tr>
                    <tr><td>60-69歲</td><td>199人</td><td>1.68%</td></tr>
                    <tr><td>70-79歲</td><td>16人</td><td>0.14%</td></tr>
                    <tr><td>80歲以上</td><td>4人</td><td>0.08%</td></tr>
                  </tbody>
                </table>
                <p>當事人主要年齡層集中在19至39歲之間（超過七成），顯示當時對青壯年的控制與壓迫。所有當事人當中，最小當事人被起訴時年齡僅11歲，最年長則為84歲，影響範圍廣大。</p>
                <h4 class="popup-subtitle">案件當事人遭判刑度</h4>
                <table class="popup-table">
                  <thead>
                    <tr><th>刑度</th><th>人數</th><th>%</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>死刑</td><td>1,153人</td><td>9.58%</td></tr>
                    <tr><td>無期徒刑</td><td>169人</td><td>1.4%</td></tr>
                    <tr><td>有期徒刑15年以上</td><td>425人</td><td>3.53%</td></tr>
                    <tr><td>有期徒刑10年以上未滿15年</td><td>1,628人</td><td>13.53%</td></tr>
                    <tr><td>有期徒刑5年以上未滿10年</td><td>1,498人</td><td>12.45%</td></tr>
                    <tr><td>有期徒刑未滿5年</td><td>1,021人</td><td>8.48%</td></tr>
                    <tr><td>感化（訓）教育</td><td>1,744人</td><td>14.49%</td></tr>
                    <tr><td>無罪</td><td>726人</td><td>6.03%</td></tr>
                    <tr><td>不起訴或不交付軍事審判</td><td>3,507人</td><td>29.14%</td></tr>
                    <tr><td>其他</td><td>163人</td><td>1.35%</td></tr>
                  </tbody>
                </table>
                <p>將近三成的當事人被判處10年以上的重刑，反映出白色恐怖時期政治案件量刑的嚴峻。</p>
              </div>
            </div>
          </div>
          <button id="popupTicketClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 書架（案件當事人出生地 OCR） -->
      <div id="popupBookshelf" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetBookshelf">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollBookshelf">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">案件當事人出生地</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/書架.png" alt="書架圖像" />
                  <span>圖說：書架</span>
                </div>
                <table class="popup-table popup-table--compact">
                  <tr><td>1. 臺南縣市</td><td>864人（11.44%）</td></tr>
                  <tr><td>2. 高雄縣市</td><td>796人（10.54%）</td></tr>
                  <tr><td>3. 臺北縣</td><td>760人（10.07%）</td></tr>
                </table>
                <p>政治案件當事人的出生地並不侷限於權力核心的首都，包括臺南市、高雄市、臺北縣、臺中市都各佔一成左右，顯示全臺各處都受到掌控與影響。</p>
              </div>
            </div>
          </div>
          <button id="popupBookshelfClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 告示（政治案件高峰期 OCR） -->
      <div id="popupNotice" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetNotice">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollNotice">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">政治案件高峰期</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/告示.png" alt="告示圖像" />
                  <span>圖說：告示</span>
                </div>
                <p class="popup-broadcast">政治案件被判刑確定的年代</p>
                <table class="popup-table">
                  <thead>
                    <tr><th>年代</th><th>件數</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>1940</td><td>198件（1.74%）</td></tr>
                    <tr><td>1950</td><td>5,792件（50.82%）</td></tr>
                    <tr><td>1960</td><td>1,232件（10.81%）</td></tr>
                    <tr><td>1970</td><td>1,200件（10.52%）</td></tr>
                    <tr><td>1980</td><td>2,857件（25.05%）</td></tr>
                    <tr><td>1990-1993</td><td>129件（1.13%）</td></tr>
                  </tbody>
                </table>
                <p>政治案件過半數產生於1950年代，反映出中華民國政府遷臺初期，為了鞏固統治及肅清潛在的反政府勢力，而大舉施行白色恐怖的歷史背景。此後，隨著統治基礎已然穩固，政治案件的數量逐漸下降。</p>
              </div>
            </div>
          </div>
          <button id="popupNoticeClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 士農工商（政治案件當事人職業 OCR） -->
      <div id="popupShinonggongshang" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetShinonggongshang">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollShinonggongshang">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">政治案件當事人職業</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/士農工商.png" alt="士農工商圖像" />
                  <span>圖說：士農工商</span>
                </div>
                <table class="popup-table">
                  <thead>
                    <tr><th>職業</th><th>人數</th><th>百分比</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>管理階層與民意代表</td><td>676人</td><td>5.66%</td></tr>
                    <tr><td>專業人員</td><td>981人</td><td>8.22%</td></tr>
                    <tr><td>辦公室與服務業人員</td><td>2,493人</td><td>20.89%</td></tr>
                    <tr><td>農林漁牧人員</td><td>1,825人</td><td>15.29%</td></tr>
                    <tr><td>勞動工人</td><td>2,047人</td><td>17.15%</td></tr>
                    <tr><td>軍警人員</td><td>1,756人</td><td>14.71%</td></tr>
                    <tr><td>學生與家庭主婦</td><td>501人</td><td>4.19%</td></tr>
                    <tr><td>失業與無業者</td><td>1,656人</td><td>13.87%</td></tr>
                  </tbody>
                </table>
                <h4 class="popup-subtitle">案件當事人職業</h4>
                <p>當事人的職業為辦公室或服務人員、勞動工人、失業及無業者、軍警人員，分別皆佔13-20%，顯示影響遍布社會各界。</p>
              </div>
            </div>
          </div>
          <button id="popupShinonggongshangClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 站名牌（案件當事人省籍 OCR） -->
      <div id="popupStationSign" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetStationSign">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollStationSign">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">案件當事人省籍</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/站名牌.png" alt="站名牌／省籍圖像" />
                  <span>圖說：站名牌（省籍）</span>
                </div>
                <table class="popup-table popup-table--compact">
                  <tbody>
                    <tr><td>臺灣省</td><td>57%</td></tr>
                    <tr><td>外省</td><td>43%</td></tr>
                  </tbody>
                </table>
                <p>考量到外省籍在臺灣的人數遠少於臺灣省籍者，但政治案件當事人的比例兩者卻僅相差10多個百分點，反映出威權政府對於外省籍人士的壓迫並不少於臺灣省籍者。</p>
              </div>
            </div>
          </div>
          <button id="popupStationSignClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 電子看板左（促轉會工作大事記） -->
      <div id="popupElectronicBoardLeft" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetElectronicBoardLeft">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollElectronicBoardLeft">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">促轉會工作大事記</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/電子看板左.png" alt="電子看板左圖像" />
                  <span>圖說：電子看板左</span>
                </div>
                <p class="popup-broadcast">開往：還原歷史真相、威權象徵處理、平復司法不法、重建社會信任</p>
                <table class="popup-table">
                  <thead>
                    <tr><th>時間</th><th>事件</th><th>動作</th><th>質化成果</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>2018/05</td><td>掛牌成立</td><td>設立任務小組</td><td>設「還原歷史真相」、「威權象徵處理」、「平復司法不法」與「重建社會信任」四組</td></tr>
                    <tr><td>2020/02/17</td><td>林義雄宅血案調查報告</td><td>公布調查報告</td><td>調查發現威權統治當局涉入本案的嫌疑不容排除</td></tr>
                    <tr><td>2020/02/26</td><td>臺灣轉型正義資料庫</td><td>資料庫上線</td><td>以受裁判人為單位彙整裁判書等重要決定描繪威權時期軍審樣貌</td></tr>
                    <tr><td>2020/05/04</td><td>陳文成案調查報告</td><td>公布調查報告</td><td>官方報告首次認定他殺高於意外或自殺，警總嫌疑不容排除</td></tr>
                    <tr><td>2021/05/11</td><td>促進轉型正義條例 部分條文修正草案</td><td>提出法案函報行政院</td><td>擴大應平復範圍，代表國家承認過去不法侵害人權之事實</td></tr>
                    <tr><td>2021/05/12</td><td>威權統治時期國家不法行為 被害者權利回復條例草案</td><td>提出法案函報行政院</td><td>確立權利遭國家不法侵害者依法申領賠償金之公民地位；亦就「沒收財產返還」提出方案</td></tr>
                    <tr><td>2021/08</td><td>促進轉型正義基金 設置計畫書</td><td>獲行政院核定 同意辦理</td><td>依法規劃及運用收歸國有之不當黨產，從黨國還給全民</td></tr>
                    <tr><td>2021/09/08</td><td>中正紀念堂轉型方案</td><td>提出方案構想</td><td>以「反省威權歷史公園」為整體園區轉型主軸，逐步收攏聚焦社會討論</td></tr>
                  </tbody>
                </table>
                <p>請至右側觀看量化年表 →</p>
              </div>
            </div>
          </div>
          <button id="popupElectronicBoardLeftClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 月台 電子看板右（促轉會工作大事記／量化年表） -->
      <div id="popupElectronicBoardRight" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetElectronicBoardRight">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollElectronicBoardRight">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">促轉會工作大事記（量化年表）</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="月台區物件/電子看板右.png" alt="電子看板右圖像" />
                  <span>圖說：電子看板右</span>
                </div>
                <p class="popup-broadcast">開往：還原歷史真相、威權象徵處理、平復司法不法、重建社會信任</p>
                <p class="popup-broadcast">列車即時資訊</p>
                <table class="popup-table">
                  <thead>
                    <tr><th>時間</th><th>事件</th><th>動作</th><th>量化成果</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>2020/11/27</td><td>建議司法院大法官 檔案審定為政治檔案</td><td>提成審定建議</td><td>建議83案大法官解釋審定為政治檔案，作為威權形成與介入司法參考</td></tr>
                    <tr><td>2021/03</td><td>審定不義遺址</td><td>確認侵害人權事件發生地</td><td>審定以二二八事件為主25處不義遺址；第二批待審定遺址以白色恐怖時期為主</td></tr>
                    <tr><td>截至 2021/03</td><td>推動公共空間 威權象徵處置</td><td>追蹤、調查及協商</td><td>追蹤中央機關及地方縣市政府共1,553個/處威權象徵，其中26.79%已處置或已同意處置</td></tr>
                    <tr><td>2021/05/30</td><td>統計政治案件 當事人數量</td><td>統計分析政治案件資料</td><td>初估威權統治時期政治案件當事人共21,257人（可能隨檔案出土修正）</td></tr>
                    <tr><td>截至 2021/08/05</td><td>審定國民黨檔案 為政治檔案</td><td>作成審定處分</td><td>完成4批處分，共審定7,526筆政治檔案移歸檔案局提供各界應用</td></tr>
                    <tr><td>截至 2021/10/12</td><td>政治受難者及家屬 照顧支持據點試辦計畫</td><td>政治暴力創傷療癒</td><td>共有台北、台中、台南、高雄試辦，至今服務101位個案，活動參與1,108人</td></tr>
                    <tr><td>截至 2021/10/19</td><td>公告撤銷刑事有罪判決</td><td>依法予以平復</td><td>辦理7批撤銷公告，平復5,942件刑事有罪判決（另有已平復尚未公告案件9件）</td></tr>
                  </tbody>
                </table>
                <p>請至左側觀看質化年表 ←</p>
              </div>
            </div>
          </div>
          <button id="popupElectronicBoardRightClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂2 原住民轉型正義（文件1.png ORC 內容，單頁） -->
      <div id="popupCar2Orc" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar2Orc">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar2Orc">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">原住民轉型正義</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="車廂2物件/文件1.png" alt="原住民轉型正義圖像" />
                  <span>圖說：原住民轉型正義</span>
                </div>
                <p class="popup-broadcast"><strong>廣播：</strong>各位旅客您好，這裡是車掌廣播。接下來我將會為您介紹車廂內配置，首先是「原住民轉型正義」。</p>
                <p><strong>廣播：</strong>原住民族受到的迫害，並非僅限於個人遭受司法不法的侵害，也涉及國家政策造成集體基本權利的不當侵害。</p>
                <p><strong>Q1：</strong>為什麼討論轉型正義要特別將原住民議題獨立出來？</p>
                <p><strong>A1：</strong>威權政府沿襲日治時期的蕃地警察制度，以國家安全、保護山地治安為理由，透過跨機關協力，建立山地警備系統進行實質控制，情治單位更以調查之名進行各項保防、情蒐，產生如樂信·瓦旦（林瑞昌）、吾雍·雅達烏猶卡那（高一生）等重大政治案件。</p>
                <p>另一方面，威權政府的原住民政策，諸如禁說族語、強推漢名等，侵害了原住民族集體權利，涉及國際人權公約所規範的基本人權，包含教育文化、社會經濟發展等權利。正因原住民族與平地漢人有不一樣的受迫害面貌，使得原住民族的轉型正義具有獨特性。</p>
                <p><strong>廣播：</strong>原住民族政治案件在不同年代有不同型態。</p>
                <p><strong>Q2：</strong>原住民的政治案件有哪些？有什麼特殊性嗎？</p>
                <p><strong>A2：</strong>第一階段從二二八事件到1950年代，匪案從國共對抗背景中產生，如林瑞昌、高一生等案例，導致一代原住民菁英的流失與國家暴力下的集體噤聲。第二階段為1960至1970年代，延續匪案脈絡、舊案重製，例如泰雅族臺中師範畢業生 Taru Pehuw（邱致明）案，1964至1972年間遭偵辦。同期，爭取原住民權益之路剛萌芽，發聲的青年受到情治單位嚴密的監控，而產生不少政治案件，其中以1974年臺灣山地獨立案最為代表，當時在臺北活動的原住民族知識青年幾乎都受到牽連。第三階段為1980年代之後，1984年臺灣原住民權利促進會正式成立，成立大會上通過以「原住民」取代過去「山胞」的稱呼，強調「我們是原來就住在台灣的民族」；這類原運的主張與行動被視為對政權的威脅，必須強加監控與壓制，也被刻意宣傳成「共匪」與「臺獨」組織，製造社會的恐懼與部落的排斥。</p>
                <p><strong>廣播：</strong>威權政府對於原住民族的集體性迫害還有兩種不同的樣態。</p>
                <p><strong>Q3：</strong>原住民在威權時期受到什麼樣的集體性迫害？</p>
                <p><strong>A3：</strong>以威權政府對阿里山鄒族管控為例，情治單位並未因湯守仁、高一生等鄒族菁英被處刑而停止政治偵防。案發後，受難當事人的家屬，如湯守仁兒子湯進賢、高一生長女高菊花，長期受到監控；又如第一節車廂介紹的杜孝生，他在出獄後因備受族人排斥質疑，再加上情治人員持續的監視和騷擾，最終選擇帶家人離開嘉義縣阿里山鄉的部落。受難者與其子輩常因此中斷了與部落的連結，導致文化與身份認同的雙重困境，而使得政治創傷具有代間傳承的特質。</p>
                <p>1952年臺灣警備總司令部蘭嶼指揮部設立，至1992年裁撤，歷經40年集體權利侵害，例如祖靈地國有化、傳統漁獵場域限制、傳統家屋拆遷與國宅（沙宅案）、以及後來的核廢料貯存場興建等，在威權體制下由軍警情治執行的這些作為，侵害原住民族文化權與財產權，屬轉型正義研究中尚未充分揭露的面向。</p>
                <p><strong>廣播：</strong>是否能夠平復國家過去對整體原住民族造成的持續性傷害與權利剝奪，進而有能力建構一個更具族群平等精神的社會，不只是中央原住民事務主管機關的事。</p>
                <p><strong>Q4：</strong>促轉會在推動原住民轉型正義上做了哪些努力？</p>
                <p><strong>A4：</strong>除了持續平復司法不法與行政不法的相關案件之外，並協助原住民政治案件受難者布農族 Avali Islituan（伍保忠）移靈歸鄉，邁出族群和解的第一步；此外，透過培力原住民部落自組調查人才及研發原住民族轉型正義教材研究，期望建立以部落為場域的「原住民族轉型正義永續教育」；並以照顧作為媒介，創造療癒機會，提供原住民族政治受難者或家屬據點及密集照顧服務。</p>
                <p>原住民族遭受的各類型權利侵害，尤其是發端於日治時期的理藩政策，及戰後為威權政府所援引的山地政策，往往涉及原住民族傳統領域、文化存續與發展等權利，尚有許多面向為現行促轉條例法定職權所不及之處。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar2Orc" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar2Orc"></div>
          </div>
          <button id="popupCar2OrcClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂2 政治檔案開放（文件2 觸發內容，單頁） -->
      <div id="popupCar2Doc2" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar2Doc2">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar2Doc2">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">政治檔案開放</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="車廂2物件/文件2.png" alt="政治檔案開放圖像" />
                  <span>圖說：政治檔案開放</span>
                </div>
                <p class="popup-broadcast"><strong>廣播：</strong>現在，在您左手邊的是促轉會針對開放政治檔案上所做的努力。</p>
                <p><strong>廣播：</strong>經認定為政治檔案後，由檔案管理局進行檔案徵集、整理、保存及開放應用。這對於威權統治時期真相與責任的釐清，會有相當大的助益。</p>
                <p><strong>Q1：</strong>什麼是政治檔案？</p>
                <p><strong>A1：</strong>《政治檔案條例》將政治檔案定義為：「政府機關（構）、政黨、附隨組織及黨營機構所保管，自中華民國三十四年八月十五日起至八十一年十一月六日止，與二二八事件、動員戡亂體制、戒嚴體制相關之檔案或各類紀錄及文件；已裁撤機關（構）之檔案亦適用之。」</p>
                <p><strong>廣播：</strong>由於政治檔案與動員戡亂、戒嚴體制等很有關係，因此，威權統治時期的政府機關，大多與此有涉。</p>
                <p><strong>Q2：</strong>哪些機關會有政治檔案？</p>
                <p><strong>A2：</strong>像是國安局、國防部（當中又包含下屬單位像是政治作戰局、軍事情報局、憲兵指揮部等等）、調查局及警政署這些重要的情治警政機關，就會有相關檔案，而外交部、教育部因為涉及海外與校園監控的關係，也可能留有紀錄。依據政治檔案條例，在認定為政治檔案後，須移歸檔案局。又例如威權時期下萬年國會與軍事審判體制之形成，與大法官釋憲有相當大的關聯，而這些大法官的會議紀錄與檔案則是司法院的管轄範圍，依法司法院也必須將這類檔案移歸到檔案局。另外，由於威權統治時代是由國民黨以黨領政，因此國民黨檔案也相當重要。目前經過促轉會依法審定後，已有部分國民黨檔案移歸為國家檔案，但仍還有一些檔案沒有移歸。</p>
                <p><strong>廣播：</strong>陳林兩案的調查工作，即使經過協調仍受國家情報工作法的限制，使部分內容遭到遮掩。</p>
                <p><strong>Q3：</strong>徵集政治檔案的困難在於？</p>
                <p><strong>A3：</strong>部分政府機關曾以「機密」方式保存所管有之政治檔案，許多真相因而無法為外界了解。例如國安局的檔案中有關林義雄宅血案及陳文成案的檔案為例，皆曾被列為永久保密，而未能移轉檔案局。</p>
                <p><strong>廣播：</strong>臺灣威權統治時期所保留的政治檔案完整度為新興民主國家少有，但過去政府並未投注資源進行系統性整理，故促轉會建置「臺灣轉型正義資料庫」，奠定深化討論威權體制及轉型正義的基礎。</p>
                <p><strong>Q4：</strong>政治檔案的運用有哪些成果呢？</p>
                <p><strong>A4：</strong>資料庫以政治受裁判者為主體，整合政府依據補償條例發放補償金作業所累積的受裁判資料、二二八條例賠償資料、國防部身分簿與《戒嚴時期叛亂暨匪諜審判案件名冊》、受損權利回復條例賠償資料，及促轉會刑事有罪判決撤銷公告名單等政治案件當事人相關名單，經過爬梳比對，進行資料編碼及建檔作業。資料庫至2021年2月已收錄13,683人次之受裁判者資料，可提供資料分析功能，透過操作簡易、瀏覽便利之界面，促進政治檔案的近用性。另外促轉會邀請相關學者解讀檔案，出版相關的研究成果，希望對於日後轉型正義與民主發展有所助益。透過學者們的抽絲剝繭，有助於我們理解大法官在威權統治時期所扮演的角色，並且更立體地掌握政府機關不同部門的交互影響。更重要的是，我們將得以檢視與反省威權體制如何介入大法官解釋，共同思考大法官的歷史座標。同時將改寫臺灣憲法學與法律史研究，成為未來研究者入門的參考。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar2Doc2" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar2Doc2"></div>
          </div>
          <button id="popupCar2Doc2Close" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂2 權利回復（文件3 觸發內容，單頁） -->
      <div id="popupCar2Doc3" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar2Doc3">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar2Doc3">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">權利回復</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="車廂2物件/文件3.png" alt="權利回復圖像" />
                  <span>圖說：權利回復</span>
                </div>
                <p class="popup-broadcast"><strong>廣播：</strong>最後，我們將駛離威權政府的不法侵害，來到權利回復的階段。</p>
                <p><strong>廣播：</strong>過去立法院已分別針對二二八事件之被害者及白色恐怖之被害者訂定《二二八事件處理及補償條例》（後更名為《二二八事件處理及賠償條例》，象徵國家承認國家行使公權力不法侵害人民權利，而對於二二八事件受難者予以賠償）、《戒嚴時期人民受損權利回復條例》及《戒嚴時期不當叛亂暨匪諜審判案件補償條例》。</p>
                <p><strong>Q1：</strong>現行機制的不足之處在於？</p>
                <p><strong>A1：</strong>除了《二二八事件處理及賠償條例》之外，其餘的法律未能以國家立場承認威權統治時期「國家不法侵害人民權利」的事實，大多數政治受難者或其家屬，雖可獲得一定程度的金錢給付，但在犯罪者標籤未撕的情況下獲得賠（補）償，不僅未能撫平被害者或其家屬之創傷，反而帶給申請的受難者被迫沉默之屈辱感。</p>
                <p><strong>廣播：</strong>促轉會研擬被害者權利回復條例草案，以「先平復國家不法，再行權利回復」概念規劃。</p>
                <p><strong>Q2：</strong>未來的展望為何？權利回復的範圍包含哪些？</p>
                <p><strong>A2：</strong>回復之權利範圍分為兩部分：一為生命、身體、人身自由、健康損害等賠償及名譽之回復，二為沒收財產之權利回復，並規劃於行政院下設「威權統治時期國家不法行為被害者權利回復基金會」（簡稱權利回復基金會），執掌這些業務。</p>
                <p><strong>廣播：</strong>草案中對於賠償對象與賠償金計算方式皆有明確規範。</p>
                <p><strong>Q3：</strong>賠償對象與賠償金如何計算？</p>
                <p><strong>A3：</strong>本草案中，賠償對象是依促轉條例認定為不法之國家行為下之被害者。施行前已依既有三部法律受領賠（補）償之被害者，如果按本草案之標準計算，可獲得較過去為高之賠償金，將按其差額給付補足賠償金，讓被害者或其家屬能依新標準獲得應有的賠償。</p>
                <p><strong>廣播：</strong>沒收財產之權利回復是另一大重點，以返還原物為原則。</p>
                <p><strong>Q4：</strong>沒收財產如何權利回復？</p>
                <p><strong>A4：</strong>在沒收財產權利回復之部分，以返還原物為原則，金錢賠償為例外。若原物已不存在或無法返還時，必須設計以金錢賠償的替代性措施，使被害者或其家屬得以實質回復其權利。權利回復基金會將負責審定、賠償金發放及沒收財產返還等相關業務，落實「先平復國家不法，再行權利回復」之目標。</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar2Doc3" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar2Doc3"></div>
          </div>
          <button id="popupCar2Doc3Close" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂2 行政不法（文件4 觸發內容，單頁） -->
      <div id="popupCar2Doc4" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar2Doc4">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar2Doc4">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">行政不法</h3>
              <div class="popup-body">
                <div class="popup-figure popup-figure--crop">
                  <img src="車廂2物件/文件4.png" alt="行政不法圖像" />
                  <span>圖說：行政不法</span>
                </div>
                <p class="popup-broadcast"><strong>廣播：</strong>我們在前面提到檔案開放，開放後發現威權政府的許多行為是違反法治的，除了軍事長官的手伸進司法左右判決，還有許多雖然沒有「有罪判決」，還是遭到國家不法對待的情形──這些情形，我們稱之為「行政不法」。行政不法是指為了鞏固威權統治，政府機關或其公務人員在執行公務時，所做的處分或事實行為發生了侵害人民權利或利益的結果。</p>
                <p><strong>廣播：</strong>這些行為，都是威權政府為鞏固統治所為。</p>
                <p><strong>Q1：</strong>威權時期的行政不法有哪些樣貌？</p>
                <p><strong>A1：</strong>像是被害者於二二八期間遭軍人射殺擊斃，或是被害者被判無罪後，不僅沒被釋放，反而被送往感訓。到了民國70年代，仍發生有黨外雜誌社遭臺灣警備總司令部以「淆亂視聽足以影響民心士氣」、「挑撥政府與人民情感」這兩項理由，扣押千本出版物的情況。</p>
                <p><strong>廣播：</strong>另外，促轉會也同步提出「威權統治時期國家不法行為被害者權利回復條例草案」，此案若通過後，被害者或其家屬即能依此條例向國家請求賠償。</p>
                <p><strong>Q2：</strong>面對這些行政不法將如何處置呢？</p>
                <p><strong>A2：</strong>現行的《促進轉型正義條例》僅規範到平復司法不法，只能撤銷法院或軍事審判機關所做的「刑事有罪判決」，因此促轉會於2021年5月向行政院提出「促轉條例部分條文修正草案」，其中增訂平復「行政不法」之要件：「威權統治時期，政府機關或其執行職務之公務員為達成鞏固威權統治之目的，違反自由民主憲政秩序，所為侵害人民生命、身體、人身自由，或剝奪其所有權之處分或事實行為，促轉會依職權或申請確認不法，藉以平復行政不法。」</p>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar2Doc4" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar2Doc4"></div>
          </div>
          <button id="popupCar2Doc4Close" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂3 車窗與威權象徵處置影片 -->
      <div id="popupCar3Window" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar3Window">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar3Window">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">威權象徵的處置</h3>
              <div class="popup-body">
                <video
                  id="videoCar3Window"
                  controls
                  playsinline
                  preload="metadata"
                  style="width: 100%; max-height: 360px; margin-top: 12px; border-radius: 12px; background: #000;"
                  poster="車廂3物件/車窗.png"
                >
                  <source src="車廂3物件/威權象徵處置.mp4" type="video/mp4" />
                  您的瀏覽器不支援 HTML5 影片。
                </video>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar3Window" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar3Window"></div>
          </div>
          <button id="popupCar3WindowClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂3 車窗與不當黨產影片 -->
      <div id="popupCar3Window2" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar3Window2">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar3Window2">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">不當黨產的規劃應用</h3>
              <div class="popup-body">
                <video
                  id="videoCar3Window2"
                  controls
                  playsinline
                  preload="metadata"
                  style="width: 100%; max-height: 360px; margin-top: 12px; border-radius: 12px; background: #000;"
                  poster="車廂3物件/車窗.png"
                >
                  <source src="車廂3物件/不當黨產的規劃應用.mp4" type="video/mp4" />
                  您的瀏覽器不支援 HTML5 影片。
                </video>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar3Window2" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar3Window2"></div>
          </div>
          <button id="popupCar3Window2Close" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂3 車窗與「創傷修復」影片 -->
      <div id="popupCar3Window3" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar3Window3">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar3Window3">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">創傷修復</h3>
              <div class="popup-body">
                <video
                  id="videoCar3Window3"
                  controls
                  playsinline
                  preload="metadata"
                  style="width: 100%; max-height: 360px; margin-top: 12px; border-radius: 12px; background: #000;"
                  poster="車廂3物件/車窗.png"
                >
                  <source src="車廂3物件/創傷修復.mp4" type="video/mp4" />
                  您的瀏覽器不支援 HTML5 影片。
                </video>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar3Window3" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar3Window3"></div>
          </div>
          <button id="popupCar3Window3Close" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂3 車門與「已抵達：民主站」影片 -->
      <div id="popupCar3Door" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar3Door">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar3Door">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">已抵達：民主站</h3>
              <div class="popup-body">
                <video
                  id="videoCar3Door"
                  controls
                  playsinline
                  preload="metadata"
                  style="width: 100%; max-height: 360px; margin-top: 12px; border-radius: 12px; background: #000;"
                  poster="車廂3物件/車門.png"
                >
                  <source src="車廂3物件/已抵達：民主站.mp4" type="video/mp4" />
                  您的瀏覽器不支援 HTML5 影片。
                </video>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar3Door" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar3Door"></div>
          </div>
          <button id="popupCar3DoorClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Popup: 車廂3 餐車－分享本遊戲 -->
      <div id="popupCar3Cart" class="popup-overlay hidden">
        <div class="bottom-sheet" id="bottomSheetCar3Cart">
          <div class="bottom-sheet-scroll" id="bottomSheetScrollCar3Cart">
            <div class="drag-handle" aria-hidden="true"></div>
            <div class="popup-content">
              <h3 class="popup-title">分享本遊戲</h3>
              <div class="popup-body">
                <p>
                  喜歡這款遊戲嗎？<br />
                  把這班「民主列車」分享給更多人，<br />
                  讓更多人看見這些不該被遺忘的故事。
                </p>
                <p style="margin-top: 12px; word-break: break-all;">
                  <strong>遊戲連結：</strong>
                  <span id="car3CartShareUrl"></span>
                </p>
                <button id="car3CartCopyButton" class="primary-button" type="button">
                  複製遊戲連結
                </button>
              </div>
            </div>
          </div>
          <div class="scroll-progress-wrap" id="scrollProgressCar3Cart" aria-label="閱讀進度">
            <div class="scroll-progress-bar" id="scrollProgressBarCar3Cart"></div>
          </div>
          <button id="popupCar3CartClose" class="popup-close" aria-label="關閉">✕</button>
        </div>
      </div>

      <!-- Direction controls: 圓形滑桿 + 小型方向鍵指示 -->
      <div class="controls" id="controls">
        <div class="joystick-area" id="joystickArea" aria-label="方向控制區域">
          <div class="joystick-knob" id="joystickKnob"></div>
          <div class="joystick-arrow joystick-arrow-up">
            <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
              <polygon points="12,6 18,18 6,18" fill="currentColor" />
            </svg>
          </div>
          <div class="joystick-arrow joystick-arrow-left">
            <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
              <polygon points="6,12 18,6 18,18" fill="currentColor" />
            </svg>
          </div>
          <div class="joystick-arrow joystick-arrow-right">
            <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
              <polygon points="6,6 6,18 18,12" fill="currentColor" />
            </svg>
          </div>
          <div class="joystick-arrow joystick-arrow-down">
            <svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
              <polygon points="6,6 18,6 12,18" fill="currentColor" />
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Experience start overlay -->
  <!-- 一開始先隱藏，之後依流程顯示 -->
  <div class="start-overlay hidden" id="startOverlay">
    <div class="start-card" id="startCard">
      <h1>島嶼候車室－開往民主的轉型正義列車</h1>
      <p>點擊下方按鈕開始體驗這段關於轉型正義、記憶與前行的車站旅程。</p>
      <div class="character-pick">
        <p class="character-pick-label">選擇角色</p>
        <div class="character-options">
          <button type="button" class="character-option selected" data-character="player" aria-pressed="true" title="角色一">
            <img src="characters/player_down.png" alt="角色一" />
          </button>
          <button type="button" class="character-option" data-character="player2" aria-pressed="false" title="角色二">
            <img src="characters/player2_down.png" alt="角色二" />
          </button>
        </div>
      </div>
      <button class="start-button" id="startButton">開始體驗</button>
    </div>
  </div>

  <!-- DEBUG 按鈕與座標面板 -->
  <button type="button" class="debug-btn" id="debugBtn" aria-label="DEBUG 座標">DEBUG</button>
  <div class="debug-panel hidden" id="debugPanel">
    <div id="debugPanelText"></div>
    <button type="button" class="debug-copy-btn" id="debugCopyBtn">複製座標</button>
  </div>

  <!-- 右側漢堡選單按鈕（桌機與手機皆顯示，可看成就） -->
  <button type="button" class="help-button-desktop" id="helpButton" aria-label="選單">☰</button>
  <div class="help-overlay hidden" id="helpOverlay">
    <div class="menu-backdrop" id="menuBackdrop"></div>
    <div class="menu-panel" id="menuPanel" data-active="achievement">
      <div class="menu-panel-header">
        <h2 class="menu-panel-title">選單</h2>
        <button type="button" class="menu-close" id="helpClose" aria-label="關閉">✕</button>
      </div>
      <div class="menu-tabs">
        <button type="button" class="menu-tab active" data-tab="achievement">成就</button>
        <button type="button" class="menu-tab" data-tab="about">關於本專案</button>
      </div>
      <div class="menu-tab-content" data-tab="achievement">
        <div class="achievement-grid" id="achievementGrid">
          <div class="achievement-item" data-id="zhou" data-name="周清月記者證">
            <img class="achievement-img" src="車廂1物件/周清月無人.png" alt="周清月" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">周清月記者證</span>
          </div>
          <div class="achievement-item" data-id="huang" data-name="黃家母女">
            <img class="achievement-img" src="車廂1物件/黃家母女無人.png" alt="黃家母女" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">黃家母女</span>
          </div>
          <div class="achievement-item" data-id="du" data-name="杜孝生">
            <img class="achievement-img" src="車廂1物件/杜孝生無人.png" alt="杜孝生" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">杜孝生</span>
          </div>
          <div class="achievement-item" data-id="liu" data-name="劉永祥">
            <img class="achievement-img" src="車廂1物件/劉永祥無人.png" alt="劉永祥" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">劉永祥</span>
          </div>
          <div class="achievement-item" data-id="yang" data-name="陽翰情報報告">
            <img class="achievement-img" src="車廂1物件/陽翰無人.png" alt="陽翰" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">陽翰情報報告</span>
          </div>
          <div class="achievement-item" data-id="wang" data-name="王再傳的黨員手冊">
            <img class="achievement-img" src="車廂1物件/王再傳無人.png" alt="王再傳" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">王再傳的黨員手冊</span>
          </div>
          <div class="achievement-item" data-id="xu" data-name="許宗力">
            <img class="achievement-img" src="車廂1物件/許宗力無人.png" alt="許宗力" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">許宗力</span>
          </div>
          <div class="achievement-item" data-id="zhugong" data-name="新竹高工塗鴉">
            <img class="achievement-img" src="車廂1物件/竹工無人.png" alt="竹工" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">新竹高工塗鴉</span>
          </div>
          <div class="achievement-item" data-id="bento" data-name="便當攤">
            <img class="achievement-img" src="月台區物件/便當攤.png" alt="便當攤" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">便當攤</span>
          </div>
          <div class="achievement-item" data-id="toilet" data-name="廁所">
            <img class="achievement-img" src="月台區物件/廁所.png" alt="廁所" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">廁所</span>
          </div>
          <div class="achievement-item" data-id="ticket" data-name="售票機">
            <img class="achievement-img" src="月台區物件/售票機.png" alt="售票機" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">售票機</span>
          </div>
          <div class="achievement-item" data-id="bookshelf" data-name="書架">
            <img class="achievement-img" src="月台區物件/書架.png" alt="書架" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">書架</span>
          </div>
          <div class="achievement-item" data-id="notice" data-name="告示">
            <img class="achievement-img" src="月台區物件/告示.png" alt="告示" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">告示</span>
          </div>
          <div class="achievement-item" data-id="shinonggongshang" data-name="士農工商">
            <img class="achievement-img" src="月台區物件/士農工商.png" alt="士農工商" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">士農工商</span>
          </div>
          <div class="achievement-item" data-id="stationSign" data-name="站名牌">
            <img class="achievement-img" src="月台區物件/站名牌.png" alt="站名牌" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">站名牌</span>
          </div>
          <div class="achievement-item" data-id="electronicBoardLeft" data-name="電子看板左">
            <img class="achievement-img" src="月台區物件/電子看板左.png" alt="電子看板左" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">電子看板左</span>
          </div>
          <div class="achievement-item" data-id="electronicBoardRight" data-name="電子看板右">
            <img class="achievement-img" src="月台區物件/電子看板右.png" alt="電子看板右" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">電子看板右</span>
          </div>
          <div class="achievement-item" data-id="car2Orc" data-name="原住民轉型正義">
            <img class="achievement-img" src="車廂2物件/文件1.png" alt="原住民轉型正義" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">原住民轉型正義</span>
          </div>
          <div class="achievement-item" data-id="car2Doc2" data-name="政治檔案開放">
            <img class="achievement-img" src="車廂2物件/文件2.png" alt="政治檔案開放" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">政治檔案開放</span>
          </div>
          <div class="achievement-item" data-id="car2Doc3" data-name="權利回復">
            <img class="achievement-img" src="車廂2物件/文件3.png" alt="權利回復" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">權利回復</span>
          </div>
          <div class="achievement-item" data-id="car2Doc4" data-name="行政不法">
            <img class="achievement-img" src="車廂2物件/文件4.png" alt="行政不法" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">行政不法</span>
          </div>
          <div class="achievement-item" data-id="car3Window" data-name="威權象徵的處置">
            <img class="achievement-img" src="車廂3物件/車窗.png" alt="威權象徵的處置" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">威權象徵的處置</span>
          </div>
          <div class="achievement-item" data-id="car3Window2" data-name="不當黨產的規劃應用">
            <img class="achievement-img" src="車廂3物件/車窗.png" alt="不當黨產" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">不當黨產的規劃應用</span>
          </div>
          <div class="achievement-item" data-id="car3Window3" data-name="創傷修復">
            <img class="achievement-img" src="車廂3物件/車窗.png" alt="創傷修復" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">創傷修復</span>
          </div>
          <div class="achievement-item" data-id="car3Door" data-name="已抵達民主站">
            <img class="achievement-img" src="車廂3物件/車門.png" alt="已抵達民主站" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">已抵達：民主站</span>
          </div>
          <div class="achievement-item" data-id="car3Cart" data-name="分享本遊戲">
            <img class="achievement-img" src="車廂3物件/餐車.png" alt="分享本遊戲" />
            <span class="achievement-placeholder">?</span>
            <span class="achievement-name">分享本遊戲</span>
          </div>
        </div>
        <div class="achievement-progress-wrap">
          <div class="achievement-progress-label" id="achievementProgressLabel">已互動 0 / 27</div>
          <div class="achievement-progress-bar">
            <div class="achievement-progress-fill" id="achievementProgressFill"></div>
          </div>
        </div>
      </div>
      <div class="menu-tab-content" data-tab="about">
        <div class="help-content">
          <h3>關於本專案</h3>
          <h4>從 Gather Town 到網頁：延續島嶼的記憶</h4>
          <p>您現在看到的內容，完整復刻自 2021 年由促轉會委託開發的 Gather Town 互動展。這裡的每一段文字，皆改編自促轉會調查報告，並經過專業研究員的嚴謹撰寫與審閱。</p>
          <p>雖然促轉會已完成階段性任務解散，但我們相信這些故事值得被更多人看見。因此，我們將其轉製為網頁版，讓這張「民主快車」的車票，能繼續遞交到每一位島民的手中。</p>
          <hr>
          <h4>版權與內容說明</h4>
          <p>本網站內容復刻自 2021 年「島嶼候車室」 Gather Town 互動展區。所有資訊皆改編自促進轉型正義委員會（下稱促轉會）之調查報告，並由原促轉會研究員參與撰寫與審閱。</p>
          <p>在促轉會解散後，由 Relanding Design 號召原始參與人員，自費進行網頁版轉置與數位保存，旨在延續轉型正義社會溝通與教育意義，確保歷史記憶與調查成果不因平台更迭而消失。</p>
          <hr>
          <h4>Credit</h4>
          <p><strong>展場總策畫：</strong><a href="https://www.relanding.design/" target="_blank" rel="noopener noreferrer">Relanding Design</a></p>
          <p><strong>視覺設計：</strong><span>曾元濃</span></p>
          <p><strong>網站架設：</strong><a href="https://eclectic-babka-772a72.netlify.app/" target="_blank" rel="noopener noreferrer">陳冠宏</a></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const popup = document.getElementById('popup');
    const popupClose = document.getElementById('popupClose');
    const popupContent = document.querySelector('.popup-content');
    const bottomSheet = document.querySelector('.bottom-sheet');
    const popupHuang = document.getElementById('popupHuang');
    const popupHuangClose = document.getElementById('popupHuangClose');
    const bottomSheetHuang = popupHuang ? popupHuang.querySelector('.bottom-sheet') : null;
    const popupDu = document.getElementById('popupDu');
    const popupDuClose = document.getElementById('popupDuClose');
    const bottomSheetDu = popupDu ? popupDu.querySelector('.bottom-sheet') : null;
    const popupLiu = document.getElementById('popupLiu');
    const popupLiuClose = document.getElementById('popupLiuClose');
    const bottomSheetLiu = popupLiu ? popupLiu.querySelector('.bottom-sheet') : null;
    const popupYang = document.getElementById('popupYang');
    const popupYangClose = document.getElementById('popupYangClose');
    const bottomSheetYang = popupYang ? popupYang.querySelector('.bottom-sheet') : null;
    const popupWang = document.getElementById('popupWang');
    const popupWangClose = document.getElementById('popupWangClose');
    const bottomSheetWang = popupWang ? popupWang.querySelector('.bottom-sheet') : null;
    const popupXu = document.getElementById('popupXu');
    const popupXuClose = document.getElementById('popupXuClose');
    const bottomSheetXu = popupXu ? popupXu.querySelector('.bottom-sheet') : null;
    const popupZhugong = document.getElementById('popupZhugong');
    const popupZhugongClose = document.getElementById('popupZhugongClose');
    const bottomSheetZhugong = popupZhugong ? popupZhugong.querySelector('.bottom-sheet') : null;
    const popupBento = document.getElementById('popupBento');
    const popupBentoClose = document.getElementById('popupBentoClose');
    const bottomSheetBento = popupBento ? popupBento.querySelector('.bottom-sheet') : null;
    const popupToilet = document.getElementById('popupToilet');
    const popupToiletClose = document.getElementById('popupToiletClose');
    const bottomSheetToilet = popupToilet ? popupToilet.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollToilet = popupToilet ? popupToilet.querySelector('.bottom-sheet-scroll') : null;
    const popupTicket = document.getElementById('popupTicket');
    const popupTicketClose = document.getElementById('popupTicketClose');
    const bottomSheetTicket = popupTicket ? popupTicket.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollTicket = popupTicket ? popupTicket.querySelector('.bottom-sheet-scroll') : null;
    const popupBookshelf = document.getElementById('popupBookshelf');
    const popupBookshelfClose = document.getElementById('popupBookshelfClose');
    const bottomSheetBookshelf = popupBookshelf ? popupBookshelf.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollBookshelf = popupBookshelf ? popupBookshelf.querySelector('.bottom-sheet-scroll') : null;
    const popupNotice = document.getElementById('popupNotice');
    const popupNoticeClose = document.getElementById('popupNoticeClose');
    const bottomSheetNotice = popupNotice ? popupNotice.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollNotice = popupNotice ? popupNotice.querySelector('.bottom-sheet-scroll') : null;
    const popupShinonggongshang = document.getElementById('popupShinonggongshang');
    const popupShinonggongshangClose = document.getElementById('popupShinonggongshangClose');
    const bottomSheetShinonggongshang = popupShinonggongshang ? popupShinonggongshang.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollShinonggongshang = popupShinonggongshang ? popupShinonggongshang.querySelector('.bottom-sheet-scroll') : null;
    const popupStationSign = document.getElementById('popupStationSign');
    const popupStationSignClose = document.getElementById('popupStationSignClose');
    const bottomSheetStationSign = popupStationSign ? popupStationSign.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollStationSign = popupStationSign ? popupStationSign.querySelector('.bottom-sheet-scroll') : null;
    const popupElectronicBoardLeft = document.getElementById('popupElectronicBoardLeft');
    const popupElectronicBoardLeftClose = document.getElementById('popupElectronicBoardLeftClose');
    const bottomSheetElectronicBoardLeft = popupElectronicBoardLeft ? popupElectronicBoardLeft.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollElectronicBoardLeft = popupElectronicBoardLeft ? popupElectronicBoardLeft.querySelector('.bottom-sheet-scroll') : null;
    const popupElectronicBoardRight = document.getElementById('popupElectronicBoardRight');
    const popupElectronicBoardRightClose = document.getElementById('popupElectronicBoardRightClose');
    const bottomSheetElectronicBoardRight = popupElectronicBoardRight ? popupElectronicBoardRight.querySelector('.bottom-sheet') : null;
    const bottomSheetScrollElectronicBoardRight = popupElectronicBoardRight ? popupElectronicBoardRight.querySelector('.bottom-sheet-scroll') : null;
    const popupCar2Orc = document.getElementById('popupCar2Orc');
    const popupCar2OrcClose = document.getElementById('popupCar2OrcClose');
    const bottomSheetCar2Orc = popupCar2Orc ? popupCar2Orc.querySelector('.bottom-sheet') : null;
    const popupCar2Doc2 = document.getElementById('popupCar2Doc2');
    const popupCar2Doc2Close = document.getElementById('popupCar2Doc2Close');
    const bottomSheetCar2Doc2 = popupCar2Doc2 ? popupCar2Doc2.querySelector('.bottom-sheet') : null;
    const popupCar2Doc3 = document.getElementById('popupCar2Doc3');
    const popupCar2Doc3Close = document.getElementById('popupCar2Doc3Close');
    const bottomSheetCar2Doc3 = popupCar2Doc3 ? popupCar2Doc3.querySelector('.bottom-sheet') : null;
    const popupCar2Doc4 = document.getElementById('popupCar2Doc4');
    const popupCar2Doc4Close = document.getElementById('popupCar2Doc4Close');
    const bottomSheetCar2Doc4 = popupCar2Doc4 ? popupCar2Doc4.querySelector('.bottom-sheet') : null;
    const popupCar3Window = document.getElementById('popupCar3Window');
    const popupCar3WindowClose = document.getElementById('popupCar3WindowClose');
    const bottomSheetCar3Window = popupCar3Window ? popupCar3Window.querySelector('.bottom-sheet') : null;
    const videoCar3Window = document.getElementById('videoCar3Window');
    const popupCar3Window2 = document.getElementById('popupCar3Window2');
    const popupCar3Window2Close = document.getElementById('popupCar3Window2Close');
    const bottomSheetCar3Window2 = popupCar3Window2 ? popupCar3Window2.querySelector('.bottom-sheet') : null;
    const videoCar3Window2 = document.getElementById('videoCar3Window2');
    const popupCar3Window3 = document.getElementById('popupCar3Window3');
    const popupCar3Window3Close = document.getElementById('popupCar3Window3Close');
    const bottomSheetCar3Window3 = popupCar3Window3 ? popupCar3Window3.querySelector('.bottom-sheet') : null;
    const videoCar3Window3 = document.getElementById('videoCar3Window3');
    const popupCar3Door = document.getElementById('popupCar3Door');
    const popupCar3DoorClose = document.getElementById('popupCar3DoorClose');
    const bottomSheetCar3Door = popupCar3Door ? popupCar3Door.querySelector('.bottom-sheet') : null;
    const videoCar3Door = document.getElementById('videoCar3Door');
    const popupCar3Cart = document.getElementById('popupCar3Cart');
    const popupCar3CartClose = document.getElementById('popupCar3CartClose');
    const bottomSheetCar3Cart = popupCar3Cart ? popupCar3Cart.querySelector('.bottom-sheet') : null;
    const car3CartShareUrl = document.getElementById('car3CartShareUrl');
    const car3CartCopyButton = document.getElementById('car3CartCopyButton');
    var gameState = { inputLocked: false };
    const helpButton = document.getElementById('helpButton');
    const helpOverlay = document.getElementById('helpOverlay');
    const helpClose = document.getElementById('helpClose');
    const menuPanel = document.getElementById('menuPanel');
    const menuBackdrop = document.getElementById('menuBackdrop');
    const achievementGrid = document.getElementById('achievementGrid');
    const achievementProgressLabel = document.getElementById('achievementProgressLabel');
    const achievementProgressFill = document.getElementById('achievementProgressFill');

    // 成就系統：可互動物件 id 與 localStorage
    const ACHIEVEMENT_IDS = ['zhou', 'huang', 'du', 'liu', 'yang', 'wang', 'xu', 'zhugong', 'bento', 'toilet', 'ticket', 'bookshelf', 'notice', 'shinonggongshang', 'stationSign', 'electronicBoardLeft', 'electronicBoardRight', 'car2Orc', 'car2Doc2', 'car2Doc3', 'car2Doc4', 'car3Window', 'car3Window2', 'car3Window3', 'car3Door', 'car3Cart'];
    const ACHIEVEMENT_STORAGE_KEY = 'train_achievements';
    function getAchievementState() {
      try {
        var raw = localStorage.getItem(ACHIEVEMENT_STORAGE_KEY);
        if (raw) {
          var o = JSON.parse(raw);
          var out = {};
          ACHIEVEMENT_IDS.forEach(function (id) { out[id] = !!o[id]; });
          return out;
        }
      } catch (e) {}
      return ACHIEVEMENT_IDS.reduce(function (acc, id) { acc[id] = false; return acc; }, {});
    }
    var achievementState = getAchievementState();
    function saveAchievementState() {
      try {
        localStorage.setItem(ACHIEVEMENT_STORAGE_KEY, JSON.stringify(achievementState));
      } catch (e) {}
    }
    function achievementUnlock(id) {
      if (!achievementState[id]) {
        achievementState[id] = true;
        saveAchievementState();
        if (achievementGrid) updateAchievementUI();
      }
    }
    function updateAchievementUI() {
      if (!achievementGrid) return;
      var items = achievementGrid.querySelectorAll('.achievement-item');
      items.forEach(function (el) {
        var id = el.getAttribute('data-id');
        if (achievementState[id]) el.classList.add('unlocked');
        else el.classList.remove('unlocked');
      });
      var count = ACHIEVEMENT_IDS.filter(function (id) { return achievementState[id]; }).length;
      var total = ACHIEVEMENT_IDS.length;
      var pct = total ? Math.round((count / total) * 100) : 0;
      if (achievementProgressLabel) achievementProgressLabel.textContent = '已互動 ' + count + ' / ' + total;
      if (achievementProgressFill) achievementProgressFill.style.width = pct + '%';
    }
    const startOverlay = document.getElementById('startOverlay');
    const startButton = document.getElementById('startButton');
    const debugBtn = document.getElementById('debugBtn');
    const debugPanel = document.getElementById('debugPanel');
    const debugPanelText = document.getElementById('debugPanelText');
    const debugCopyBtn = document.getElementById('debugCopyBtn');

    // 正式上線設為 false 關閉 DEBUG；開發時改為 true 可顯示 DEBUG 按鈕與座標面板（程式碼保留不刪）
    var DEBUG_MODE = false;
    if (!DEBUG_MODE && debugBtn) { debugBtn.style.display = 'none'; }
    if (!DEBUG_MODE && debugPanel) { debugPanel.classList.add('hidden'); }

    // Logical game size; will be updated to match background image dimensions
    // World size (map) and view size (visible screen window in world coordinates)
    let WORLD_WIDTH = 1024;
    let WORLD_HEIGHT = 576;
    let VIEW_WIDTH = 1024;
    let VIEW_HEIGHT = 576;

    // Canvas 顯示尺寸與 scale（由 resizeCanvas 設定，供 draw 置中用）
    let canvasCssWidth = 0;
    let canvasCssHeight = 0;
    let dpr = 1;
    let currentScale = 1;
    const TILE_SIZE = 32; // grid size for tile-based movement
    const MOVE_SPEED = 240; // pixels per second (frame-independent for consistent speed)

    // 傳送點座標（依 col/row）：DEBUG 時以綠色方塊顯示
    const TRANSMISSION_ZONES = {
      platform: [
        { col1: 27, col2: 28, row1: 12, row2: 13 },   // 月台 車廂關 → 車廂開 (entrance / open door)
        { col1: 27, col2: 28, row1: 14, row2: 14 },   // 月台 車廂開 → 車廂關 (col 27-28, row 14)
        { col1: 51, col2: 51, row1: 10, row2: 11 }    // 月台 車廂開 → 車廂2
      ],
      platformClosedToCar2: [                          // 月台 車廂關 右側兩格 → 車廂2
        { col1: 50, col2: 50, row1: 10, row2: 11 },
        { col1: 51, col2: 51, row1: 10, row2: 11 }
      ],
      car2ToPlatformOpen: [                            // 車廂2 → 返回車廂一（月台 車廂開）col 22, row 10-11
        { col1: 22, col2: 22, row1: 10, row2: 11 }
      ],
      car2ToCar3: [                                    // 車廂2 → 車廂3 col 51, row 10-11
        { col1: 51, col2: 51, row1: 10, row2: 11 }
      ],
      car3ToCar2: [                                    // 車廂3 → 傳送回車廂2 col 22, row 10-11
        { col1: 22, col2: 22, row1: 10, row2: 11 }
      ]
    };
    const CAR2_SPAWN = { x: 757, y: 352 }; // 通往車廂2 的傳送出生點（col 23, row 11）
    const CAR3_SPAWN = { x: 757, y: 352 }; // 通往車廂3 的傳送出生點（col 23, row 11）
    const CAR2_SPAWN_FROM_CAR3 = { x: 1621, y: 352 }; // 從車廂3 回到車廂2 的出生點 x（col 50），y 保持當前 row
    const PLATFORM_OPEN_SPAWN_FROM_CAR2 = { x: 1612.8, y: 352 }; // 從車廂2 回到月台（車廂開）的出生點（col 50, row 11）

    // 三張地圖：月台（車廂關/車廂開同一張地圖只換圖）、車廂2、車廂3（底圖 + 前景，車廂3 僅底圖）
    const MAP_LIST = [
      { name: '月台', base: 'maps/月台底圖_車廂關.png', foreground: 'maps/月台前景_車廂關.png', mask: 'maps/月台底圖_車廂_mask.png' },
      { name: '車廂2', base: 'maps/車廂2底圖.png', foreground: 'maps/車廂2前景.png', mask: 'maps/車廂2底圖_mask.png' },
      { name: '車廂3', base: 'maps/車廂3底圖.png', foreground: null, mask: 'maps/車廂2底圖_mask.png' }
    ];
    let currentMapIndex = 0;
    let platformCarriageOpen = false; // 月台：車廂關(false) / 車廂開(true)
    const mapImages = MAP_LIST.map(m => ({
      base: new Image(),
      foreground: m.foreground ? new Image() : null,
      mask: new Image(),
      width: 0,
      height: 0
    }));
    // 月台「車廂開」用圖（同一張地圖，只換圖）
    mapImages[0].baseOpen = new Image();
    mapImages[0].baseOpen.src = 'maps/月台底圖_車廂開.png';
    mapImages[0].foregroundOpen = new Image();
    mapImages[0].foregroundOpen.src = 'maps/月台前景_車廂開.png';
    mapImages[0].maskOpen = new Image();
    mapImages[0].maskOpen.onload = () => {
      if (currentMapIndex === 0 && platformCarriageOpen && WORLD_WIDTH > 0 && WORLD_HEIGHT > 0) prepareCollisionMask();
    };
    mapImages[0].maskOpen.src = 'maps/月台底圖_車廂_mask.png';

    const maskCanvas = document.createElement('canvas');
    const maskCtx = maskCanvas.getContext('2d');
    const COLLISION_ENABLED = true; // 切換是否啟用禁止通行（false = 全地圖暫時可通行）
    let blockedTiles = []; // blockedTiles[row][col] === true => cannot walk

    function applyWorldSizeFromMap(index) {
      const m = mapImages[index];
      if (m.width > 0 && m.height > 0) {
        WORLD_WIDTH = m.width;
        WORLD_HEIGHT = m.height;
      }
    }

    function onFirstMapReady() {
      applyWorldSizeFromMap(0);
      const baseViewWidth = Math.min(WORLD_WIDTH, 1920);
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        const portraitAspect = 360 / 640;
        VIEW_HEIGHT = WORLD_HEIGHT;
        VIEW_WIDTH = Math.min(WORLD_WIDTH, Math.round(VIEW_HEIGHT * portraitAspect));
        VIEW_WIDTH = Math.max(VIEW_WIDTH, 10 * TILE_SIZE);
      } else {
        const desktopAspect = 2.1;
        const zoomFactor = 0.92;
        VIEW_WIDTH = baseViewWidth * zoomFactor;
        VIEW_HEIGHT = VIEW_WIDTH / desktopAspect;
      }
      updateLogicalPositions();
      resizeCanvas();
      prepareCollisionMask();
    }

    MAP_LIST.forEach((cfg, i) => {
      const m = mapImages[i];
      m.base.onload = () => {
        m.width = m.base.naturalWidth;
        m.height = m.base.naturalHeight;
        if (i === 0) onFirstMapReady();
      };
      m.base.src = cfg.base;
      if (m.foreground) m.foreground.src = cfg.foreground;
      m.mask.src = cfg.mask;
    });

    // 遮罩載入完成後，若當前地圖尺寸已知則建立碰撞
    MAP_LIST.forEach((cfg, i) => {
      mapImages[i].mask.onload = () => {
        if (currentMapIndex === i && WORLD_WIDTH > 0 && WORLD_HEIGHT > 0) prepareCollisionMask();
      };
    });

    // 周清月記者證：遠離時 周清月無人.png，靠近時 周清月.png
    const cardIdleImage = new Image();
    const cardActiveImage = new Image();
    cardIdleImage.src = '車廂1物件/周清月無人.png';
    cardActiveImage.src = '車廂1物件/周清月.png';

    // 黃家母女：遠離時 黃家母女無人.png，靠近時 黃家母女.png
    const huangIdleImage = new Image();
    const huangActiveImage = new Image();
    huangIdleImage.src = '車廂1物件/黃家母女無人.png';
    huangActiveImage.src = '車廂1物件/黃家母女.png';

    // 杜孝生：遠離時 杜孝生無人.png，靠近時 杜孝生.png
    const duIdleImage = new Image();
    const duActiveImage = new Image();
    duIdleImage.src = '車廂1物件/杜孝生無人.png';
    duActiveImage.src = '車廂1物件/杜孝生.png';

    // 劉永祥：遠離時 劉永祥無人.png，靠近時 劉永祥.png
    const liuIdleImage = new Image();
    const liuActiveImage = new Image();
    liuIdleImage.src = '車廂1物件/劉永祥無人.png';
    liuActiveImage.src = '車廂1物件/劉永祥.png';

    // 陽翰的情報報告：說明圖（遠離）陽翰無人.png，靠近圖 陽翰.png，觸發點 col 33 row 10
    const yangIdleImage = new Image();
    const yangActiveImage = new Image();
    yangIdleImage.src = '車廂1物件/陽翰無人.png';
    yangActiveImage.src = '車廂1物件/陽翰.png';

    // 王再傳的黨員手冊：說明圖 王再傳無人.png，靠近圖 王再傳.png，觸發點 col 43 row 10
    const wangIdleImage = new Image();
    const wangActiveImage = new Image();
    wangIdleImage.src = '車廂1物件/王再傳無人.png';
    wangActiveImage.src = '車廂1物件/王再傳.png';

    // 許宗力的海外學人回國服務登記表：說明圖 許宗力無人.png，靠近圖 許宗力.png，觸發點 col 49 row 10
    const xuIdleImage = new Image();
    const xuActiveImage = new Image();
    xuIdleImage.src = '車廂1物件/許宗力無人.png';
    xuActiveImage.src = '車廂1物件/許宗力.png';

    // 竹工（新竹高工的塗鴉）：說明圖 竹工無人.png，靠近圖 竹工.png，觸發範圍 col 45-46 row 10-11
    const zhugongIdleImage = new Image();
    const zhugongActiveImage = new Image();
    zhugongIdleImage.src = '車廂1物件/竹工無人.png';
    zhugongActiveImage.src = '車廂1物件/竹工.png';

    // 車廂3 標語2：col 24～49、row 17 橫跨
    const biaoyu2Image = new Image();
    biaoyu2Image.src = '車廂3物件/標語2.png';

    // 車廂3 站牌：放在玩家提供的位置 (carriage 3 stop sign)
    const car3StopSignImage = new Image();
    car3StopSignImage.src = '車廂3物件/車廂3站牌.png';

    // 車廂3 車窗：靠近時觸發影片
    const car3WindowImage = new Image();
    car3WindowImage.src = '車廂3物件/車窗.png';

    // 車廂3 車門：靠近時觸發「已抵達：民主站」影片
    const car3DoorImage = new Image();
    car3DoorImage.src = '車廂3物件/車門.png';

    // 車廂3 餐車：靠近時觸發分享本遊戲
    const car3CartImage = new Image();
    car3CartImage.src = '車廂3物件/餐車.png';

    // 車廂2 文件：原住民轉型正義（文件1）與延伸內容（文件2），地圖上顯示
    const car2Doc1Image = new Image();
    car2Doc1Image.src = '車廂2物件/文件1.png';
    const car2Doc2Image = new Image();
    car2Doc2Image.src = '車廂2物件/文件2.png';
    const car2Doc3Image = new Image();
    car2Doc3Image.src = '車廂2物件/文件3.png';
    const car2Doc4Image = new Image();
    car2Doc4Image.src = '車廂2物件/文件4.png';

    // 月台 便當攤：col 41, row 22 裝飾物件
    const bentoStallImage = new Image();
    bentoStallImage.src = '月台區物件/便當攤.png';
    // 月台 廁所：col 13-14, row 22-23 裝飾與觸發 OCR
    const toiletImage = new Image();
    toiletImage.src = '月台區物件/廁所.png';
    // 月台 售票機：col 17～23, row 22～23 之間（裝飾）
    const ticketMachineImage = new Image();
    ticketMachineImage.src = '月台區物件/售票機.png';
    // 月台 告示：col 38, row 27（裝飾）
    const noticeImage = new Image();
    noticeImage.src = '月台區物件/告示.png';
    // 月台 書架：col 31～38 之間再往右一格（中心 35.5 格）, row 21（往上一格）
    const bookshelfImage = new Image();
    bookshelfImage.src = '月台區物件/書架.png';
    // 月台 士農工商：col 16～19 之間、row 16，再往右上各 16px（裝飾）
    const shinonggongshangImage = new Image();
    shinonggongshangImage.src = '月台區物件/士農工商.png';
    // 月台 站名牌：col 34～35 之間、row 16，再往右上各 16px（裝飾，靠近觸發）
    const stationSignImage = new Image();
    stationSignImage.src = '月台區物件/站名牌.png';
    // 月台 電子看板左：col 25～26 之間、row 27，再往右往上各 16px（裝飾）
    const electronicBoardLeftImage = new Image();
    electronicBoardLeftImage.src = '月台區物件/電子看板左.png';
    // 月台 電子看板右：col 29～30 之間、row 27（裝飾，靠近觸發）
    const electronicBoardRightImage = new Image();
    electronicBoardRightImage.src = '月台區物件/電子看板右.png';
    // 月台 服務亭：col 27～28 之間、row 28（裝飾）
    const serviceKioskImage = new Image();
    serviceKioskImage.src = '月台區物件/服務亭.png';
    // 月台 盆栽：col 25 與 col 30, row 22（裝飾）
    const potPlantImage = new Image();
    potPlantImage.src = '月台區物件/盆栽.png';

    // Player directional sprites (32x32). Put these PNGs in the same folder.
    const playerSprites = {
      up: new Image(),
      upWalk: new Image(),
      down: new Image(),
      downWalk: new Image(),
      left: new Image(),
      leftWalk: new Image(),
      right: new Image(),
      rightWalk: new Image()
    };
    playerSprites.up.src = 'characters/player_up.png';
    playerSprites.upWalk.src = 'characters/player_up_walk.png';
    playerSprites.down.src = 'characters/player_down.png';
    playerSprites.downWalk.src = 'characters/player_down_walk.png';
    playerSprites.left.src = 'characters/player_left.png';
    playerSprites.leftWalk.src = 'characters/player_left_walk.png';
    playerSprites.right.src = 'characters/player_right.png';
    playerSprites.rightWalk.src = 'characters/player_right_walk.png';

    const player2Sprites = {
      up: new Image(),
      upWalk: new Image(),
      down: new Image(),
      downWalk: new Image(),
      left: new Image(),
      leftWalk: new Image(),
      right: new Image(),
      rightWalk: new Image()
    };
    player2Sprites.up.src = 'characters/player2_up.png';
    player2Sprites.upWalk.src = 'characters/player2_up_walk.png';
    player2Sprites.down.src = 'characters/player2_down.png';
    player2Sprites.downWalk.src = 'characters/player2_down_walk.png';
    player2Sprites.left.src = 'characters/player2_left.png';
    player2Sprites.leftWalk.src = 'characters/player2_left_walk.png';
    player2Sprites.right.src = 'characters/player2_right.png';
    player2Sprites.rightWalk.src = 'characters/player2_right_walk.png';

    // 出生點：x、y 為地圖「比例」0～1（0.18=左側18%，0.88=下方88%）；勿用 5.40 會出界
    const PLAYER_POS = { x: 0.40, y: 0.80 };
    const ZONE_POS = { x: 1228.8 / 1792, y: 320 / 1600, w: 40, h: 30 }; // 周清月：月台 車廂開 col 38, row 10 (1228.8, 320)

    // Player: 32x64（寬一格、高兩格）的人物.
    const player = {
      x: WORLD_WIDTH * PLAYER_POS.x,
      y: WORLD_HEIGHT * PLAYER_POS.y,
      width: TILE_SIZE,        // 32px
      height: TILE_SIZE * 2,   // 64px
      moving: false,
      targetX: 0,
      targetY: 0,
      remainingDist: 0,
      speed: MOVE_SPEED,
      dir: 'down', // current facing direction: 'up' | 'down' | 'left' | 'right'
      idleSince: 0  // 停止移動時的時間戳，用於 0.3 秒後換回站立圖
    };

    // Single interaction point: where the character is standing on the screenshot.
    // You can fine‑tune these numbers later.
    const interactionZone = {
      x: WORLD_WIDTH * ZONE_POS.x - ZONE_POS.w / 2,
      y: WORLD_HEIGHT * ZONE_POS.y - ZONE_POS.h / 2,
      width: ZONE_POS.w,
      height: ZONE_POS.h,
      info: 'This is the key interaction point on the platform.'
    };

    // 觸發區僅涵蓋 row 10（y 320～352），在 row 11 時因距離/範圍不重疊故不觸發
    // 黃家母女互動區：月台 車廂開 col 23, row 10
    const huangZone = { x: 732, y: 320, width: 40, height: 32 };
    // 杜孝生互動區：月台 車廂開 col 26, row 10
    const duZone = { x: 828, y: 320, width: 40, height: 32 };
    // 劉永祥互動區：月台 車廂開 col 29, row 10
    const liuZone = { x: 924, y: 320, width: 40, height: 32 };
    // 陽翰的情報報告觸發點：月台 車廂開 col 33, row 10
    const yangZone = { x: 1052, y: 320, width: 40, height: 32 };
    // 王再傳的黨員手冊觸發點：月台 車廂開 col 43, row 10
    const wangZone = { x: 1372, y: 320, width: 40, height: 32 };
    // 許宗力的海外學人回國服務登記表觸發點：月台 車廂開 col 49, row 10
    const xuZone = { x: 1548, y: 320, width: 40, height: 32 };
    // 車廂2 ORC 文件觸發區：車廂2 col 26, row 10（往左上 5px、5px）
    const car2OrcZone = { x: 26 * TILE_SIZE - 5, y: 320 - 10, width: 40, height: 32 };
    // 竹工（新竹高工的塗鴉）觸發範圍：月台 車廂開 col 45-46, row 10-11（2x2 格）
    const zhugongZone = { x: 1440, y: 320, width: 64, height: 64 };
    // 便當攤觸發範圍：月台 col 42, row 22（2x2 格）
    const bentoZone = { x: 42 * TILE_SIZE - 32, y: 22 * TILE_SIZE, width: 64, height: 64 };
    // 廁所觸發範圍：月台 col 13-14, row 22（y 與便當對齊）, 往右 5px + 半格 - 再往左 5px
    const toiletZone = { x: 13 * TILE_SIZE + TILE_SIZE + TILE_SIZE / 2 - 32, y: 22 * TILE_SIZE + TILE_SIZE / 2 - 32, width: 64, height: 64 };
    // 售票機觸發範圍：月台 col 20, row 21（2x2 格）
    const ticketZone = { x: 20 * TILE_SIZE + TILE_SIZE / 2 - 32, y: 21 * TILE_SIZE + TILE_SIZE / 2 - 32, width: 64, height: 64 };
    // 書架觸發範圍：月台 col 35.5, row 21+8px（案件當事人出生地，範圍加大 4x4 格）
    const bookshelfCenterX0 = (31 + 38) / 2 * TILE_SIZE + TILE_SIZE;
    const bookshelfCenterY0 = 21 * TILE_SIZE + TILE_SIZE / 2 + 8;
    const bookshelfZone = { x: bookshelfCenterX0 - 64, y: bookshelfCenterY0 - 64, width: 128, height: 128 };
    // 告示觸發範圍：月台 col 39 左緣、row 26，與車廂三同為 3x3 格（96x96）
    const noticeZone = { x: (39 * TILE_SIZE) - 48, y: 26 * TILE_SIZE + TILE_SIZE / 2 - 48, width: 96, height: 96 };
    // 車廂3 車窗互動區1：介於 col 24,25 且 row 8，改為 3x3 格（寬高 96）
    const car3WindowZone = { x: 800 - 48, y: 273 - 48, width: 96, height: 96 };
    // 車廂3 車窗互動區2：中心調整為 x=992, y=273（不當黨產），改為 3x3 格
    const car3Window2Zone = { x: 992 - 48, y: 273 - 48, width: 96, height: 96 };
    // 車廂3 車窗互動區3：中心 x=1280, y=273（創傷修復），改為 3x3 格
    const car3Window3Zone = { x: 1280 - 48, y: 273 - 48, width: 96, height: 96 };
    // 車廂3 車門互動區：玩家提供位置 (x=1183, y=288) 為中心做 3x3 格
    const car3DoorZone = { x: 1183 - 48, y: 288 - 48, width: 96, height: 96 };
    // 車廂3 餐車互動區：以玩家提供位置 (x=1461, y=320) 為中心做 3x3 格
    const car3CartZone = { x: 1461 - 48, y: 320 - 48, width: 96, height: 96 };

    const keys = { up: false, down: false, left: false, right: false };
    function clearKeys() { keys.up = keys.down = keys.left = keys.right = false; }
    function releasePopupLock() {
      gameState.inputLocked = false;
      clearKeys();
      player.moving = false;
      player.targetX = player.x;
      player.targetY = player.y;
      player.remainingDist = 0;
    }
    let wasInZone = false;
    let isInZoneNow = false;
    let isNearZoneNow = false;
    let isNearHuangNow = false;
    let wasInHuangZone = false;
    let isNearDuNow = false;
    let wasInDuZone = false;
    let isNearLiuNow = false;
    let wasInLiuZone = false;
    let isNearYangNow = false;
    let wasInYangZone = false;
    let isNearWangNow = false;
    let wasInWangZone = false;
    let isNearXuNow = false;
    let wasInXuZone = false;
    let isNearCar2OrcNow = false;
    let wasInCar2OrcZone = false;
    let isNearCar2Doc2Now = false;
    let wasInCar2Doc2Zone = false;
    let isNearCar2Doc3Now = false;
    let wasInCar2Doc3Zone = false;
    let isNearCar2Doc4Now = false;
    let wasInCar2Doc4Zone = false;
    let isNearZhugongNow = false;
    let wasInZhugongZone = false;
    let isNearBentoNow = false;
    let wasInBentoZone = false;
    let isNearToiletNow = false;
    let wasInToiletZone = false;
    let isNearTicketNow = false;
    let wasInTicketZone = false;
    let isNearBookshelfNow = false;
    let wasInBookshelfZone = false;
    let isNearNoticeNow = false;
    let wasInNoticeZone = false;
    let wasInShinonggongshangZone = false;
    let wasInStationSignZone = false;
    let wasInElectronicBoardLeftZone = false;
    let wasInElectronicBoardRightZone = false;
    let isNearCar3WindowNow = false;
    let wasInCar3WindowZone = false;
    let isNearCar3Window2Now = false;
    let wasInCar3Window2Zone = false;
    let isNearCar3Window3Now = false;
    let wasInCar3Window3Zone = false;
    let isNearCar3DoorNow = false;
    let wasInCar3DoorZone = false;
    let isNearCar3CartNow = false;
    let wasInCar3CartZone = false;

    // Camera: 左上角世界座標；viewW/viewH 為實際可視範圍（cover 時 = screen/scale）
    const camera = { x: 0, y: 0, viewW: VIEW_WIDTH, viewH: VIEW_HEIGHT };

    // --- 第一步：正確 resize canvas（含 devicePixelRatio，不拉伸）---
    function getGameCanvasContainerSize() {
      var w = window.innerWidth;
      var wrap = document.getElementById('game-canvas-wrap');
      var h = (wrap && wrap.clientHeight > 0) ? wrap.clientHeight : window.innerHeight;
      return { width: w, height: h };
    }

    function resizeCanvas() {
      dpr = window.devicePixelRatio || 1;
      var size = getGameCanvasContainerSize();
      var screenW = Math.max(1, size.width);
      var screenH = Math.max(1, size.height);

      var DESIGN_W = VIEW_WIDTH;
      var DESIGN_H = VIEW_HEIGHT;
      var scale = Math.max(screenW / DESIGN_W, screenH / DESIGN_H);
      // 電腦版：依螢幕尺寸限制最大縮放，避免過度 zoom in
      if (screenW > 768) {
        var maxScale = 1.4 + 800 / Math.max(screenW, 800); // 大螢幕約 1.4~1.9
        scale = Math.min(scale, maxScale);
      }

      camera.viewW = screenW / scale;
      camera.viewH = screenH / scale;
      camera.viewW = Math.max(1, camera.viewW);
      camera.viewH = Math.max(1, camera.viewH);
      currentScale = scale;

      canvas.style.width = screenW + 'px';
      canvas.style.height = screenH + 'px';

      canvas.width = Math.floor(screenW * dpr);
      canvas.height = Math.floor(screenH * dpr);

      ctx.setTransform(dpr * scale, 0, 0, dpr * scale, 0, 0);

      canvasCssWidth = camera.viewW;
      canvasCssHeight = camera.viewH;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const gameCanvasWrap = document.getElementById('game-canvas-wrap');
    if (gameCanvasWrap && typeof ResizeObserver !== 'undefined') {
      new ResizeObserver(resizeCanvas).observe(gameCanvasWrap);
    }

    function updateLogicalPositions() {
      // 可通行帶（月台地板範圍）
      const walkTop = WORLD_HEIGHT * 0.63;
      const walkBottom = WORLD_HEIGHT * 0.86;

      // 出生點（由 PLAYER_POS 控制）
      player.x = WORLD_WIDTH * PLAYER_POS.x;
      player.y = WORLD_HEIGHT * PLAYER_POS.y;

      // Interaction zone stays roughly in the middle of the platform.
      interactionZone.x = WORLD_WIDTH * ZONE_POS.x - ZONE_POS.w / 2;
      interactionZone.y = 10 * TILE_SIZE;
      interactionZone.height = TILE_SIZE;

      // Cache walk band for collision checks.
      player.walkTop = walkTop;
      player.walkBottom = walkBottom;
    }

    updateLogicalPositions();

    // 利用當前地圖的遮罩建立 blockedTiles；無遮罩或未載入則全部可通行
    // MASK 只適用於該地圖：切換地圖後必須呼叫本函式，以該地圖的 mask 重新建立禁止通行區域
    // 月台車廂關／車廂開都讀取 MASK（月台底圖_車廂_mask.png）
    function prepareCollisionMask() {
      if (!COLLISION_ENABLED) {
        blockedTiles = [];
        return;
      }
      const cur = mapImages[currentMapIndex];
      const usePlatformOpenMask = currentMapIndex === 0 && platformCarriageOpen && cur.maskOpen && cur.maskOpen.complete && cur.maskOpen.naturalWidth > 0;
      const maskImg = usePlatformOpenMask ? cur.maskOpen : cur.mask;
      if (!maskImg.complete || maskImg.naturalWidth === 0) {
        blockedTiles = [];
        return;
      }
      maskCanvas.width = WORLD_WIDTH;
      maskCanvas.height = WORLD_HEIGHT;
      maskCtx.clearRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      maskCtx.drawImage(maskImg, 0, 0, WORLD_WIDTH, WORLD_HEIGHT);

      const cols = Math.ceil(WORLD_WIDTH / TILE_SIZE);
      const rows = Math.ceil(WORLD_HEIGHT / TILE_SIZE);
      blockedTiles = new Array(rows);

      const imgData = maskCtx.getImageData(0, 0, WORLD_WIDTH, WORLD_HEIGHT).data;

      // 只算「純黑」不算灰；只取每格「中心一點」，避免範圍過大把非黑區也算進去
      const BLACK = 18;
      for (let row = 0; row < rows; row++) {
        blockedTiles[row] = new Array(cols).fill(false);
        for (let col = 0; col < cols; col++) {
          const sampleX = Math.min(WORLD_WIDTH - 1, col * TILE_SIZE + Math.floor(TILE_SIZE / 2));
          const sampleY = Math.min(WORLD_HEIGHT - 1, row * TILE_SIZE + Math.floor(TILE_SIZE / 2));
          const idx = (sampleY * WORLD_WIDTH + sampleX) * 4;
          const r = imgData[idx], g = imgData[idx + 1], b = imgData[idx + 2], a = imgData[idx + 3];
          if (a > 0 && r < BLACK && g < BLACK && b < BLACK) blockedTiles[row][col] = true;
        }
      }
      // 強制指定座標所在格為可通行（DEBUG 用）
      const forceWalkX = 716, forceWalkY = 1184;
      const fc = Math.floor(forceWalkX / TILE_SIZE), fr = Math.floor(forceWalkY / TILE_SIZE);
      if (fr >= 0 && fr < blockedTiles.length && fc >= 0 && fc < blockedTiles[0].length) {
        blockedTiles[fr][fc] = false;
      }
      // 月台：返回地圖一時的出生點強制可通行，避免卡住
      if (currentMapIndex === 0) {
        const platformSpawnX = WORLD_WIDTH - 85;
        const platformSpawnY = WORLD_HEIGHT * 0.5;
        for (let or = -1; or <= 1; or++) {
          for (let oc = -1; oc <= 1; oc++) {
            const c = Math.floor(platformSpawnX / TILE_SIZE) + oc;
            const r = Math.floor(platformSpawnY / TILE_SIZE) + or;
            if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
              blockedTiles[r][c] = false;
            }
          }
        }
        if (platformCarriageOpen) {
          // 月台車廂開：col 21-23, row 10-12 強制不可行走
          for (let c = 21; c <= 23; c++) {
            for (let r = 10; r <= 12; r++) {
              if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
                blockedTiles[r][c] = true;
              }
            }
          }
          // 月台車廂開：col 22-23, row 10-11 開放行走
          for (let c = 22; c <= 23; c++) {
            for (let r = 10; r <= 11; r++) {
              if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
                blockedTiles[r][c] = false;
              }
            }
          }
        } else {
          // 月台車廂關：col 21-23, row 10-12 強制可通行
          for (let c = 21; c <= 23; c++) {
            for (let r = 10; r <= 12; r++) {
              if (r >= 0 && r < blockedTiles.length && c >= 0 && c < blockedTiles[0].length) {
                blockedTiles[r][c] = false;
              }
            }
          }
        }
      }
    }

    // --- Tile-based movement helpers ---
    function tryMove(dxTiles, dyTiles) {
      const dx = dxTiles * TILE_SIZE;
      const dy = dyTiles * TILE_SIZE;
      if (dx === 0 && dy === 0) return;
      if (player.moving) return; // wait until current step finishes

      let newX = player.x + dx;
      let newY = player.y + dy;

      const halfW = player.width / 2;
      const halfH = player.height / 2;

      // Clamp to world bounds
      newX = Math.max(halfW, Math.min(WORLD_WIDTH - halfW, newX));
      newY = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, newY));

      // 依照遮罩判斷目標格是否被封鎖
      if (blockedTiles.length > 0) {
        const col = Math.floor(newX / TILE_SIZE);
        const row = Math.floor(newY / TILE_SIZE);
        if (
          row >= 0 &&
          row < blockedTiles.length &&
          col >= 0 &&
          col < blockedTiles[0].length &&
          blockedTiles[row][col]
        ) {
          // 目標是黑色區塊，取消這一步
          return;
        }
      }

      const dist = Math.hypot(newX - player.x, newY - player.y);
      if (dist === 0) return;

      // Set up smooth movement towards the target tile
      player.targetX = newX;
      player.targetY = newY;
      player.remainingDist = dist;
      player.moving = true;
    }

    function moveFromDirection(dir) {
      switch (dir) {
        case 'up':
          player.dir = 'up';
          tryMove(0, -1); break;
        case 'down':
          player.dir = 'down';
          tryMove(0, 1); break;
        case 'left':
          player.dir = 'left';
          tryMove(-1, 0); break;
        case 'right':
          player.dir = 'right';
          tryMove(1, 0); break;
      }
    }

    // Keyboard input: keep direction pressed while key held down
    window.addEventListener('keydown', (e) => {
      switch (e.key) {
        case 'ArrowUp':
        case 'w':
        case 'W':
          keys.up = true; break;
        case 'ArrowDown':
        case 's':
        case 'S':
          keys.down = true; break;
        case 'ArrowLeft':
        case 'a':
        case 'A':
          keys.left = true; break;
        case 'ArrowRight':
        case 'd':
        case 'D':
          keys.right = true; break;
        case 'Escape':
          e.preventDefault();
          closeAllInfoPopups();
          break;
      }
    });

    window.addEventListener('keyup', (e) => {
      switch (e.key) {
        case 'ArrowUp':
        case 'w':
        case 'W':
          keys.up = false; break;
        case 'ArrowDown':
        case 's':
        case 'S':
          keys.down = false; break;
        case 'ArrowLeft':
        case 'a':
        case 'A':
          keys.left = false; break;
        case 'ArrowRight':
        case 'd':
        case 'D':
          keys.right = false; break;
      }
    });

    const controls = document.getElementById('controls');
    const joystickArea = document.getElementById('joystickArea');
    const joystickKnob = document.getElementById('joystickKnob');
    let joystickActive = false;

    // 圓形滑桿：拖曳時依位移方向決定上下左右，放開時回到中心
    if (controls && joystickArea && joystickKnob) {
      const maxRadius = 60; // 滑桿可移動的最大半徑（px）
      const deadZone = 8;   // 中央死區，避免微小抖動

      const resetJoystick = () => {
        joystickActive = false;
        keys.up = keys.down = keys.left = keys.right = false;
        joystickKnob.style.setProperty('--dx', '0px');
        joystickKnob.style.setProperty('--dy', '0px');
        joystickArea.classList.remove('active');
      };

      const updateFromPoint = (clientX, clientY) => {
        const rect = joystickArea.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        let dx = clientX - centerX;
        let dy = clientY - centerY;
        const dist = Math.hypot(dx, dy);

        // 限制滑桿位置在圓形範圍內
        const clampedDist = Math.min(dist, maxRadius);
        const ratio = dist > 0 ? clampedDist / dist : 0;
        dx *= ratio;
        dy *= ratio;

        joystickKnob.style.setProperty('--dx', dx + 'px');
        joystickKnob.style.setProperty('--dy', dy + 'px');

        // 依位移方向設定鍵盤狀態（四向）
        keys.up = keys.down = keys.left = keys.right = false;
        if (dist < deadZone) return;

        const absX = Math.abs(dx);
        const absY = Math.abs(dy);
        if (absX > absY) {
          if (dx > 0) keys.right = true;
          else keys.left = true;
        } else {
          if (dy > 0) keys.down = true;
          else keys.up = true;
        }
      };

      const start = (e) => {
        e.preventDefault();
        joystickActive = true;
        joystickArea.classList.add('active');
        const point = e.touches ? e.touches[0] : e;
        updateFromPoint(point.clientX, point.clientY);
      };

      const move = (e) => {
        if (!joystickActive) return;
        e.preventDefault();
        const point = e.touches ? e.touches[0] : e;
        updateFromPoint(point.clientX, point.clientY);
      };

      const end = (e) => {
        if (!joystickActive) return;
        e.preventDefault();
        resetJoystick();
      };

      joystickArea.addEventListener('touchstart', start, { passive: false });
      joystickArea.addEventListener('touchmove', move, { passive: false });
      joystickArea.addEventListener('touchend', end, { passive: false });
      joystickArea.addEventListener('touchcancel', end, { passive: false });

      joystickArea.addEventListener('mousedown', start);
      window.addEventListener('mousemove', move);
      window.addEventListener('mouseup', end);
    }

    function update(dt) {
      player.dt = dt;
      // If not currently moving to a tile, check held directions and start a new step.
      if (!player.moving) {
        let dir = null;
        if (keys.up) dir = 'up';
        else if (keys.down) dir = 'down';
        else if (keys.left) dir = 'left';
        else if (keys.right) dir = 'right';

        if (dir) {
          moveFromDirection(dir);
        }
      }

      // Smoothly move player towards target tile if currently moving (delta-time based)
      if (player.moving) {
        const dx = player.targetX - player.x;
        const dy = player.targetY - player.y;
        const dist = Math.hypot(dx, dy);
        const step = player.speed * (player.dt ?? 1/60); // pixels this frame

        if (dist <= step || dist === 0) {
          // Snap to tile and finish movement
          player.x = player.targetX;
          player.y = player.targetY;
          player.moving = false;
          player.idleSince = Date.now();
          player.remainingDist = 0;
        } else {
          const stepX = (dx / dist) * step;
          const stepY = (dy / dist) * step;
          player.x += stepX;
          player.y += stepY;
          player.remainingDist = dist - step;
        }
      }

      const halfW = player.width / 2;
      const halfH = player.height / 2;

      // 切換地圖時清除移動狀態，避免還往舊地圖座標移動
      function onMapSwitch() {
        player.moving = false;
        player.idleSince = Date.now();
        player.targetX = player.x;
        player.targetY = player.y;
        player.remainingDist = 0;
      }

      // 傳送點依 col/row 判斷（與 TRANSMISSION_ZONES 一致）
      const playerCol = Math.floor(player.x / TILE_SIZE);
      const playerRow = Math.floor(player.y / TILE_SIZE);
      const platformZones = TRANSMISSION_ZONES.platform;
      const closedToCar2Zones = TRANSMISSION_ZONES.platformClosedToCar2 || [];
      const inZoneOpen = platformZones[0] && playerCol >= platformZones[0].col1 && playerCol <= platformZones[0].col2 && playerRow >= platformZones[0].row1 && playerRow <= platformZones[0].row2;
      const inZoneToClosed = platformZones[1] && playerCol >= platformZones[1].col1 && playerCol <= platformZones[1].col2 && playerRow >= platformZones[1].row1 && playerRow <= platformZones[1].row2;
      const inZoneCar2 = platformZones[2] && playerCol >= platformZones[2].col1 && playerCol <= platformZones[2].col2 && playerRow >= platformZones[2].row1 && playerRow <= platformZones[2].row2;
      const inZoneClosedToCar2 = closedToCar2Zones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      const car2ToPlatformOpenZones = TRANSMISSION_ZONES.car2ToPlatformOpen || [];
      const inZoneCar2ToPlatformOpen = car2ToPlatformOpenZones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      const car2ToCar3Zones = TRANSMISSION_ZONES.car2ToCar3 || [];
      const inZoneCar2ToCar3 = car2ToCar3Zones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      const car3ToCar2Zones = TRANSMISSION_ZONES.car3ToCar2 || [];
      const inZoneCar3ToCar2 = car3ToCar2Zones.some(function (z) {
        return playerCol >= z.col1 && playerCol <= z.col2 && playerRow >= z.row1 && playerRow <= z.row2;
      });
      if (currentMapIndex === 0 && !platformCarriageOpen && inZoneOpen) {
        platformCarriageOpen = true;
        prepareCollisionMask(); // 切換為車廂開後，改用車廂開 MASK
      } else if (currentMapIndex === 0 && platformCarriageOpen && inZoneToClosed) {
        platformCarriageOpen = false;
        prepareCollisionMask(); // 切回車廂關後，改用車廂關 MASK
      } else if (currentMapIndex === 0 && !platformCarriageOpen && inZoneClosedToCar2 && mapImages[1].width > 0 && mapImages[1].height > 0) {
        currentMapIndex = 1;
        applyWorldSizeFromMap(1);
        player.x = CAR2_SPAWN.x;
        player.y = CAR2_SPAWN.y;
        onMapSwitch();
        prepareCollisionMask(); // 切換到車廂2後，用該地圖的 MASK 更新禁止通行區域
      } else if (currentMapIndex === 0 && platformCarriageOpen && inZoneCar2 && mapImages[1].width > 0 && mapImages[1].height > 0) {
        currentMapIndex = 1;
        applyWorldSizeFromMap(1);
        player.x = CAR2_SPAWN.x;
        player.y = CAR2_SPAWN.y;
        onMapSwitch();
        prepareCollisionMask(); // 切換到車廂2後，用該地圖的 MASK 更新禁止通行區域
      } else if (currentMapIndex === 1 && inZoneCar2ToPlatformOpen && mapImages[0].width > 0 && mapImages[0].height > 0) {
        currentMapIndex = 0;
        platformCarriageOpen = true; // 車廂一 = 月台 車廂開
        applyWorldSizeFromMap(0);
        player.x = PLATFORM_OPEN_SPAWN_FROM_CAR2.x;
        player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, player.y)); // 保持當前 row 對應的 y（如 row 10→320, row 11→352）
        onMapSwitch();
        prepareCollisionMask(); // 切換到月台後，用該地圖的 MASK 更新禁止通行區域
      } else if (currentMapIndex === 1 && inZoneCar2ToCar3 && mapImages[2].width > 0 && mapImages[2].height > 0) {
        currentMapIndex = 2;
        applyWorldSizeFromMap(2);
        player.x = CAR3_SPAWN.x;
        player.y = CAR3_SPAWN.y;
        onMapSwitch();
        prepareCollisionMask(); // 切換到車廂3後，用該地圖的 MASK 更新禁止通行區域
      } else if (currentMapIndex === 2 && inZoneCar3ToCar2 && mapImages[1].width > 0 && mapImages[1].height > 0) {
        currentMapIndex = 1;
        applyWorldSizeFromMap(1);
        player.x = CAR2_SPAWN_FROM_CAR3.x;
        player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, player.y)); // 保持當前 row（row 10→320, row 11→352）
        onMapSwitch();
        prepareCollisionMask(); // 切換到車廂2後，用該地圖的 MASK 更新禁止通行區域
      }

      const edgeW = 70;
      const spawnInset = 85; // 切換地圖後出生點要比 edgeW 大，才不會立刻觸發「左邊緣回上一張」
      if (player.x >= WORLD_WIDTH - edgeW && currentMapIndex < MAP_LIST.length - 1) {
        const next = mapImages[currentMapIndex + 1];
        if (next.width > 0 && next.height > 0) {
          currentMapIndex++;
          applyWorldSizeFromMap(currentMapIndex);
          player.x = spawnInset;
          player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, WORLD_HEIGHT * 0.5));
          onMapSwitch();
          prepareCollisionMask(); // 切換地圖後，用該地圖的 MASK 更新禁止通行區域
        }
      } else if (player.x <= edgeW && currentMapIndex > 0) {
        const prev = mapImages[currentMapIndex - 1];
        if (prev.width > 0 && prev.height > 0) {
          currentMapIndex--;
          if (currentMapIndex === 0) platformCarriageOpen = false; // 回月台時改回車廂關
          applyWorldSizeFromMap(currentMapIndex);
          player.x = WORLD_WIDTH - spawnInset;
          player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, WORLD_HEIGHT * 0.5));
          onMapSwitch();
          prepareCollisionMask(); // 切換地圖後，用該地圖的 MASK 更新禁止通行區域
        }
      }

      player.x = Math.max(halfW, Math.min(WORLD_WIDTH - halfW, player.x));
      player.y = Math.max(halfH, Math.min(WORLD_HEIGHT - halfH, player.y));

      var viewW = camera.viewW;
      var viewH = camera.viewH;
      camera.x = player.x + player.width / 2 - viewW / 2;
      camera.y = player.y + player.height / 2 - viewH / 2;
      var maxCamX = Math.max(0, WORLD_WIDTH - viewW);
      var maxCamY = Math.max(0, WORLD_HEIGHT - viewH);
      camera.x = Math.max(0, Math.min(camera.x, maxCamX));
      camera.y = Math.max(0, Math.min(camera.y, maxCamY));
      if (DEBUG_CAMERA && viewH > WORLD_HEIGHT) {
        console.warn('[camera] viewH > mapH', { mapH: WORLD_HEIGHT, viewH: viewH, cameraY: camera.y });
      }

      const objCenterX = interactionZone.x + interactionZone.width / 2;
      const objCenterY = 10 * TILE_SIZE; // 與圖示同高（320），和其他物件一致
      const dxCenter = player.x - objCenterX;
      const dyCenter = player.y - objCenterY;
      const distToCenter = Math.hypot(dxCenter, dyCenter);

      // 黃家母女圖示位置：月台 車廂開 col 23, row 10 往上半格
      const huangCenterX = 23 * TILE_SIZE + TILE_SIZE / 2;
      const huangCenterY = 10 * TILE_SIZE; // 320，剛好比格子中心往上半格
      const dxHuang = player.x - huangCenterX;
      const dyHuang = player.y - huangCenterY;
      const distToHuang = Math.hypot(dxHuang, dyHuang);
      // 杜孝生圖示位置：月台 車廂開 col 26, row 10
      const duCenterX = 26 * TILE_SIZE + TILE_SIZE / 2;
      const duCenterY = 10 * TILE_SIZE;
      const dxDu = player.x - duCenterX;
      const dyDu = player.y - duCenterY;
      const distToDu = Math.hypot(dxDu, dyDu);
      // 劉永祥圖示位置：月台 車廂開 col 29, row 10
      const liuCenterX = 29 * TILE_SIZE + TILE_SIZE / 2;
      const liuCenterY = 10 * TILE_SIZE;
      const dxLiu = player.x - liuCenterX;
      const dyLiu = player.y - liuCenterY;
      const distToLiu = Math.hypot(dxLiu, dyLiu);
      // 陽翰的情報報告圖示位置：月台 車廂開 col 33, row 10
      const yangCenterX = 33 * TILE_SIZE + TILE_SIZE / 2;
      const yangCenterY = 10 * TILE_SIZE;
      const dxYang = player.x - yangCenterX;
      const dyYang = player.y - yangCenterY;
      const distToYang = Math.hypot(dxYang, dyYang);
      // 王再傳的黨員手冊圖示位置：月台 車廂開 col 43, row 10
      const wangCenterX = 43 * TILE_SIZE + TILE_SIZE / 2;
      const wangCenterY = 10 * TILE_SIZE;
      const dxWang = player.x - wangCenterX;
      const dyWang = player.y - wangCenterY;
      const distToWang = Math.hypot(dxWang, dyWang);
      // 許宗力的海外學人回國服務登記表圖示位置：月台 車廂開 col 49, row 10
      const xuCenterX = 49 * TILE_SIZE + TILE_SIZE / 2;
      const xuCenterY = 10 * TILE_SIZE;
      const dxXu = player.x - xuCenterX;
      const dyXu = player.y - xuCenterY;
      const distToXu = Math.hypot(dxXu, dyXu);
      // 車廂2 ORC 文件圖示位置：車廂2 col 26, row 10（往左上 5px, 5px）
      const car2OrcCenterX = 26 * TILE_SIZE + TILE_SIZE / 2 - 5;
      const car2OrcCenterY = 10 * TILE_SIZE - 10;
      const dxCar2Orc = player.x - car2OrcCenterX;
      const dyCar2Orc = player.y - car2OrcCenterY;
      const distToCar2Orc = Math.hypot(dxCar2Orc, dyCar2Orc);
      // 車廂2 文件2 圖示位置：車廂2 col 32, row 10
      const car2Doc2CenterX = 32 * TILE_SIZE + TILE_SIZE / 2;
      const car2Doc2CenterY = 10 * TILE_SIZE - 10;
      const dxCar2Doc2 = player.x - car2Doc2CenterX;
      const dyCar2Doc2 = player.y - car2Doc2CenterY;
      const distToCar2Doc2 = Math.hypot(dxCar2Doc2, dyCar2Doc2);
      // 車廂2 文件3 圖示位置：車廂2 col 43, row 10（與其他文件同水平）
      const car2Doc3CenterX = 43 * TILE_SIZE + TILE_SIZE / 2;
      const car2Doc3CenterY = 10 * TILE_SIZE - 10;
      const dxCar2Doc3 = player.x - car2Doc3CenterX;
      const dyCar2Doc3 = player.y - car2Doc3CenterY;
      const distToCar2Doc3 = Math.hypot(dxCar2Doc3, dyCar2Doc3);
      // 車廂2 文件4 圖示位置：車廂2 col 47, row 10（與其他文件同水平）
      const car2Doc4CenterX = 47 * TILE_SIZE + TILE_SIZE / 2;
      const car2Doc4CenterY = 10 * TILE_SIZE - 10;
      const dxCar2Doc4 = player.x - car2Doc4CenterX;
      const dyCar2Doc4 = player.y - car2Doc4CenterY;
      const distToCar2Doc4 = Math.hypot(dxCar2Doc4, dyCar2Doc4);
      // 竹工（新竹高工的塗鴉）圖示位置：col 45-46 row 10-11 中心 (1472, 352)
      const zhugongCenterX = 45 * TILE_SIZE + TILE_SIZE;  // 1472
      const zhugongCenterY = 10 * TILE_SIZE + TILE_SIZE;   // 352
      const dxZhugong = player.x - zhugongCenterX;
      const dyZhugong = player.y - zhugongCenterY;
      const distToZhugong = Math.hypot(dxZhugong, dyZhugong);
      // 便當攤：月台 col 42, row 22
      const bentoCenterX = 42 * TILE_SIZE;
      const bentoCenterY = 22 * TILE_SIZE + TILE_SIZE / 2;
      const dxBento = player.x - bentoCenterX;
      const dyBento = player.y - bentoCenterY;
      const distToBento = Math.hypot(dxBento, dyBento);
      // 廁所：y 與便當對齊（row 22 格心），往右半格（再往左 5px）
      const toiletCenterX = 13 * TILE_SIZE + TILE_SIZE + TILE_SIZE / 2;
      const toiletCenterY = 22 * TILE_SIZE + TILE_SIZE / 2;
      const dxToilet = player.x - toiletCenterX;
      const dyToilet = player.y - toiletCenterY;
      const distToToilet = Math.hypot(dxToilet, dyToilet);
      // 售票機：月台 col 20, row 21
      const ticketCenterX = 20 * TILE_SIZE + TILE_SIZE / 2;
      const ticketCenterY = 21 * TILE_SIZE + TILE_SIZE / 2;
      const dxTicket = player.x - ticketCenterX;
      const dyTicket = player.y - ticketCenterY;
      const distToTicket = Math.hypot(dxTicket, dyTicket);
      // 書架：月台 col 35.5, row 21+8px
      const bookshelfCenterX = (31 + 38) / 2 * TILE_SIZE + TILE_SIZE;
      const bookshelfCenterY = 21 * TILE_SIZE + TILE_SIZE / 2 + 8;
      const dxBookshelf = player.x - bookshelfCenterX;
      const dyBookshelf = player.y - bookshelfCenterY;
      const distToBookshelf = Math.hypot(dxBookshelf, dyBookshelf);
      // 告示：月台 col 39 左緣、row 26（政治案件高峰期）
      const noticeCenterX = 39 * TILE_SIZE;
      const noticeCenterY = 26 * TILE_SIZE + TILE_SIZE / 2;
      const dxNotice = player.x - noticeCenterX;
      const dyNotice = player.y - noticeCenterY;
      const distToNotice = Math.hypot(dxNotice, dyNotice);
      // 士農工商：月台 col 16～19 之間、row 16，再往右上各 16px
      const sngsCenterX = (16 + 19) / 2 * TILE_SIZE + 16;
      const sngsCenterY = 16 * TILE_SIZE + TILE_SIZE / 2 - 16;
      const dxSngs = player.x - sngsCenterX;
      const dySngs = player.y - sngsCenterY;
      const distToShinonggongshang = Math.hypot(dxSngs, dySngs);
      // 站名牌：月台 col 34～35、row 16，再往右上各 16px
      const signCenterX = (34 + 35) / 2 * TILE_SIZE + 16;
      const signCenterY = 16 * TILE_SIZE + TILE_SIZE / 2 - 16;
      const dxSign = player.x - signCenterX;
      const dySign = player.y - signCenterY;
      const distToStationSign = Math.hypot(dxSign, dySign);
      // 電子看板左：月台 col 25～26、row 27，再往右往上各 16px
      const eblCenterX = (25 + 26) / 2 * TILE_SIZE + 16;
      const eblCenterY = 27 * TILE_SIZE + TILE_SIZE / 2 - 16;
      const dxEbl = player.x - eblCenterX;
      const dyEbl = player.y - eblCenterY;
      const distToElectronicBoardLeft = Math.hypot(dxEbl, dyEbl);
      // 電子看板右：月台 col 29～30、row 27，再往上 16px
      const ebrCenterX = (29 + 30) / 2 * TILE_SIZE + TILE_SIZE / 2;
      const ebrCenterY = 27 * TILE_SIZE + TILE_SIZE / 2 - 16;
      const dxEbr = player.x - ebrCenterX;
      const dyEbr = player.y - ebrCenterY;
      const distToElectronicBoardRight = Math.hypot(dxEbr, dyEbr);

      // 車廂3 車窗1：位於 col 24 與 25 之間、row 8（Y 微調 +1）
      const car3WindowCenterX = 800;
      const car3WindowCenterY = 273;
      const dxCar3Window = player.x - car3WindowCenterX;
      const dyCar3Window = player.y - car3WindowCenterY;
      const distToCar3Window = Math.hypot(dxCar3Window, dyCar3Window);
      // 車廂3 車窗2：中心調整為 x=992, y=273（不當黨產）
      const car3Window2CenterX = 992;
      const car3Window2CenterY = 273;
      const dxCar3Window2 = player.x - car3Window2CenterX;
      const dyCar3Window2 = player.y - car3Window2CenterY;
      const distToCar3Window2 = Math.hypot(dxCar3Window2, dyCar3Window2);
      // 車廂3 車窗3：中心 x=1280, y=273（創傷修復）
      const car3Window3CenterX = 1280;
      const car3Window3CenterY = 273;
      const dxCar3Window3 = player.x - car3Window3CenterX;
      const dyCar3Window3 = player.y - car3Window3CenterY;
      const distToCar3Window3 = Math.hypot(dxCar3Window3, dyCar3Window3);
      // 車廂3 車門：玩家提供位置 (x=1183, y=288)
      const car3DoorCenterX = 1183;
      const car3DoorCenterY = 288;
      const dxCar3Door = player.x - car3DoorCenterX;
      const dyCar3Door = player.y - car3DoorCenterY;
      const distToCar3Door = Math.hypot(dxCar3Door, dyCar3Door);
      // 車廂3 餐車：玩家提供位置 (x=1461, y=320)
      const car3CartCenterX = 1461;
      const car3CartCenterY = 320;
      const dxCar3Cart = player.x - car3CartCenterX;
      const dyCar3Cart = player.y - car3CartCenterY;
      const distToCar3Cart = Math.hypot(dxCar3Cart, dyCar3Cart);

      // 周清月記者證互動僅在月台 車廂開（地圖 0 且 platformCarriageOpen）
      const onPlatformOpen = currentMapIndex === 0 && platformCarriageOpen;
      const onCar2 = currentMapIndex === 1;
      const onCar3 = currentMapIndex === 2;
      // 預覽（光暈+靠近圖）：距離放大，較遠即可看到
      const NEAR_PREVIEW_DIST = 96;
      // 六個物件：用「玩家中心點在區內」判定；觸發區 y 只含 row 10，故 row 11 自然不會觸發（測量距離達成）
      isNearZoneNow = onPlatformOpen && distToCenter < NEAR_PREVIEW_DIST;
      const inZone = onPlatformOpen && isPlayerCenterInZone(player, interactionZone);
      isNearHuangNow = onPlatformOpen && distToHuang < NEAR_PREVIEW_DIST;
      const inHuangZone = onPlatformOpen && isPlayerCenterInZone(player, huangZone);
      isNearDuNow = onPlatformOpen && distToDu < NEAR_PREVIEW_DIST;
      const inDuZone = onPlatformOpen && isPlayerCenterInZone(player, duZone);
      isNearLiuNow = onPlatformOpen && distToLiu < NEAR_PREVIEW_DIST;
      const inLiuZone = onPlatformOpen && isPlayerCenterInZone(player, liuZone);
      isNearYangNow = onPlatformOpen && distToYang < NEAR_PREVIEW_DIST;
      const inYangZone = onPlatformOpen && isPlayerCenterInZone(player, yangZone);
      isNearWangNow = onPlatformOpen && distToWang < NEAR_PREVIEW_DIST;
      const inWangZone = onPlatformOpen && isPlayerCenterInZone(player, wangZone);
      isNearXuNow = onPlatformOpen && distToXu < NEAR_PREVIEW_DIST;
      const inXuZone = onPlatformOpen && isPlayerCenterInZone(player, xuZone);
      // 車廂2 ORC 文件：僅在車廂2 內啟用
      isNearCar2OrcNow = onCar2 && distToCar2Orc < NEAR_PREVIEW_DIST;
      const inCar2OrcZone = onCar2 && isPlayerCenterInZone(player, car2OrcZone);
      // 車廂2 文件2：僅在車廂2 內啟用（靠近時開啟「政治檔案開放」彈窗）
      isNearCar2Doc2Now = onCar2 && distToCar2Doc2 < NEAR_PREVIEW_DIST;
      const inCar2Doc2Zone = onCar2 && isPlayerCenterInZone(player, {
        x: 32 * TILE_SIZE,
        y: 320 - 10,
        width: 40,
        height: 32
      });
      // 車廂2 文件3：僅在車廂2 內啟用（與其他文件同水平）
      isNearCar2Doc3Now = onCar2 && distToCar2Doc3 < NEAR_PREVIEW_DIST;
      const inCar2Doc3Zone = onCar2 && isPlayerCenterInZone(player, {
        x: 43 * TILE_SIZE,
        y: 320 - 10,
        width: 40,
        height: 32
      });
      // 車廂2 文件4：僅在車廂2 內啟用（與其他文件同水平）
      isNearCar2Doc4Now = onCar2 && distToCar2Doc4 < NEAR_PREVIEW_DIST;
      const inCar2Doc4Zone = onCar2 && isPlayerCenterInZone(player, {
        x: 47 * TILE_SIZE,
        y: 320 - 10,
        width: 40,
        height: 32
      });
      // 竹工（新竹高工的塗鴉）：用 bbox 重疊，row 10 或 11 皆可觸發，預覽距離同
      isNearZhugongNow = onPlatformOpen && distToZhugong < NEAR_PREVIEW_DIST;
      const inZhugongZone = onPlatformOpen && isPlayerInZone(player, zhugongZone);
      // 便當攤：月台（車廂關/車廂開皆可）col 42, row 22
      const onPlatform = currentMapIndex === 0;
      isNearBentoNow = onPlatform && distToBento < NEAR_PREVIEW_DIST;
      // 便當攤：改為距離判定，靠近即可觸發
      const inBentoZone = onPlatform && distToBento < NEAR_PREVIEW_DIST;
      isNearToiletNow = onPlatform && distToToilet < NEAR_PREVIEW_DIST;
      const inToiletZone = onPlatform && isPlayerCenterInZone(player, toiletZone);
      isNearTicketNow = onPlatform && distToTicket < NEAR_PREVIEW_DIST;
      // 售票機：改為距離判定，靠近即可觸發
      const inTicketZone = onPlatform && distToTicket < NEAR_PREVIEW_DIST;
      isNearBookshelfNow = onPlatform && distToBookshelf < NEAR_PREVIEW_DIST;
      const inBookshelfZone = onPlatform && isPlayerCenterInZone(player, bookshelfZone);
      isNearNoticeNow = onPlatform && distToNotice < NEAR_PREVIEW_DIST;
      const inNoticeZone = onPlatform && isPlayerCenterInZone(player, noticeZone);
      const inShinonggongshangZone = onPlatform && distToShinonggongshang < NEAR_PREVIEW_DIST;
      const inStationSignZone = onPlatform && distToStationSign < NEAR_PREVIEW_DIST;
      const ELECTRONIC_BOARD_LEFT_TRIGGER_DIST = 64;
      const inElectronicBoardLeftZone = onPlatform && distToElectronicBoardLeft < ELECTRONIC_BOARD_LEFT_TRIGGER_DIST;
      const ELECTRONIC_BOARD_RIGHT_TRIGGER_DIST = 64;
      const inElectronicBoardRightZone = onPlatform && distToElectronicBoardRight < ELECTRONIC_BOARD_RIGHT_TRIGGER_DIST;
      // 車廂3 車窗：在車廂3 內，使用相同預覽距離
      isNearCar3WindowNow = onCar3 && distToCar3Window < NEAR_PREVIEW_DIST;
      const inCar3WindowZone = onCar3 && isPlayerCenterInZone(player, car3WindowZone);
      isNearCar3Window2Now = onCar3 && distToCar3Window2 < NEAR_PREVIEW_DIST;
      const inCar3Window2Zone = onCar3 && isPlayerCenterInZone(player, car3Window2Zone);
      isNearCar3Window3Now = onCar3 && distToCar3Window3 < NEAR_PREVIEW_DIST;
      const inCar3Window3Zone = onCar3 && isPlayerCenterInZone(player, car3Window3Zone);
      // 車廂3 車門：在車廂3 內，使用相同預覽距離
      isNearCar3DoorNow = onCar3 && distToCar3Door < NEAR_PREVIEW_DIST;
      const inCar3DoorZone = onCar3 && isPlayerCenterInZone(player, car3DoorZone);
      // 車廂3 餐車：在車廂3 內，使用相同預覽距離
      isNearCar3CartNow = onCar3 && distToCar3Cart < NEAR_PREVIEW_DIST;
      const inCar3CartZone = onCar3 && isPlayerCenterInZone(player, car3CartZone);

      isInZoneNow = inZone;
      if (inZone && !wasInZone) {
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollZhou) bottomSheetScrollZhou.scrollTop = 0;
        popup.classList.remove('hidden');
        achievementUnlock('zhou');
        requestAnimationFrame(function () {
          if (bottomSheet) bottomSheet.classList.add('open');
          if (scrollProgressBarZhou) scrollProgressBarZhou.style.top = '0%';
        });
      } else if (!inZone && wasInZone) {
        if (bottomSheet) bottomSheet.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { popup.classList.add('hidden'); }, 300);
      }
      if (inHuangZone && !wasInHuangZone) {
        popup.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollHuang) bottomSheetScrollHuang.scrollTop = 0;
        if (popupHuang) popupHuang.classList.remove('hidden');
        achievementUnlock('huang');
        requestAnimationFrame(function () {
          if (bottomSheetHuang) bottomSheetHuang.classList.add('open');
          if (scrollProgressBarHuang) scrollProgressBarHuang.style.top = '0%';
        });
      } else if (!inHuangZone && wasInHuangZone) {
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupHuang) popupHuang.classList.add('hidden'); }, 300);
      }
      if (inDuZone && !wasInDuZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollDu) bottomSheetScrollDu.scrollTop = 0;
        if (popupDu) popupDu.classList.remove('hidden');
        achievementUnlock('du');
        requestAnimationFrame(function () {
          if (bottomSheetDu) bottomSheetDu.classList.add('open');
          if (scrollProgressBarDu) scrollProgressBarDu.style.top = '0%';
        });
      } else if (!inDuZone && wasInDuZone) {
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupDu) popupDu.classList.add('hidden'); }, 300);
      }
      if (inLiuZone && !wasInLiuZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollLiu) bottomSheetScrollLiu.scrollTop = 0;
        if (popupLiu) popupLiu.classList.remove('hidden');
        achievementUnlock('liu');
        requestAnimationFrame(function () {
          if (bottomSheetLiu) bottomSheetLiu.classList.add('open');
          if (scrollProgressBarLiu) scrollProgressBarLiu.style.top = '0%';
        });
      } else if (!inLiuZone && wasInLiuZone) {
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupLiu) popupLiu.classList.add('hidden'); }, 300);
      }
      if (inYangZone && !wasInYangZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollYang) bottomSheetScrollYang.scrollTop = 0;
        if (popupYang) popupYang.classList.remove('hidden');
        achievementUnlock('yang');
        requestAnimationFrame(function () {
          if (bottomSheetYang) bottomSheetYang.classList.add('open');
          if (scrollProgressBarYang) scrollProgressBarYang.style.top = '0%';
        });
      } else if (!inYangZone && wasInYangZone) {
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupYang) popupYang.classList.add('hidden'); }, 300);
      }
      if (inWangZone && !wasInWangZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollWang) bottomSheetScrollWang.scrollTop = 0;
        if (popupWang) popupWang.classList.remove('hidden');
        achievementUnlock('wang');
        requestAnimationFrame(function () {
          if (bottomSheetWang) bottomSheetWang.classList.add('open');
          if (scrollProgressBarWang) scrollProgressBarWang.style.top = '0%';
        });
      } else if (!inWangZone && wasInWangZone) {
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupWang) popupWang.classList.add('hidden'); }, 300);
      }
      if (inXuZone && !wasInXuZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollXu) bottomSheetScrollXu.scrollTop = 0;
        if (popupXu) popupXu.classList.remove('hidden');
        achievementUnlock('xu');
        requestAnimationFrame(function () {
          if (bottomSheetXu) bottomSheetXu.classList.add('open');
          if (scrollProgressBarXu) scrollProgressBarXu.style.top = '0%';
        });
      } else if (!inXuZone && wasInXuZone) {
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupXu) popupXu.classList.add('hidden'); }, 300);
      }
      if (inZhugongZone && !wasInZhugongZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetScrollZhugong) bottomSheetScrollZhugong.scrollTop = 0;
        if (popupZhugong) popupZhugong.classList.remove('hidden');
        achievementUnlock('zhugong');
        requestAnimationFrame(function () {
          if (bottomSheetZhugong) bottomSheetZhugong.classList.add('open');
          if (scrollProgressBarZhugong) scrollProgressBarZhugong.style.top = '0%';
        });
      } else if (!inZhugongZone && wasInZhugongZone) {
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupZhugong) popupZhugong.classList.add('hidden'); }, 300);
      }
      var platformPopupOpenedThisFrame = false;
      if (inBentoZone && !wasInBentoZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (popupBento) popupBento.classList.remove('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.add('hidden');
        if (popupElectronicBoardRight) popupElectronicBoardRight.classList.add('hidden');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        achievementUnlock('bento');
        requestAnimationFrame(function () {
          if (bottomSheetBento) bottomSheetBento.classList.add('open');
        });
      } else if (!inBentoZone && wasInBentoZone) {
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupBento) popupBento.classList.add('hidden'); }, 300);
      }
      if (inToiletZone && !wasInToiletZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollToilet) bottomSheetScrollToilet.scrollTop = 0;
        if (popupToilet) popupToilet.classList.remove('hidden');
        achievementUnlock('toilet');
        requestAnimationFrame(function () {
          if (bottomSheetToilet) bottomSheetToilet.classList.add('open');
        });
      } else if (!inToiletZone && wasInToiletZone) {
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupToilet) popupToilet.classList.add('hidden'); }, 300);
      }
      if (inTicketZone && !wasInTicketZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollTicket) bottomSheetScrollTicket.scrollTop = 0;
        if (popupTicket) popupTicket.classList.remove('hidden');
        achievementUnlock('ticket');
        requestAnimationFrame(function () {
          if (bottomSheetTicket) bottomSheetTicket.classList.add('open');
        });
      } else if (!inTicketZone && wasInTicketZone) {
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupTicket) popupTicket.classList.add('hidden'); }, 300);
      }
      if (inBookshelfZone && !wasInBookshelfZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollBookshelf) bottomSheetScrollBookshelf.scrollTop = 0;
        if (popupBookshelf) popupBookshelf.classList.remove('hidden');
        achievementUnlock('bookshelf');
        requestAnimationFrame(function () {
          if (bottomSheetBookshelf) bottomSheetBookshelf.classList.add('open');
        });
      } else if (!inBookshelfZone && wasInBookshelfZone) {
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupBookshelf) popupBookshelf.classList.add('hidden'); }, 300);
      }
      if (inNoticeZone && !wasInNoticeZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollNotice) bottomSheetScrollNotice.scrollTop = 0;
        if (popupNotice) popupNotice.classList.remove('hidden');
        achievementUnlock('notice');
        requestAnimationFrame(function () {
          if (bottomSheetNotice) bottomSheetNotice.classList.add('open');
        });
      } else if (!inNoticeZone && wasInNoticeZone) {
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupNotice) popupNotice.classList.add('hidden'); }, 300);
      }
      if (inShinonggongshangZone && !wasInShinonggongshangZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollShinonggongshang) bottomSheetScrollShinonggongshang.scrollTop = 0;
        if (popupShinonggongshang) popupShinonggongshang.classList.remove('hidden');
        achievementUnlock('shinonggongshang');
        requestAnimationFrame(function () {
          if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.add('open');
        });
      } else if (!inShinonggongshangZone && wasInShinonggongshangZone) {
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden'); }, 300);
      }
      if (inStationSignZone && !wasInStationSignZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.add('hidden');
        if (popupElectronicBoardRight) popupElectronicBoardRight.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollStationSign) bottomSheetScrollStationSign.scrollTop = 0;
        if (popupStationSign) popupStationSign.classList.remove('hidden');
        achievementUnlock('stationSign');
        requestAnimationFrame(function () {
          if (bottomSheetStationSign) bottomSheetStationSign.classList.add('open');
        });
      } else if (!inStationSignZone && wasInStationSignZone) {
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupStationSign) popupStationSign.classList.add('hidden'); }, 300);
      }
      if (inElectronicBoardLeftZone && !wasInElectronicBoardLeftZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.add('hidden');
        if (popupElectronicBoardRight) popupElectronicBoardRight.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollElectronicBoardLeft) bottomSheetScrollElectronicBoardLeft.scrollTop = 0;
        if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.remove('hidden');
        achievementUnlock('electronicBoardLeft');
        requestAnimationFrame(function () {
          if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.add('open');
        });
      } else if (!inElectronicBoardLeftZone && wasInElectronicBoardLeftZone) {
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.add('hidden'); }, 300);
      }
      if (inElectronicBoardRightZone && !wasInElectronicBoardRightZone && !platformPopupOpenedThisFrame) {
        platformPopupOpenedThisFrame = true;
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupBento) popupBento.classList.add('hidden');
        if (popupToilet) popupToilet.classList.add('hidden');
        if (popupTicket) popupTicket.classList.add('hidden');
        if (popupBookshelf) popupBookshelf.classList.add('hidden');
        if (popupNotice) popupNotice.classList.add('hidden');
        if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden');
        if (popupStationSign) popupStationSign.classList.add('hidden');
        if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.add('hidden');
        if (popupElectronicBoardRight) popupElectronicBoardRight.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetBento) bottomSheetBento.classList.remove('open');
        if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
        if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
        if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
        if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
        if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
        if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
        if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        if (bottomSheetScrollElectronicBoardRight) bottomSheetScrollElectronicBoardRight.scrollTop = 0;
        if (popupElectronicBoardRight) popupElectronicBoardRight.classList.remove('hidden');
        achievementUnlock('electronicBoardRight');
        requestAnimationFrame(function () {
          if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.add('open');
        });
      } else if (!inElectronicBoardRightZone && wasInElectronicBoardRightZone) {
        if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupElectronicBoardRight) popupElectronicBoardRight.classList.add('hidden'); }, 300);
      }

      // 車廂3 車窗1：靠近時開啟「威權象徵的處置」影片對話框
      if (inCar3WindowZone && !wasInCar3WindowZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (popupCar3Window) popupCar3Window.classList.remove('hidden');
        if (popupCar3Window2) popupCar3Window2.classList.add('hidden');
        achievementUnlock('car3Window');
        requestAnimationFrame(function () {
          if (bottomSheetCar3Window) bottomSheetCar3Window.classList.add('open');
          if (videoCar3Window) {
            try {
              videoCar3Window.currentTime = 0;
              videoCar3Window.play();
            } catch (e) {}
          }
        });
      } else if (!inCar3WindowZone && wasInCar3WindowZone) {
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (videoCar3Window) {
          try {
            videoCar3Window.pause();
            videoCar3Window.currentTime = 0;
          } catch (e) {}
        }
        releasePopupLock();
        setTimeout(function () { if (popupCar3Window) popupCar3Window.classList.add('hidden'); }, 300);
      }

      // 車廂3 車窗2：靠近時開啟「不當黨產的規劃應用」影片對話框
      if (inCar3Window2Zone && !wasInCar3Window2Zone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupCar3Window) popupCar3Window.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (popupCar3Window2) popupCar3Window2.classList.remove('hidden');
        achievementUnlock('car3Window2');
        requestAnimationFrame(function () {
          if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.add('open');
          if (videoCar3Window2) {
            try {
              videoCar3Window2.currentTime = 0;
              videoCar3Window2.play();
            } catch (e) {}
          }
        });
      } else if (!inCar3Window2Zone && wasInCar3Window2Zone) {
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (videoCar3Window2) {
          try {
            videoCar3Window2.pause();
            videoCar3Window2.currentTime = 0;
          } catch (e) {}
        }
        releasePopupLock();
        setTimeout(function () { if (popupCar3Window2) popupCar3Window2.classList.add('hidden'); }, 300);
      }

      // 車廂2 ORC 文件：靠近時開啟圖片對話框
      if (inCar2OrcZone && !wasInCar2OrcZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupCar2Doc2) popupCar2Doc2.classList.add('hidden');
        if (popupCar2Doc3) popupCar2Doc3.classList.add('hidden');
        if (popupCar2Doc4) popupCar2Doc4.classList.add('hidden');
        if (popupCar3Window) popupCar3Window.classList.add('hidden');
        if (popupCar3Window2) popupCar3Window2.classList.add('hidden');
        if (popupCar3Window3) popupCar3Window3.classList.add('hidden');
        if (popupCar3Door) popupCar3Door.classList.add('hidden');
        if (popupCar3Cart) popupCar3Cart.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar2Doc2) bottomSheetCar2Doc2.classList.remove('open');
        if (bottomSheetCar2Doc3) bottomSheetCar2Doc3.classList.remove('open');
        if (bottomSheetCar2Doc4) bottomSheetCar2Doc4.classList.remove('open');
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (bottomSheetCar3Window3) bottomSheetCar3Window3.classList.remove('open');
        if (bottomSheetCar3Door) bottomSheetCar3Door.classList.remove('open');
        if (bottomSheetCar3Cart) bottomSheetCar3Cart.classList.remove('open');
        if (bottomSheetScrollCar2Orc) bottomSheetScrollCar2Orc.scrollTop = 0;
        if (scrollProgressBarCar2Orc) scrollProgressBarCar2Orc.style.top = '0%';
        if (popupCar2Orc) popupCar2Orc.classList.remove('hidden');
        achievementUnlock('car2Orc');
        requestAnimationFrame(function () {
          if (bottomSheetCar2Orc) bottomSheetCar2Orc.classList.add('open');
        });
      } else if (!inCar2OrcZone && wasInCar2OrcZone) {
        if (bottomSheetCar2Orc) bottomSheetCar2Orc.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupCar2Orc) popupCar2Orc.classList.add('hidden'); }, 300);
      }

      // 車廂2 文件2：靠近時開啟「政治檔案開放」對話框
      if (inCar2Doc2Zone && !wasInCar2Doc2Zone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupCar2Orc) popupCar2Orc.classList.add('hidden');
        if (popupCar2Doc3) popupCar2Doc3.classList.add('hidden');
        if (popupCar2Doc4) popupCar2Doc4.classList.add('hidden');
        if (popupCar3Window) popupCar3Window.classList.add('hidden');
        if (popupCar3Window2) popupCar3Window2.classList.add('hidden');
        if (popupCar3Window3) popupCar3Window3.classList.add('hidden');
        if (popupCar3Door) popupCar3Door.classList.add('hidden');
        if (popupCar3Cart) popupCar3Cart.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar2Orc) bottomSheetCar2Orc.classList.remove('open');
        if (bottomSheetCar2Doc3) bottomSheetCar2Doc3.classList.remove('open');
        if (bottomSheetCar2Doc4) bottomSheetCar2Doc4.classList.remove('open');
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (bottomSheetCar3Window3) bottomSheetCar3Window3.classList.remove('open');
        if (bottomSheetCar3Door) bottomSheetCar3Door.classList.remove('open');
        if (bottomSheetCar3Cart) bottomSheetCar3Cart.classList.remove('open');
        if (bottomSheetScrollCar2Doc2) bottomSheetScrollCar2Doc2.scrollTop = 0;
        if (scrollProgressBarCar2Doc2) scrollProgressBarCar2Doc2.style.top = '0%';
        if (popupCar2Doc2) popupCar2Doc2.classList.remove('hidden');
        achievementUnlock('car2Doc2');
        requestAnimationFrame(function () {
          if (bottomSheetCar2Doc2) bottomSheetCar2Doc2.classList.add('open');
        });
      } else if (!inCar2Doc2Zone && wasInCar2Doc2Zone) {
        if (bottomSheetCar2Doc2) bottomSheetCar2Doc2.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupCar2Doc2) popupCar2Doc2.classList.add('hidden'); }, 300);
      }

      // 車廂2 文件3：靠近時開啟「權利回復」對話框
      if (inCar2Doc3Zone && !wasInCar2Doc3Zone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupCar2Orc) popupCar2Orc.classList.add('hidden');
        if (popupCar2Doc2) popupCar2Doc2.classList.add('hidden');
        if (popupCar2Doc4) popupCar2Doc4.classList.add('hidden');
        if (popupCar3Window) popupCar3Window.classList.add('hidden');
        if (popupCar3Window2) popupCar3Window2.classList.add('hidden');
        if (popupCar3Window3) popupCar3Window3.classList.add('hidden');
        if (popupCar3Door) popupCar3Door.classList.add('hidden');
        if (popupCar3Cart) popupCar3Cart.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar2Orc) bottomSheetCar2Orc.classList.remove('open');
        if (bottomSheetCar2Doc2) bottomSheetCar2Doc2.classList.remove('open');
        if (bottomSheetCar2Doc4) bottomSheetCar2Doc4.classList.remove('open');
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (bottomSheetCar3Window3) bottomSheetCar3Window3.classList.remove('open');
        if (bottomSheetCar3Door) bottomSheetCar3Door.classList.remove('open');
        if (bottomSheetCar3Cart) bottomSheetCar3Cart.classList.remove('open');
        if (bottomSheetScrollCar2Doc3) bottomSheetScrollCar2Doc3.scrollTop = 0;
        if (scrollProgressBarCar2Doc3) scrollProgressBarCar2Doc3.style.top = '0%';
        if (popupCar2Doc3) popupCar2Doc3.classList.remove('hidden');
        achievementUnlock('car2Doc3');
        requestAnimationFrame(function () {
          if (bottomSheetCar2Doc3) bottomSheetCar2Doc3.classList.add('open');
        });
      } else if (!inCar2Doc3Zone && wasInCar2Doc3Zone) {
        if (bottomSheetCar2Doc3) bottomSheetCar2Doc3.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupCar2Doc3) popupCar2Doc3.classList.add('hidden'); }, 300);
      }

      // 車廂2 文件4：靠近時開啟「行政不法」對話框
      if (inCar2Doc4Zone && !wasInCar2Doc4Zone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupCar2Orc) popupCar2Orc.classList.add('hidden');
        if (popupCar2Doc2) popupCar2Doc2.classList.add('hidden');
        if (popupCar2Doc3) popupCar2Doc3.classList.add('hidden');
        if (popupCar3Window) popupCar3Window.classList.add('hidden');
        if (popupCar3Window2) popupCar3Window2.classList.add('hidden');
        if (popupCar3Window3) popupCar3Window3.classList.add('hidden');
        if (popupCar3Door) popupCar3Door.classList.add('hidden');
        if (popupCar3Cart) popupCar3Cart.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar2Orc) bottomSheetCar2Orc.classList.remove('open');
        if (bottomSheetCar2Doc2) bottomSheetCar2Doc2.classList.remove('open');
        if (bottomSheetCar2Doc3) bottomSheetCar2Doc3.classList.remove('open');
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (bottomSheetCar3Window3) bottomSheetCar3Window3.classList.remove('open');
        if (bottomSheetCar3Door) bottomSheetCar3Door.classList.remove('open');
        if (bottomSheetCar3Cart) bottomSheetCar3Cart.classList.remove('open');
        if (bottomSheetScrollCar2Doc4) bottomSheetScrollCar2Doc4.scrollTop = 0;
        if (scrollProgressBarCar2Doc4) scrollProgressBarCar2Doc4.style.top = '0%';
        if (popupCar2Doc4) popupCar2Doc4.classList.remove('hidden');
        achievementUnlock('car2Doc4');
        requestAnimationFrame(function () {
          if (bottomSheetCar2Doc4) bottomSheetCar2Doc4.classList.add('open');
        });
      } else if (!inCar2Doc4Zone && wasInCar2Doc4Zone) {
        if (bottomSheetCar2Doc4) bottomSheetCar2Doc4.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupCar2Doc4) popupCar2Doc4.classList.add('hidden'); }, 300);
      }

      // 車廂3 車窗3：靠近時開啟「創傷修復」影片對話框
      if (inCar3Window3Zone && !wasInCar3Window3Zone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupCar3Window) popupCar3Window.classList.add('hidden');
        if (popupCar3Window2) popupCar3Window2.classList.add('hidden');
        if (popupCar3Door) popupCar3Door.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (bottomSheetCar3Door) bottomSheetCar3Door.classList.remove('open');
        if (popupCar3Window3) popupCar3Window3.classList.remove('hidden');
        achievementUnlock('car3Window3');
        requestAnimationFrame(function () {
          if (bottomSheetCar3Window3) bottomSheetCar3Window3.classList.add('open');
          if (videoCar3Window3) {
            try {
              videoCar3Window3.currentTime = 0;
              videoCar3Window3.play();
            } catch (e) {}
          }
        });
      } else if (!inCar3Window3Zone && wasInCar3Window3Zone) {
        if (bottomSheetCar3Window3) bottomSheetCar3Window3.classList.remove('open');
        if (videoCar3Window3) {
          try {
            videoCar3Window3.pause();
            videoCar3Window3.currentTime = 0;
          } catch (e) {}
        }
        releasePopupLock();
        setTimeout(function () { if (popupCar3Window3) popupCar3Window3.classList.add('hidden'); }, 300);
      }

      // 車廂3 車門：靠近時開啟「已抵達：民主站」影片對話框
      if (inCar3DoorZone && !wasInCar3DoorZone) {
        popup.classList.add('hidden');
        if (popupHuang) popupHuang.classList.add('hidden');
        if (popupDu) popupDu.classList.add('hidden');
        if (popupLiu) popupLiu.classList.add('hidden');
        if (popupYang) popupYang.classList.add('hidden');
        if (popupWang) popupWang.classList.add('hidden');
        if (popupXu) popupXu.classList.add('hidden');
        if (popupZhugong) popupZhugong.classList.add('hidden');
        if (popupCar3Window) popupCar3Window.classList.add('hidden');
        if (popupCar3Window2) popupCar3Window2.classList.add('hidden');
        if (bottomSheet) bottomSheet.classList.remove('open');
        if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
        if (bottomSheetDu) bottomSheetDu.classList.remove('open');
        if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
        if (bottomSheetYang) bottomSheetYang.classList.remove('open');
        if (bottomSheetWang) bottomSheetWang.classList.remove('open');
        if (bottomSheetXu) bottomSheetXu.classList.remove('open');
        if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
        if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
        if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
        if (popupCar3Door) popupCar3Door.classList.remove('hidden');
        achievementUnlock('car3Door');
        requestAnimationFrame(function () {
          if (bottomSheetCar3Door) bottomSheetCar3Door.classList.add('open');
          if (videoCar3Door) {
            try {
              videoCar3Door.currentTime = 0;
              videoCar3Door.play();
            } catch (e) {}
          }
        });
      } else if (!inCar3DoorZone && wasInCar3DoorZone) {
        if (bottomSheetCar3Door) bottomSheetCar3Door.classList.remove('open');
        if (videoCar3Door) {
          try {
            videoCar3Door.pause();
            videoCar3Door.currentTime = 0;
          } catch (e) {}
        }
        releasePopupLock();
        setTimeout(function () { if (popupCar3Door) popupCar3Door.classList.add('hidden'); }, 300);
      }

      // 車廂3 餐車：靠近時開啟「分享本遊戲」對話框
      if (inCar3CartZone && !wasInCar3CartZone) {
        try {
          var shareUrl = 'https://sam0404044.github.io/Island-waiting-room/';
          if (car3CartShareUrl) {
            car3CartShareUrl.textContent = shareUrl;
          }
        } catch (e) {}
        if (popupCar3Cart) popupCar3Cart.classList.remove('hidden');
        achievementUnlock('car3Cart');
        requestAnimationFrame(function () {
          if (bottomSheetCar3Cart) bottomSheetCar3Cart.classList.add('open');
        });
      } else if (!inCar3CartZone && wasInCar3CartZone) {
        if (bottomSheetCar3Cart) bottomSheetCar3Cart.classList.remove('open');
        releasePopupLock();
        setTimeout(function () { if (popupCar3Cart) popupCar3Cart.classList.add('hidden'); }, 300);
      }

      wasInZone = inZone;
      wasInHuangZone = inHuangZone;
      wasInDuZone = inDuZone;
      wasInLiuZone = inLiuZone;
      wasInYangZone = inYangZone;
      wasInWangZone = inWangZone;
      wasInXuZone = inXuZone;
      wasInCar2OrcZone = inCar2OrcZone;
      wasInCar2Doc2Zone = inCar2Doc2Zone;
      wasInCar2Doc3Zone = inCar2Doc3Zone;
      wasInCar2Doc4Zone = inCar2Doc4Zone;
      wasInZhugongZone = inZhugongZone;
      wasInBentoZone = inBentoZone;
      wasInToiletZone = inToiletZone;
      wasInTicketZone = inTicketZone;
      wasInBookshelfZone = inBookshelfZone;
      wasInNoticeZone = inNoticeZone;
      wasInShinonggongshangZone = inShinonggongshangZone;
      wasInStationSignZone = inStationSignZone;
      wasInElectronicBoardLeftZone = inElectronicBoardLeftZone;
      wasInElectronicBoardRightZone = inElectronicBoardRightZone;
      wasInCar3Window2Zone = inCar3Window2Zone;
      wasInCar3WindowZone = inCar3WindowZone;
       wasInCar3Window3Zone = inCar3Window3Zone;
      wasInCar3CartZone = inCar3CartZone;
      wasInCar3DoorZone = inCar3DoorZone;
    }

    var DEBUG_CAMERA = false;

    function draw() {
      var viewW = camera.viewW;
      var viewH = camera.viewH;
      if (viewW <= 0 || viewH <= 0) return;

      ctx.setTransform(dpr * currentScale, 0, 0, dpr * currentScale, 0, 0);

      ctx.clearRect(0, 0, viewW, viewH);

      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, viewW, viewH);

      ctx.save();
      ctx.beginPath();
      ctx.rect(0, 0, viewW, viewH);
      ctx.clip();
      ctx.translate(-camera.x, -camera.y);

      const cur = mapImages[currentMapIndex];
      const usePlatformOpen = currentMapIndex === 0 && platformCarriageOpen && cur.baseOpen && cur.baseOpen.complete && cur.baseOpen.naturalWidth > 0;
      const drawBase = usePlatformOpen ? cur.baseOpen : cur.base;
      const drawForeground = usePlatformOpen ? cur.foregroundOpen : cur.foreground;
      if (drawBase.complete && drawBase.naturalWidth > 0) {
        ctx.drawImage(drawBase, 0, 0, WORLD_WIDTH, WORLD_HEIGHT, 0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      } else {
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      }

      if (debugPanel && !debugPanel.classList.contains('hidden') && blockedTiles.length > 0) {
        ctx.fillStyle = 'rgba(255, 0, 0, 0.4)';
        for (let row = 0; row < blockedTiles.length; row++) {
          for (let col = 0; col < blockedTiles[row].length; col++) {
            if (blockedTiles[row][col]) {
              ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
          }
        }
      }

      // DEBUG: green square = transmission point (teleport zone by col/row)
      if (debugPanel && !debugPanel.classList.contains('hidden')) {
        ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
        if (currentMapIndex === 0) {
          if (TRANSMISSION_ZONES.platform) {
            TRANSMISSION_ZONES.platform.forEach(function (z) {
              for (let col = z.col1; col <= z.col2; col++) {
                for (let row = z.row1; row <= z.row2; row++) {
                  ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
          if (TRANSMISSION_ZONES.platformClosedToCar2) {
            TRANSMISSION_ZONES.platformClosedToCar2.forEach(function (z) {
              for (let col = z.col1; col <= z.col2; col++) {
                for (let row = z.row1; row <= z.row2; row++) {
                  ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
        }
        if (currentMapIndex === 1) {
          if (TRANSMISSION_ZONES.car2ToPlatformOpen) {
            TRANSMISSION_ZONES.car2ToPlatformOpen.forEach(function (z) {
              for (let c = z.col1; c <= z.col2; c++) {
                for (let r = z.row1; r <= z.row2; r++) {
                  ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
          if (TRANSMISSION_ZONES.car2ToCar3) {
            TRANSMISSION_ZONES.car2ToCar3.forEach(function (z) {
              for (let c = z.col1; c <= z.col2; c++) {
                for (let r = z.row1; r <= z.row2; r++) {
                  ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
              }
            });
          }
        }
        if (currentMapIndex === 2 && TRANSMISSION_ZONES.car3ToCar2) {
          TRANSMISSION_ZONES.car3ToCar2.forEach(function (z) {
            for (let c = z.col1; c <= z.col2; c++) {
              for (let r = z.row1; r <= z.row2; r++) {
                ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
              }
            }
          });
        }
      }

      if (currentMapIndex === 0 && platformCarriageOpen) {
        // 周清月：與其他物件同高（row 10 上緣 y=320）
        var objX = interactionZone.x + interactionZone.width / 2;
        var zhouY = 10 * TILE_SIZE; // 320，與黃家母女等一致
        if (isNearZoneNow || isInZoneNow) {
          var t = Date.now() / 300;
          var pulse = (Math.sin(t) + 1) / 2;
          var baseRadius = isInZoneNow ? 30 : 22;
          var extra = isInZoneNow ? 10 : 6;
          var radius = baseRadius + extra * pulse;
          var gradient = ctx.createRadialGradient(
            objX, zhouY, 4,
            objX, zhouY, radius
          );
          gradient.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradient.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(objX, zhouY, radius, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var maxCardSize = 120; // 放大 2 倍顯示圖示

        // 周清月圖示
        var useActive = isNearZoneNow || isInZoneNow;
        var icon = useActive ? cardActiveImage : cardIdleImage;
        if (icon.complete && icon.naturalWidth > 0) {
          var nw = icon.naturalWidth;
          var nh = icon.naturalHeight;
          var scale = Math.min(maxCardSize / nw, maxCardSize / nh, 1);
          var drawW = nw * scale;
          var drawH = nh * scale;
          ctx.drawImage(icon, objX - drawW / 2, zhouY - drawH / 2, drawW, drawH);
        }

        // 黃家母女圖示：位置固定在 col 23, row 10，往上半格
        var huangX = 23 * TILE_SIZE + TILE_SIZE / 2;
        var huangY = 10 * TILE_SIZE; // 320
        if (isNearHuangNow) {
          var tH = Date.now() / 300;
          var pulseH = (Math.sin(tH) + 1) / 2;
          var radiusH = 22 + 6 * pulseH;
          var gradH = ctx.createRadialGradient(huangX, huangY, 4, huangX, huangY, radiusH);
          gradH.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradH.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradH;
          ctx.beginPath();
          ctx.arc(huangX, huangY, radiusH, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var huangIcon = isNearHuangNow ? huangActiveImage : huangIdleImage;
        if (huangIcon.complete && huangIcon.naturalWidth > 0) {
          var hnw = huangIcon.naturalWidth;
          var hnh = huangIcon.naturalHeight;
          var hscale = Math.min(maxCardSize / hnw, maxCardSize / hnh, 1);
          var hW = hnw * hscale;
          var hH = hnh * hscale;
          ctx.drawImage(huangIcon, huangX - hW / 2, huangY - hH / 2, hW, hH);
        }
        // 杜孝生圖示：位置 col 26, row 10
        var duX = 26 * TILE_SIZE + TILE_SIZE / 2;
        var duY = 10 * TILE_SIZE;
        if (isNearDuNow) {
          var tD = Date.now() / 300;
          var pulseD = (Math.sin(tD) + 1) / 2;
          var radiusD = 22 + 6 * pulseD;
          var gradD = ctx.createRadialGradient(duX, duY, 4, duX, duY, radiusD);
          gradD.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradD.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradD;
          ctx.beginPath();
          ctx.arc(duX, duY, radiusD, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var duIcon = isNearDuNow ? duActiveImage : duIdleImage;
        if (duIcon.complete && duIcon.naturalWidth > 0) {
          var dnw = duIcon.naturalWidth;
          var dnh = duIcon.naturalHeight;
          var dscale = Math.min(maxCardSize / dnw, maxCardSize / dnh, 1);
          var dW = dnw * dscale;
          var dH = dnh * dscale;
          ctx.drawImage(duIcon, duX - dW / 2, duY - dH / 2, dW, dH);
        }
        // 劉永祥圖示：位置 col 29, row 10
        var liuX = 29 * TILE_SIZE + TILE_SIZE / 2;
        var liuY = 10 * TILE_SIZE;
        if (isNearLiuNow) {
          var tL = Date.now() / 300;
          var pulseL = (Math.sin(tL) + 1) / 2;
          var radiusL = 22 + 6 * pulseL;
          var gradL = ctx.createRadialGradient(liuX, liuY, 4, liuX, liuY, radiusL);
          gradL.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradL.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradL;
          ctx.beginPath();
          ctx.arc(liuX, liuY, radiusL, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var liuIcon = isNearLiuNow ? liuActiveImage : liuIdleImage;
        if (liuIcon.complete && liuIcon.naturalWidth > 0) {
          var lnw = liuIcon.naturalWidth;
          var lnh = liuIcon.naturalHeight;
          var lscale = Math.min(maxCardSize / lnw, maxCardSize / lnh, 1);
          var lW = lnw * lscale;
          var lH = lnh * lscale;
          ctx.drawImage(liuIcon, liuX - lW / 2, liuY - lH / 2, lW, lH);
        }
        // 陽翰的情報報告：靠近圖 / 說明圖，位置 col 33, row 10
        var yangX = 33 * TILE_SIZE + TILE_SIZE / 2;
        var yangY = 10 * TILE_SIZE;
        if (isNearYangNow) {
          var tY = Date.now() / 300;
          var pulseY = (Math.sin(tY) + 1) / 2;
          var radiusY = 22 + 6 * pulseY;
          var gradY = ctx.createRadialGradient(yangX, yangY, 4, yangX, yangY, radiusY);
          gradY.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradY.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradY;
          ctx.beginPath();
          ctx.arc(yangX, yangY, radiusY, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var yangIcon = isNearYangNow ? yangActiveImage : yangIdleImage;
        if (yangIcon.complete && yangIcon.naturalWidth > 0) {
          var ynw = yangIcon.naturalWidth;
          var ynh = yangIcon.naturalHeight;
          var yscale = Math.min(maxCardSize / ynw, maxCardSize / ynh, 1);
          var yW = ynw * yscale;
          var yH = ynh * yscale;
          ctx.drawImage(yangIcon, yangX - yW / 2, yangY - yH / 2, yW, yH);
        }
        // 王再傳的黨員手冊：位置 col 43, row 10
        var wangX = 43 * TILE_SIZE + TILE_SIZE / 2;
        var wangY = 10 * TILE_SIZE;
        if (isNearWangNow) {
          var tW = Date.now() / 300;
          var pulseW = (Math.sin(tW) + 1) / 2;
          var radiusW = 22 + 6 * pulseW;
          var gradW = ctx.createRadialGradient(wangX, wangY, 4, wangX, wangY, radiusW);
          gradW.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradW.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradW;
          ctx.beginPath();
          ctx.arc(wangX, wangY, radiusW, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var wangIcon = isNearWangNow ? wangActiveImage : wangIdleImage;
        if (wangIcon.complete && wangIcon.naturalWidth > 0) {
          var wnw = wangIcon.naturalWidth;
          var wnh = wangIcon.naturalHeight;
          var wscale = Math.min(maxCardSize / wnw, maxCardSize / wnh, 1);
          var wW = wnw * wscale;
          var wH = wnh * wscale;
          ctx.drawImage(wangIcon, wangX - wW / 2, wangY - wH / 2, wW, wH);
        }
        // 許宗力的海外學人回國服務登記表：位置 col 49, row 10
        var xuX = 49 * TILE_SIZE + TILE_SIZE / 2;
        var xuY = 10 * TILE_SIZE;
        if (isNearXuNow) {
          var tXu = Date.now() / 300;
          var pulseXu = (Math.sin(tXu) + 1) / 2;
          var radiusXu = 22 + 6 * pulseXu;
          var gradXu = ctx.createRadialGradient(xuX, xuY, 4, xuX, xuY, radiusXu);
          gradXu.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradXu.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradXu;
          ctx.beginPath();
          ctx.arc(xuX, xuY, radiusXu, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var xuIcon = isNearXuNow ? xuActiveImage : xuIdleImage;
        if (xuIcon.complete && xuIcon.naturalWidth > 0) {
          var xnw = xuIcon.naturalWidth;
          var xnh = xuIcon.naturalHeight;
          var xscale = Math.min(maxCardSize / xnw, maxCardSize / xnh, 1);
          var xW = xnw * xscale;
          var xH = xnh * xscale;
          ctx.drawImage(xuIcon, xuX - xW / 2, xuY - xH / 2, xW, xH);
        }
        // 竹工（新竹高工的塗鴉）：位置 col 45-46 row 10-11 中心
        var zhugongX = 45 * TILE_SIZE + TILE_SIZE;
        var zhugongY = 10 * TILE_SIZE + TILE_SIZE;
        if (isNearZhugongNow) {
          var tZg = Date.now() / 300;
          var pulseZg = (Math.sin(tZg) + 1) / 2;
          var radiusZg = 22 + 6 * pulseZg;
          var gradZg = ctx.createRadialGradient(zhugongX, zhugongY, 4, zhugongX, zhugongY, radiusZg);
          gradZg.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradZg.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradZg;
          ctx.beginPath();
          ctx.arc(zhugongX, zhugongY, radiusZg, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var zhugongIcon = isNearZhugongNow ? zhugongActiveImage : zhugongIdleImage;
        if (zhugongIcon.complete && zhugongIcon.naturalWidth > 0) {
          var zgnw = zhugongIcon.naturalWidth;
          var zgnh = zhugongIcon.naturalHeight;
          var zgscale = Math.min(maxCardSize / zgnw, maxCardSize / zgnh, 1);
          var zgW = zgnw * zgscale;
          var zgH = zgnh * zgscale;
          ctx.drawImage(zhugongIcon, zhugongX - zgW / 2, zhugongY - zgH / 2, zgW, zgH);
        }
      }

      // 月台 便當攤：再往左 1/4 格（42 格左緣）, row 22（裝飾，靠近時發光較大）
      if (currentMapIndex === 0 && bentoStallImage.complete && bentoStallImage.naturalWidth > 0) {
        var bentoCenterX = 42 * TILE_SIZE;
        var bentoCenterY = 22 * TILE_SIZE + TILE_SIZE / 2;
        if (isNearBentoNow) {
          var tBento = Date.now() / 300;
          var pulseBento = (Math.sin(tBento) + 1) / 2;
          var radiusBento = 48 + 16 * pulseBento;
          var gradBento = ctx.createRadialGradient(bentoCenterX, bentoCenterY, 8, bentoCenterX, bentoCenterY, radiusBento);
          gradBento.addColorStop(0, 'rgba(255, 255, 200, 0.95)');
          gradBento.addColorStop(0.4, 'rgba(255, 255, 180, 0.6)');
          gradBento.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradBento;
          ctx.beginPath();
          ctx.arc(bentoCenterX, bentoCenterY, radiusBento, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var bentoMax = 96;
        var bnw = bentoStallImage.naturalWidth;
        var bnh = bentoStallImage.naturalHeight;
        var bscale = Math.min(bentoMax / bnw, bentoMax / bnh, 1);
        var bW = bnw * bscale;
        var bH = bnh * bscale;
        ctx.drawImage(bentoStallImage, bentoCenterX - bW / 2, bentoCenterY - bH / 2, bW, bH);
      }

      // 月台 廁所：y 與便當對齊，往右半格再往左 5px（裝飾，靠近時發光）
      if (currentMapIndex === 0 && toiletImage.complete && toiletImage.naturalWidth > 0) {
        var toiletCenterX = 13 * TILE_SIZE + TILE_SIZE + TILE_SIZE / 2;
        var toiletCenterY = 22 * TILE_SIZE + TILE_SIZE / 2;
        if (isNearToiletNow) {
          var tToilet = Date.now() / 300;
          var pulseToilet = (Math.sin(tToilet) + 1) / 2;
          var radiusToilet = 40 + 12 * pulseToilet;
          var gradToilet = ctx.createRadialGradient(toiletCenterX, toiletCenterY, 6, toiletCenterX, toiletCenterY, radiusToilet);
          gradToilet.addColorStop(0, 'rgba(255, 255, 200, 0.9)');
          gradToilet.addColorStop(0.5, 'rgba(255, 255, 180, 0.5)');
          gradToilet.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradToilet;
          ctx.beginPath();
          ctx.arc(toiletCenterX, toiletCenterY, radiusToilet, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var tW = toiletImage.naturalWidth;
        var tH = toiletImage.naturalHeight;
        ctx.drawImage(toiletImage, toiletCenterX - tW / 2, toiletCenterY - tH / 2, tW, tH);
      }

      // 月台 售票機：col 17～23、row 21～22 之間（中心 col 20, row 21 格心，往上一格）
      if (currentMapIndex === 0 && ticketMachineImage.complete && ticketMachineImage.naturalWidth > 0) {
        var ticketCenterX = 20 * TILE_SIZE + TILE_SIZE / 2;
        var ticketCenterY = 21 * TILE_SIZE + TILE_SIZE / 2;
        var tickW = ticketMachineImage.naturalWidth;
        var tickH = ticketMachineImage.naturalHeight;
        ctx.drawImage(ticketMachineImage, ticketCenterX - tickW / 2, ticketCenterY - tickH / 2, tickW, tickH);
      }

      // 月台 書架：col 31～38 之間再往右一格、往上一格、再往下 16px、往上 8px，原始尺寸
      if (currentMapIndex === 0 && bookshelfImage.complete && bookshelfImage.naturalWidth > 0) {
        var bookshelfCenterX = (31 + 38) / 2 * TILE_SIZE + TILE_SIZE;
        var bookshelfCenterY = 21 * TILE_SIZE + TILE_SIZE / 2 + 8;
        var bookW = bookshelfImage.naturalWidth;
        var bookH = bookshelfImage.naturalHeight;
        ctx.drawImage(bookshelfImage, bookshelfCenterX - bookW / 2, bookshelfCenterY - bookH / 2, bookW, bookH);
      }

      // 月台 告示：col 39 左緣、row 26（政治案件高峰期，裝飾）
      if (currentMapIndex === 0 && noticeImage.complete && noticeImage.naturalWidth > 0) {
        var noticeCenterX = 39 * TILE_SIZE;
        var noticeCenterY = 26 * TILE_SIZE + TILE_SIZE / 2;
        var noticeW = noticeImage.naturalWidth;
        var noticeH = noticeImage.naturalHeight;
        ctx.drawImage(noticeImage, noticeCenterX - noticeW / 2, noticeCenterY - noticeH / 2, noticeW, noticeH);
      }

      // 月台 士農工商：col 16～19 之間、row 16，再往右上各 16px（裝飾）
      if (currentMapIndex === 0 && shinonggongshangImage.complete && shinonggongshangImage.naturalWidth > 0) {
        var sngsCenterX = (16 + 19) / 2 * TILE_SIZE + 16;
        var sngsCenterY = 16 * TILE_SIZE + TILE_SIZE / 2 - 16;
        var sngsW = shinonggongshangImage.naturalWidth;
        var sngsH = shinonggongshangImage.naturalHeight;
        ctx.drawImage(shinonggongshangImage, sngsCenterX - sngsW / 2, sngsCenterY - sngsH / 2, sngsW, sngsH);
      }

      // 月台 站名牌：col 34～35 之間、row 16，再往右上各 16px（裝飾）
      if (currentMapIndex === 0 && stationSignImage.complete && stationSignImage.naturalWidth > 0) {
        var signCenterX = (34 + 35) / 2 * TILE_SIZE + 16;
        var signCenterY = 16 * TILE_SIZE + TILE_SIZE / 2 - 16;
        var signW = stationSignImage.naturalWidth;
        var signH = stationSignImage.naturalHeight;
        ctx.drawImage(stationSignImage, signCenterX - signW / 2, signCenterY - signH / 2, signW, signH);
      }

      // 月台 電子看板左：col 25～26 之間、row 27，再往右往上各 16px（裝飾）
      if (currentMapIndex === 0 && electronicBoardLeftImage.complete && electronicBoardLeftImage.naturalWidth > 0) {
        var eblCenterX = (25 + 26) / 2 * TILE_SIZE + 16;
        var eblCenterY = 27 * TILE_SIZE + TILE_SIZE / 2 - 16;
        var eblW = electronicBoardLeftImage.naturalWidth;
        var eblH = electronicBoardLeftImage.naturalHeight;
        ctx.drawImage(electronicBoardLeftImage, eblCenterX - eblW / 2, eblCenterY - eblH / 2, eblW, eblH);
      }

      // 月台 電子看板右：col 29～30 之間、row 27，再往上 16px（裝飾）
      if (currentMapIndex === 0 && electronicBoardRightImage.complete && electronicBoardRightImage.naturalWidth > 0) {
        var ebrCenterX = (29 + 30) / 2 * TILE_SIZE + TILE_SIZE / 2;
        var ebrCenterY = 27 * TILE_SIZE + TILE_SIZE / 2 - 16;
        var ebrW = electronicBoardRightImage.naturalWidth;
        var ebrH = electronicBoardRightImage.naturalHeight;
        ctx.drawImage(electronicBoardRightImage, ebrCenterX - ebrW / 2, ebrCenterY - ebrH / 2, ebrW, ebrH);
      }

      // 月台 服務亭：col 27～28 之間、row 28（裝飾）
      if (currentMapIndex === 0 && serviceKioskImage.complete && serviceKioskImage.naturalWidth > 0) {
        var kioskCenterX = (27 + 28) / 2 * TILE_SIZE + TILE_SIZE / 2;
        var kioskCenterY = 28 * TILE_SIZE + TILE_SIZE / 2;
        var kioskW = serviceKioskImage.naturalWidth;
        var kioskH = serviceKioskImage.naturalHeight;
        ctx.drawImage(serviceKioskImage, kioskCenterX - kioskW / 2, kioskCenterY - kioskH / 2, kioskW, kioskH);
      }

      // 月台 盆栽：col 25 與 col 30, row 22（裝飾）
      if (currentMapIndex === 0 && potPlantImage.complete && potPlantImage.naturalWidth > 0) {
        var potW = potPlantImage.naturalWidth;
        var potH = potPlantImage.naturalHeight;
        var potY = 22 * TILE_SIZE + TILE_SIZE / 2;
        var potX1 = 25 * TILE_SIZE + TILE_SIZE / 2;
        var potX2 = 30 * TILE_SIZE + TILE_SIZE / 2;
        ctx.drawImage(potPlantImage, potX1 - potW / 2, potY - potH / 2, potW, potH);
        ctx.drawImage(potPlantImage, potX2 - potW / 2, potY - potH / 2, potW, potH);
      }

      // 車廂3 標語2：橫跨 col 24～49（26 格）、row 17 置中
      if (currentMapIndex === 2 && biaoyu2Image.complete && biaoyu2Image.naturalWidth > 0) {
        var biaoyu2Col1 = 24;
        var biaoyu2Col2 = 49;
        var biaoyu2W = (biaoyu2Col2 - biaoyu2Col1 + 1) * TILE_SIZE;
        var biaoyu2CenterX = (biaoyu2Col1 + biaoyu2Col2) / 2 * TILE_SIZE + TILE_SIZE / 2;
        var biaoyu2CenterY = 16 * TILE_SIZE + TILE_SIZE / 2;
        var bnw = biaoyu2Image.naturalWidth;
        var bnh = biaoyu2Image.naturalHeight;
        var bW = biaoyu2W;
        var bH = bnh * (biaoyu2W / bnw);
        ctx.drawImage(biaoyu2Image, biaoyu2CenterX - bW / 2, biaoyu2CenterY - bH / 2, bW, bH);
      }

      // 車廂3 站牌：以玩家提供的位置為中心，放大到整張地圖寬度的 3/4
      if (currentMapIndex === 2 && car3StopSignImage.complete && car3StopSignImage.naturalWidth > 0) {
        // 中心點：player.x ≈ 1173, player.y ≈ 320（比原位置往左一格）
        var stopX = 1173;
        var stopY = 320;
        var snw = car3StopSignImage.naturalWidth;
        var snh = car3StopSignImage.naturalHeight;
        // 將站牌圖寬度縮放為整張車廂3 地圖寬度的 3/4
        var targetW = WORLD_WIDTH * 0.75;
        var sScale = targetW / snw;
        var sW = snw * sScale;
        var sH = snh * sScale;
        ctx.drawImage(car3StopSignImage, stopX - sW / 2, stopY - sH / 2, sW, sH);
      }

      // 車廂3 車窗：三扇窗，靠近時加上更明顯的光暈（縮小為約 2 格寬）
      if (currentMapIndex === 2 && car3WindowImage.complete && car3WindowImage.naturalWidth > 0) {
        var winCenterX = 800;
        var winCenterY = 273;
        if (isNearCar3WindowNow) {
          var tWin = Date.now() / 300;
          var pulseWin = (Math.sin(tWin) + 1) / 2;
          var radiusWin = 32 + 12 * pulseWin;
          var gradWin = ctx.createRadialGradient(winCenterX, winCenterY, 4, winCenterX, winCenterY, radiusWin);
          gradWin.addColorStop(0, 'rgba(255, 255, 220, 1.0)');
          gradWin.addColorStop(0.4, 'rgba(255, 255, 200, 0.6)');
          gradWin.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradWin;
          ctx.beginPath();
          ctx.arc(winCenterX, winCenterY, radiusWin, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var wnw = car3WindowImage.naturalWidth;
        var wnh = car3WindowImage.naturalHeight;
        var targetW2 = TILE_SIZE * 2; // 約 2 格寬
        var wScale = targetW2 / wnw;
        var wW = wnw * wScale;
        var wH = wnh * wScale;
        // 車窗1
        ctx.drawImage(car3WindowImage, winCenterX - wW / 2, winCenterY - wH / 2, wW, wH);
        // 車窗2（同樣大小，中心 x=992, y=273）
        var win2CenterX = 992;
        var win2CenterY = 273;
        if (isNearCar3Window2Now) {
          var tWin2 = Date.now() / 300;
          var pulseWin2 = (Math.sin(tWin2) + 1) / 2;
          var radiusWin2 = 32 + 12 * pulseWin2;
          var gradWin2 = ctx.createRadialGradient(win2CenterX, win2CenterY, 4, win2CenterX, win2CenterY, radiusWin2);
          gradWin2.addColorStop(0, 'rgba(255, 255, 220, 1.0)');
          gradWin2.addColorStop(0.4, 'rgba(255, 255, 200, 0.6)');
          gradWin2.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradWin2;
          ctx.beginPath();
          ctx.arc(win2CenterX, win2CenterY, radiusWin2, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        ctx.drawImage(car3WindowImage, win2CenterX - wW / 2, win2CenterY - wH / 2, wW, wH);
        // 車窗3（創傷修復，中心 x=1280, y=273）
        var win3CenterX = 1280;
        var win3CenterY = 273;
        if (isNearCar3Window3Now) {
          var tWin3 = Date.now() / 300;
          var pulseWin3 = (Math.sin(tWin3) + 1) / 2;
          var radiusWin3 = 32 + 12 * pulseWin3;
          var gradWin3 = ctx.createRadialGradient(win3CenterX, win3CenterY, 4, win3CenterX, win3CenterY, radiusWin3);
          gradWin3.addColorStop(0, 'rgba(255, 255, 220, 1.0)');
          gradWin3.addColorStop(0.4, 'rgba(255, 255, 200, 0.6)');
          gradWin3.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradWin3;
          ctx.beginPath();
          ctx.arc(win3CenterX, win3CenterY, radiusWin3, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        ctx.drawImage(car3WindowImage, win3CenterX - wW / 2, win3CenterY - wH / 2, wW, wH);
      }

      // 車廂2 文件1：col 26, row 10（整體往左上 5px, 5px），靠近時光暈
      if (currentMapIndex === 1 && car2Doc1Image.complete && car2Doc1Image.naturalWidth > 0) {
        var doc1CenterX = 26 * TILE_SIZE + TILE_SIZE / 2 - 5;
        var doc1CenterY = 10 * TILE_SIZE - 10;
        if (isNearCar2OrcNow) {
          var tDoc1 = Date.now() / 300;
          var pulseDoc1 = (Math.sin(tDoc1) + 1) / 2;
          var radiusDoc1 = 28 + 10 * pulseDoc1;
          var gradDoc1 = ctx.createRadialGradient(doc1CenterX, doc1CenterY, 4, doc1CenterX, doc1CenterY, radiusDoc1);
          gradDoc1.addColorStop(0, 'rgba(255, 255, 220, 0.9)');
          gradDoc1.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradDoc1;
          ctx.beginPath();
          ctx.arc(doc1CenterX, doc1CenterY, radiusDoc1, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var doc1nw = car2Doc1Image.naturalWidth;
        var doc1nh = car2Doc1Image.naturalHeight;
        ctx.drawImage(car2Doc1Image, doc1CenterX - doc1nw / 2, doc1CenterY - doc1nh / 2, doc1nw, doc1nh);
      }

      // 車廂2 文件2：col 32, row 10（與文件1 同一水平高度），靠近時光暈
      if (currentMapIndex === 1 && car2Doc2Image.complete && car2Doc2Image.naturalWidth > 0) {
        var doc2CenterX = 32 * TILE_SIZE + TILE_SIZE / 2;
        var doc2CenterY = 10 * TILE_SIZE - 10;
        if (isNearCar2Doc2Now) {
          var tDoc2 = Date.now() / 300;
          var pulseDoc2 = (Math.sin(tDoc2) + 1) / 2;
          var radiusDoc2 = 28 + 10 * pulseDoc2;
          var gradDoc2 = ctx.createRadialGradient(doc2CenterX, doc2CenterY, 4, doc2CenterX, doc2CenterY, radiusDoc2);
          gradDoc2.addColorStop(0, 'rgba(255, 255, 220, 0.9)');
          gradDoc2.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradDoc2;
          ctx.beginPath();
          ctx.arc(doc2CenterX, doc2CenterY, radiusDoc2, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var doc2nw = car2Doc2Image.naturalWidth;
        var doc2nh = car2Doc2Image.naturalHeight;
        ctx.drawImage(car2Doc2Image, doc2CenterX - doc2nw / 2, doc2CenterY - doc2nh / 2, doc2nw, doc2nh);
      }

      // 車廂2 文件3：col 43, row 10（與其他文件同水平），靠近時光暈
      if (currentMapIndex === 1 && car2Doc3Image.complete && car2Doc3Image.naturalWidth > 0) {
        var doc3CenterX = 43 * TILE_SIZE + TILE_SIZE / 2;
        var doc3CenterY = 10 * TILE_SIZE - 10;
        if (isNearCar2Doc3Now) {
          var tDoc3 = Date.now() / 300;
          var pulseDoc3 = (Math.sin(tDoc3) + 1) / 2;
          var radiusDoc3 = 28 + 10 * pulseDoc3;
          var gradDoc3 = ctx.createRadialGradient(doc3CenterX, doc3CenterY, 4, doc3CenterX, doc3CenterY, radiusDoc3);
          gradDoc3.addColorStop(0, 'rgba(255, 255, 220, 0.9)');
          gradDoc3.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradDoc3;
          ctx.beginPath();
          ctx.arc(doc3CenterX, doc3CenterY, radiusDoc3, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var doc3nw = car2Doc3Image.naturalWidth;
        var doc3nh = car2Doc3Image.naturalHeight;
        ctx.drawImage(car2Doc3Image, doc3CenterX - doc3nw / 2, doc3CenterY - doc3nh / 2, doc3nw, doc3nh);
      }

      // 車廂2 文件4：col 47, row 10（與其他文件同水平），靠近時光暈
      if (currentMapIndex === 1 && car2Doc4Image.complete && car2Doc4Image.naturalWidth > 0) {
        var doc4CenterX = 47 * TILE_SIZE + TILE_SIZE / 2;
        var doc4CenterY = 10 * TILE_SIZE - 10;
        if (isNearCar2Doc4Now) {
          var tDoc4 = Date.now() / 300;
          var pulseDoc4 = (Math.sin(tDoc4) + 1) / 2;
          var radiusDoc4 = 28 + 10 * pulseDoc4;
          var gradDoc4 = ctx.createRadialGradient(doc4CenterX, doc4CenterY, 4, doc4CenterX, doc4CenterY, radiusDoc4);
          gradDoc4.addColorStop(0, 'rgba(255, 255, 220, 0.9)');
          gradDoc4.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradDoc4;
          ctx.beginPath();
          ctx.arc(doc4CenterX, doc4CenterY, radiusDoc4, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var doc4nw = car2Doc4Image.naturalWidth;
        var doc4nh = car2Doc4Image.naturalHeight;
        ctx.drawImage(car2Doc4Image, doc4CenterX - doc4nw / 2, doc4CenterY - doc4nh / 2, doc4nw, doc4nh);
      }

      // 車廂3 車門：玩家提供位置 (x=1183, y=288)，強烈光暈
      if (currentMapIndex === 2 && car3DoorImage.complete && car3DoorImage.naturalWidth > 0) {
        var doorCenterX = 1183;
        var doorCenterY = 288;
        if (isNearCar3DoorNow) {
          var tDoor = Date.now() / 300;
          var pulseDoor = (Math.sin(tDoor) + 1) / 2;
          var radiusDoor = 36 + 14 * pulseDoor;
          var gradDoor = ctx.createRadialGradient(doorCenterX, doorCenterY, 4, doorCenterX, doorCenterY, radiusDoor);
          gradDoor.addColorStop(0, 'rgba(255, 255, 230, 1.0)');
          gradDoor.addColorStop(0.4, 'rgba(255, 255, 210, 0.7)');
          gradDoor.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradDoor;
          ctx.beginPath();
          ctx.arc(doorCenterX, doorCenterY, radiusDoor, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var dnw = car3DoorImage.naturalWidth;
        var dnh = car3DoorImage.naturalHeight;
        ctx.drawImage(car3DoorImage, doorCenterX - dnw / 2, doorCenterY - dnh / 2, dnw, dnh);
      }

      // 車廂3 餐車：玩家提供位置 (x=1461, y=320)
      if (currentMapIndex === 2 && car3CartImage.complete && car3CartImage.naturalWidth > 0) {
        var cartCenterX = 1461;
        var cartCenterY = 320;
        if (isNearCar3CartNow) {
          var tCart = Date.now() / 300;
          var pulseCart = (Math.sin(tCart) + 1) / 2;
          var radiusCart = 22 + 6 * pulseCart;
          var gradCart = ctx.createRadialGradient(cartCenterX, cartCenterY, 4, cartCenterX, cartCenterY, radiusCart);
          gradCart.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
          gradCart.addColorStop(1, 'rgba(255, 255, 180, 0)');
          ctx.save();
          ctx.fillStyle = gradCart;
          ctx.beginPath();
          ctx.arc(cartCenterX, cartCenterY, radiusCart, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
        var cnw = car3CartImage.naturalWidth;
        var cnh = car3CartImage.naturalHeight;
        // 維持原始圖片尺寸
        ctx.drawImage(car3CartImage, cartCenterX - cnw / 2, cartCenterY - cnh / 2, cnw, cnh);
      }

      drawPlayer({
        x: player.x,
        y: player.y,
        width: player.width,
        height: player.height
      });

      if (drawForeground && drawForeground.complete && drawForeground.naturalWidth > 0) {
        ctx.drawImage(drawForeground, 0, 0, WORLD_WIDTH, WORLD_HEIGHT, 0, 0, WORLD_WIDTH, WORLD_HEIGHT);
      }

      ctx.restore();

      if (debugPanel && debugPanelText && !debugPanel.classList.contains('hidden')) {
        const col = Math.floor(player.x / TILE_SIZE);
        const row = Math.floor(player.y / TILE_SIZE);
        debugPanelText.textContent = [
          '地圖: ' + (currentMapIndex + 1) + '/' + MAP_LIST.length + ' ' + (MAP_LIST[currentMapIndex] ? MAP_LIST[currentMapIndex].name : '?') + (currentMapIndex === 0 && platformCarriageOpen ? ' (車廂開)' : ''),
          'player.x: ' + player.x.toFixed(1),
          'player.y: ' + player.y.toFixed(1),
          '格子 col: ' + col + ', row: ' + row,
          '世界: ' + WORLD_WIDTH + ' x ' + WORLD_HEIGHT,
          'camera: ' + camera.x.toFixed(0) + ', ' + camera.y.toFixed(0)
        ].join('\n');
      }

      if (DEBUG_CAMERA) {
        var mapH = WORLD_HEIGHT;
        var mapW = WORLD_WIDTH;
        var diffH = mapH - camera.viewH;
        var viewLargerThanMap = camera.viewH > mapH;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.font = '10px monospace';
        ctx.fillStyle = '#0f0';
        ctx.fillText('mapH=' + mapH + ' viewH=' + camera.viewH + ' diff=' + diffH, 4, 12);
        ctx.fillText('camera.y=' + camera.y + ' view>map=' + viewLargerThanMap, 4, 24);
        ctx.setTransform(dpr * currentScale, 0, 0, dpr * currentScale, 0, 0);
      }
    }

    let lastFrameTime = 0;
    function loop(now) {
      now = now ?? performance.now();
      if (lastFrameTime === 0) lastFrameTime = now;
      const dt = Math.min((now - lastFrameTime) / 1000, 0.1); // seconds, cap to avoid jump after tab focus
      lastFrameTime = now;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    function drawPlayer(p) {
      const halfW = p.width / 2;
      const halfH = p.height / 2;
      const x = p.x - halfW;
      const y = p.y - halfH;

      var sprites = (typeof selectedCharacter !== 'undefined' && selectedCharacter === 'player2') ? player2Sprites : playerSprites;
      var sprite = sprites[player.dir];
      // 朝上時：走動中來回撥放 站立 / walk，停止後 0.3 秒換回站立圖
      if (player.dir === 'up' && sprites.upWalk && sprites.upWalk.complete && sprites.upWalk.naturalWidth > 0) {
        if (player.moving) {
          sprite = (Math.floor(Date.now() / 200) % 2 === 0) ? sprites.up : sprites.upWalk;
        } else {
          sprite = (Date.now() - (player.idleSince || 0) >= 300) ? sprites.up : sprites.upWalk;
        }
      }
      // 朝下時：同上
      if (player.dir === 'down' && sprites.downWalk && sprites.downWalk.complete && sprites.downWalk.naturalWidth > 0) {
        if (player.moving) {
          sprite = (Math.floor(Date.now() / 200) % 2 === 0) ? sprites.down : sprites.downWalk;
        } else {
          sprite = (Date.now() - (player.idleSince || 0) >= 300) ? sprites.down : sprites.downWalk;
        }
      }
      if (player.dir === 'right' && sprites.rightWalk && sprites.rightWalk.complete && sprites.rightWalk.naturalWidth > 0) {
        if (player.moving) {
          sprite = (Math.floor(Date.now() / 200) % 2 === 0) ? sprites.right : sprites.rightWalk;
        } else {
          sprite = (Date.now() - (player.idleSince || 0) >= 300) ? sprites.right : sprites.rightWalk;
        }
      }
      if (player.dir === 'left' && sprites.leftWalk && sprites.leftWalk.complete && sprites.leftWalk.naturalWidth > 0) {
        if (player.moving) {
          sprite = (Math.floor(Date.now() / 200) % 2 === 0) ? sprites.left : sprites.leftWalk;
        } else {
          sprite = (Date.now() - (player.idleSince || 0) >= 300) ? sprites.left : sprites.leftWalk;
        }
      }
      if (sprite && sprite.complete && sprite.naturalWidth > 0) {
        // Use directional sprite image with a soft glow
        ctx.save();
        ctx.shadowColor = 'rgba(255, 255, 200, 0.8)';
        ctx.shadowBlur = 15;
        ctx.drawImage(sprite, x, y, p.width, p.height);
        ctx.restore();
        return;
      }

      // Fallback: simple placeholder if sprites not found
      ctx.fillStyle = '#3b7cff';
      ctx.fillRect(x + p.width * 0.2, y + p.height * 0.3, p.width * 0.6, p.height * 0.5);

      const headRadius = p.width * 0.3;
      ctx.fillStyle = '#ffddaa';
      ctx.beginPath();
      ctx.arc(p.x, y + headRadius + 2, headRadius, 0, Math.PI * 2);
      ctx.fill();

      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(p.x - p.width * 0.15, y + p.height * 0.8);
      ctx.lineTo(p.x - p.width * 0.15, y + p.height);
      ctx.moveTo(p.x + p.width * 0.15, y + p.height * 0.8);
      ctx.lineTo(p.x + p.width * 0.15, y + p.height);
      ctx.stroke();
    }

    function isPlayerInZone(p, zone) {
      const halfW = p.width / 2;
      const halfH = p.height / 2;
      const left = p.x - halfW;
      const right = p.x + halfW;
      const top = p.y - halfH;
      const bottom = p.y + halfH;

      return !(
        right < zone.x ||
        left > zone.x + zone.width ||
        bottom < zone.y ||
        top > zone.y + zone.height
      );
    }

    // 僅用玩家「中心點」是否在區內判定（觸發區 y 只含 row 10 時，row 11 自然在區外）
    function isPlayerCenterInZone(p, zone) {
      return p.x >= zone.x && p.x < zone.x + zone.width &&
             p.y >= zone.y && p.y < zone.y + zone.height;
    }

    // Start loop immediately; background will appear once loaded.
    loop();

    // --- Popup (Bottom Sheet) behavior ---
    function closeModal() {
      if (bottomSheet) bottomSheet.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { popup.classList.add('hidden'); }, 300);
    }
    function closeModalHuang() {
      if (bottomSheetHuang) bottomSheetHuang.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupHuang) popupHuang.classList.add('hidden'); }, 300);
    }
    function closeModalDu() {
      if (bottomSheetDu) bottomSheetDu.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupDu) popupDu.classList.add('hidden'); }, 300);
    }
    function closeModalLiu() {
      if (bottomSheetLiu) bottomSheetLiu.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupLiu) popupLiu.classList.add('hidden'); }, 300);
    }
    function closeModalYang() {
      if (bottomSheetYang) bottomSheetYang.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupYang) popupYang.classList.add('hidden'); }, 300);
    }
    function closeModalWang() {
      if (bottomSheetWang) bottomSheetWang.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupWang) popupWang.classList.add('hidden'); }, 300);
    }
    function closeModalZhugong() {
      if (bottomSheetZhugong) bottomSheetZhugong.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupZhugong) popupZhugong.classList.add('hidden'); }, 300);
    }
    function closeModalBento() {
      if (bottomSheetBento) bottomSheetBento.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupBento) popupBento.classList.add('hidden'); }, 300);
    }
    function closeModalToilet() {
      if (bottomSheetToilet) bottomSheetToilet.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupToilet) popupToilet.classList.add('hidden'); }, 300);
    }
    function closeModalTicket() {
      if (bottomSheetTicket) bottomSheetTicket.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupTicket) popupTicket.classList.add('hidden'); }, 300);
    }
    function closeModalBookshelf() {
      if (bottomSheetBookshelf) bottomSheetBookshelf.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupBookshelf) popupBookshelf.classList.add('hidden'); }, 300);
    }
    function closeModalNotice() {
      if (bottomSheetNotice) bottomSheetNotice.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupNotice) popupNotice.classList.add('hidden'); }, 300);
    }
    function closeModalStationSign() {
      if (bottomSheetStationSign) bottomSheetStationSign.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupStationSign) popupStationSign.classList.add('hidden'); }, 300);
    }
    function closeModalElectronicBoardLeft() {
      if (bottomSheetElectronicBoardLeft) bottomSheetElectronicBoardLeft.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupElectronicBoardLeft) popupElectronicBoardLeft.classList.add('hidden'); }, 300);
    }
    function closeModalElectronicBoardRight() {
      if (bottomSheetElectronicBoardRight) bottomSheetElectronicBoardRight.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupElectronicBoardRight) popupElectronicBoardRight.classList.add('hidden'); }, 300);
    }
    function closeModalShinonggongshang() {
      if (bottomSheetShinonggongshang) bottomSheetShinonggongshang.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupShinonggongshang) popupShinonggongshang.classList.add('hidden'); }, 300);
    }
    function closeModalXu() {
      if (bottomSheetXu) bottomSheetXu.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupXu) popupXu.classList.add('hidden'); }, 300);
    }
    function closeModalCar2Orc() {
      if (bottomSheetCar2Orc) bottomSheetCar2Orc.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupCar2Orc) popupCar2Orc.classList.add('hidden'); }, 300);
    }
    function closeModalCar2Doc2() {
      if (bottomSheetCar2Doc2) bottomSheetCar2Doc2.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupCar2Doc2) popupCar2Doc2.classList.add('hidden'); }, 300);
    }
    function closeModalCar2Doc3() {
      if (bottomSheetCar2Doc3) bottomSheetCar2Doc3.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupCar2Doc3) popupCar2Doc3.classList.add('hidden'); }, 300);
    }
    function closeModalCar2Doc4() {
      if (bottomSheetCar2Doc4) bottomSheetCar2Doc4.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupCar2Doc4) popupCar2Doc4.classList.add('hidden'); }, 300);
    }
    function closeModalCar3Window() {
      if (bottomSheetCar3Window) bottomSheetCar3Window.classList.remove('open');
      if (videoCar3Window) {
        try {
          videoCar3Window.pause();
          videoCar3Window.currentTime = 0;
        } catch (e) {}
      }
      releasePopupLock();
      setTimeout(function () { if (popupCar3Window) popupCar3Window.classList.add('hidden'); }, 300);
    }
    function closeModalCar3Window2() {
      if (bottomSheetCar3Window2) bottomSheetCar3Window2.classList.remove('open');
      if (videoCar3Window2) {
        try {
          videoCar3Window2.pause();
          videoCar3Window2.currentTime = 0;
        } catch (e) {}
      }
      releasePopupLock();
      setTimeout(function () { if (popupCar3Window2) popupCar3Window2.classList.add('hidden'); }, 300);
    }

    function closeModalCar3Window3() {
      if (bottomSheetCar3Window3) bottomSheetCar3Window3.classList.remove('open');
      if (videoCar3Window3) {
        try {
          videoCar3Window3.pause();
          videoCar3Window3.currentTime = 0;
        } catch (e) {}
      }
      releasePopupLock();
      setTimeout(function () { if (popupCar3Window3) popupCar3Window3.classList.add('hidden'); }, 300);
    }

    function closeModalCar3Door() {
      if (bottomSheetCar3Door) bottomSheetCar3Door.classList.remove('open');
      if (videoCar3Door) {
        try {
          videoCar3Door.pause();
          videoCar3Door.currentTime = 0;
        } catch (e) {}
      }
      releasePopupLock();
      setTimeout(function () { if (popupCar3Door) popupCar3Door.classList.add('hidden'); }, 300);
    }

    function closeModalCar3Cart() {
      if (bottomSheetCar3Cart) bottomSheetCar3Cart.classList.remove('open');
      releasePopupLock();
      setTimeout(function () { if (popupCar3Cart) popupCar3Cart.classList.add('hidden'); }, 300);
    }

    // 關閉所有資訊彈窗：給方向鍵與 ESC 使用
    function closeAllInfoPopups() {
      closeModal();
      closeModalHuang();
      closeModalDu();
      closeModalLiu();
      closeModalYang();
      closeModalWang();
      closeModalZhugong();
      closeModalBento();
      closeModalToilet();
      closeModalTicket();
      closeModalBookshelf();
      closeModalNotice();
      closeModalStationSign();
      closeModalElectronicBoardLeft();
      closeModalElectronicBoardRight();
      closeModalShinonggongshang();
      closeModalXu();
      closeModalCar2Orc();
      closeModalCar2Doc2();
      closeModalCar2Doc3();
      closeModalCar2Doc4();
      closeModalCar3Window();
      closeModalCar3Window2();
      closeModalCar3Window3();
      closeModalCar3Door();
      closeModalCar3Cart();
    }

    popup.addEventListener('click', function (e) {
      if (e.target === popup) closeModal();
    });
    popupClose.addEventListener('click', function (e) {
      e.stopPropagation();
      closeModal();
    });
    if (bottomSheet) {
      bottomSheet.addEventListener('click', function (e) { e.stopPropagation(); });
    }

    // 捲動進度條（右側直條）：固定高度藍色區塊，隨捲動往下移動，點擊可跳轉；內容不足則不顯示拉條
    const SCROLL_THUMB_HEIGHT_PCT = 20; // 藍色區塊佔軌道高度比例
    function updateScrollProgress(scrollEl, bar, wrap) {
      if (!scrollEl || !bar) return;
      const needScroll = scrollEl.scrollHeight > scrollEl.clientHeight;
      if (wrap) {
        if (!needScroll) {
          wrap.classList.add('no-scroll');
          return;
        }
        wrap.classList.remove('no-scroll');
      }
      const max = scrollEl.scrollHeight - scrollEl.clientHeight;
      const pct = max <= 0 ? 0 : scrollEl.scrollTop / max;
      const topPct = pct * (100 - SCROLL_THUMB_HEIGHT_PCT);
      bar.style.top = topPct.toFixed(1) + '%';
    }
    var scrollProgressItems = [];
    function refreshScrollProgressVisibility() {
      requestAnimationFrame(function () {
        scrollProgressItems.forEach(function (item) {
          var scrollEl = item.scrollEl;
          var bar = item.bar;
          var wrap = item.wrap;
          if (!scrollEl || !wrap) return;
          if (!scrollEl.closest || !scrollEl.closest('.bottom-sheet.open')) return;
          updateScrollProgress(scrollEl, bar, wrap);
        });
      });
    }
    function setupScrollProgress(scrollEl, wrap, bar) {
      if (!scrollEl || !bar) return;
      scrollProgressItems.push({ scrollEl: scrollEl, bar: bar, wrap: wrap || null });
      scrollEl.addEventListener('scroll', function () { updateScrollProgress(scrollEl, bar, wrap); });
      if (wrap) {
        // 共用的根據指標位置更新捲動的邏輯
        function handlePointer(clientY) {
          const rect = wrap.getBoundingClientRect();
          const offsetY = Math.max(0, Math.min(rect.height, clientY - rect.top));
          const pct = Math.max(0, Math.min(1, offsetY / rect.height));
          const max = scrollEl.scrollHeight - scrollEl.clientHeight;
          scrollEl.scrollTop = pct * max;
          updateScrollProgress(scrollEl, bar, wrap);
        }

        // 點一下軌道：跳到指定位置
        wrap.addEventListener('click', function (e) {
          handlePointer(e.clientY);
        });

        // 滑鼠拖曳：按住軌道或藍色區塊皆可拖動
        wrap.addEventListener('mousedown', function (e) {
          e.preventDefault();
          handlePointer(e.clientY);
          function onMove(ev) {
            handlePointer(ev.clientY);
          }
          function onUp() {
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);
          }
          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        });

        // 觸控拖曳（手機、平板）
        wrap.addEventListener('touchstart', function (e) {
          if (!e.touches || !e.touches.length) return;
          e.preventDefault();
          handlePointer(e.touches[0].clientY);
        }, { passive: false });
        wrap.addEventListener('touchmove', function (e) {
          if (!e.touches || !e.touches.length) return;
          e.preventDefault();
          handlePointer(e.touches[0].clientY);
        }, { passive: false });
      }
    }
    const bottomSheetScrollZhou = document.getElementById('bottomSheetScrollZhou');
    const scrollProgressBarZhou = document.getElementById('scrollProgressBarZhou');
    const scrollProgressWrapZhou = document.getElementById('scrollProgressZhou');
    const bottomSheetScrollHuang = document.getElementById('bottomSheetScrollHuang');
    const scrollProgressBarHuang = document.getElementById('scrollProgressBarHuang');
    const scrollProgressWrapHuang = document.getElementById('scrollProgressHuang');
    const bottomSheetScrollDu = document.getElementById('bottomSheetScrollDu');
    const scrollProgressBarDu = document.getElementById('scrollProgressBarDu');
    const scrollProgressWrapDu = document.getElementById('scrollProgressDu');
    const bottomSheetScrollLiu = document.getElementById('bottomSheetScrollLiu');
    const scrollProgressBarLiu = document.getElementById('scrollProgressBarLiu');
    const scrollProgressWrapLiu = document.getElementById('scrollProgressLiu');
    const bottomSheetScrollYang = document.getElementById('bottomSheetScrollYang');
    const scrollProgressBarYang = document.getElementById('scrollProgressBarYang');
    const scrollProgressWrapYang = document.getElementById('scrollProgressYang');
    const bottomSheetScrollWang = document.getElementById('bottomSheetScrollWang');
    const scrollProgressBarWang = document.getElementById('scrollProgressBarWang');
    const scrollProgressWrapWang = document.getElementById('scrollProgressWang');
    const bottomSheetScrollXu = document.getElementById('bottomSheetScrollXu');
    const scrollProgressBarXu = document.getElementById('scrollProgressBarXu');
    const scrollProgressWrapXu = document.getElementById('scrollProgressXu');
    const bottomSheetScrollZhugong = document.getElementById('bottomSheetScrollZhugong');
    const scrollProgressBarZhugong = document.getElementById('scrollProgressBarZhugong');
    const scrollProgressWrapZhugong = document.getElementById('scrollProgressZhugong');
    const bottomSheetScrollCar3Window = document.getElementById('bottomSheetScrollCar3Window');
    const scrollProgressBarCar3Window = document.getElementById('scrollProgressBarCar3Window');
    const scrollProgressWrapCar3Window = document.getElementById('scrollProgressCar3Window');
    const bottomSheetScrollCar3Window2 = document.getElementById('bottomSheetScrollCar3Window2');
    const scrollProgressBarCar3Window2 = document.getElementById('scrollProgressBarCar3Window2');
    const scrollProgressWrapCar3Window2 = document.getElementById('scrollProgressCar3Window2');
    const bottomSheetScrollCar3Window3 = document.getElementById('bottomSheetScrollCar3Window3');
    const scrollProgressBarCar3Window3 = document.getElementById('scrollProgressBarCar3Window3');
    const scrollProgressWrapCar3Window3 = document.getElementById('scrollProgressCar3Window3');
    const bottomSheetScrollCar3Door = document.getElementById('bottomSheetScrollCar3Door');
    const scrollProgressBarCar3Door = document.getElementById('scrollProgressBarCar3Door');
    const scrollProgressWrapCar3Door = document.getElementById('scrollProgressCar3Door');
    const bottomSheetScrollCar2Orc = document.getElementById('bottomSheetScrollCar2Orc');
    const scrollProgressBarCar2Orc = document.getElementById('scrollProgressBarCar2Orc');
    const scrollProgressWrapCar2Orc = document.getElementById('scrollProgressCar2Orc');
    const bottomSheetScrollCar2Doc2 = document.getElementById('bottomSheetScrollCar2Doc2');
    const scrollProgressBarCar2Doc2 = document.getElementById('scrollProgressBarCar2Doc2');
    const scrollProgressWrapCar2Doc2 = document.getElementById('scrollProgressCar2Doc2');
    const bottomSheetScrollCar2Doc3 = document.getElementById('bottomSheetScrollCar2Doc3');
    const scrollProgressBarCar2Doc3 = document.getElementById('scrollProgressBarCar2Doc3');
    const scrollProgressWrapCar2Doc3 = document.getElementById('scrollProgressCar2Doc3');
    const bottomSheetScrollCar2Doc4 = document.getElementById('bottomSheetScrollCar2Doc4');
    const scrollProgressBarCar2Doc4 = document.getElementById('scrollProgressBarCar2Doc4');
    const scrollProgressWrapCar2Doc4 = document.getElementById('scrollProgressCar2Doc4');
    setupScrollProgress(bottomSheetScrollZhou, scrollProgressWrapZhou, scrollProgressBarZhou);
    setupScrollProgress(bottomSheetScrollHuang, scrollProgressWrapHuang, scrollProgressBarHuang);
    setupScrollProgress(bottomSheetScrollDu, scrollProgressWrapDu, scrollProgressBarDu);
    setupScrollProgress(bottomSheetScrollLiu, scrollProgressWrapLiu, scrollProgressBarLiu);
    setupScrollProgress(bottomSheetScrollYang, scrollProgressWrapYang, scrollProgressBarYang);
    setupScrollProgress(bottomSheetScrollWang, scrollProgressWrapWang, scrollProgressBarWang);
    setupScrollProgress(bottomSheetScrollXu, scrollProgressWrapXu, scrollProgressBarXu);
    setupScrollProgress(bottomSheetScrollZhugong, scrollProgressWrapZhugong, scrollProgressBarZhugong);
    setupScrollProgress(bottomSheetScrollCar2Orc, scrollProgressWrapCar2Orc, scrollProgressBarCar2Orc);
    setupScrollProgress(bottomSheetScrollCar2Doc2, scrollProgressWrapCar2Doc2, scrollProgressBarCar2Doc2);
    setupScrollProgress(bottomSheetScrollCar2Doc3, scrollProgressWrapCar2Doc3, scrollProgressBarCar2Doc3);
    setupScrollProgress(bottomSheetScrollCar2Doc4, scrollProgressWrapCar2Doc4, scrollProgressBarCar2Doc4);
    setupScrollProgress(bottomSheetScrollCar3Window, scrollProgressWrapCar3Window, scrollProgressBarCar3Window);
    setupScrollProgress(bottomSheetScrollCar3Window2, scrollProgressWrapCar3Window2, scrollProgressBarCar3Window2);
    setupScrollProgress(bottomSheetScrollCar3Window3, scrollProgressWrapCar3Window3, scrollProgressBarCar3Window3);
    setupScrollProgress(bottomSheetScrollCar3Door, scrollProgressWrapCar3Door, scrollProgressBarCar3Door);

    // 任一 bottom-sheet 打開時，檢查該彈窗內容是否需捲動，不足則隱藏拉條
    (function () {
      var observer = new MutationObserver(function (mutations) {
        for (var i = 0; i < mutations.length; i++) {
          if (mutations[i].attributeName === 'class') {
            var el = mutations[i].target;
            if (el.classList && el.classList.contains('open')) refreshScrollProgressVisibility();
            break;
          }
        }
      });
      document.querySelectorAll('.bottom-sheet').forEach(function (sheet) {
        observer.observe(sheet, { attributes: true });
      });
    })();

    if (popupHuang) {
      popupHuang.addEventListener('click', function (e) {
        if (e.target === popupHuang) closeModalHuang();
      });
    }
    if (popupHuangClose) {
      popupHuangClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalHuang();
      });
    }
    if (bottomSheetHuang) {
      bottomSheetHuang.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupDu) {
      popupDu.addEventListener('click', function (e) {
        if (e.target === popupDu) closeModalDu();
      });
    }
    if (popupDuClose) {
      popupDuClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalDu();
      });
    }
    if (bottomSheetDu) {
      bottomSheetDu.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupLiu) {
      popupLiu.addEventListener('click', function (e) {
        if (e.target === popupLiu) closeModalLiu();
      });
    }
    if (popupLiuClose) {
      popupLiuClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalLiu();
      });
    }
    if (bottomSheetLiu) {
      bottomSheetLiu.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupYang) {
      popupYang.addEventListener('click', function (e) {
        if (e.target === popupYang) closeModalYang();
      });
    }
    if (popupYangClose) {
      popupYangClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalYang();
      });
    }
    if (bottomSheetYang) {
      bottomSheetYang.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupWang) {
      popupWang.addEventListener('click', function (e) {
        if (e.target === popupWang) closeModalWang();
      });
    }
    if (popupWangClose) {
      popupWangClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalWang();
      });
    }
    if (bottomSheetWang) {
      bottomSheetWang.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupXu) {
      popupXu.addEventListener('click', function (e) {
        if (e.target === popupXu) closeModalXu();
      });
    }
    if (popupXuClose) {
      popupXuClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalXu();
      });
    }
    if (bottomSheetXu) {
      bottomSheetXu.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupZhugong) {
      popupZhugong.addEventListener('click', function (e) {
        if (e.target === popupZhugong) closeModalZhugong();
      });
    }
    if (popupZhugongClose) {
      popupZhugongClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalZhugong();
      });
    }
    if (bottomSheetZhugong) {
      bottomSheetZhugong.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupBento) {
      popupBento.addEventListener('click', function (e) {
        if (e.target === popupBento) closeModalBento();
      });
    }
    if (popupBentoClose) {
      popupBentoClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalBento();
      });
    }
    if (bottomSheetBento) {
      bottomSheetBento.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupToilet) {
      popupToilet.addEventListener('click', function (e) {
        if (e.target === popupToilet) closeModalToilet();
      });
    }
    if (popupToiletClose) {
      popupToiletClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalToilet();
      });
    }
    if (bottomSheetToilet) {
      bottomSheetToilet.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupTicket) {
      popupTicket.addEventListener('click', function (e) {
        if (e.target === popupTicket) closeModalTicket();
      });
    }
    if (popupTicketClose) {
      popupTicketClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalTicket();
      });
    }
    if (bottomSheetTicket) {
      bottomSheetTicket.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupBookshelf) {
      popupBookshelf.addEventListener('click', function (e) {
        if (e.target === popupBookshelf) closeModalBookshelf();
      });
    }
    if (popupBookshelfClose) {
      popupBookshelfClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalBookshelf();
      });
    }
    if (bottomSheetBookshelf) {
      bottomSheetBookshelf.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupNotice) {
      popupNotice.addEventListener('click', function (e) {
        if (e.target === popupNotice) closeModalNotice();
      });
    }
    if (popupNoticeClose) {
      popupNoticeClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalNotice();
      });
    }
    if (bottomSheetNotice) {
      bottomSheetNotice.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupStationSign) {
      popupStationSign.addEventListener('click', function (e) {
        if (e.target === popupStationSign) closeModalStationSign();
      });
    }
    if (popupStationSignClose) {
      popupStationSignClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalStationSign();
      });
    }
    if (bottomSheetStationSign) {
      bottomSheetStationSign.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupElectronicBoardLeft) {
      popupElectronicBoardLeft.addEventListener('click', function (e) {
        if (e.target === popupElectronicBoardLeft) closeModalElectronicBoardLeft();
      });
    }
    if (popupElectronicBoardLeftClose) {
      popupElectronicBoardLeftClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalElectronicBoardLeft();
      });
    }
    if (bottomSheetElectronicBoardLeft) {
      bottomSheetElectronicBoardLeft.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupElectronicBoardRight) {
      popupElectronicBoardRight.addEventListener('click', function (e) {
        if (e.target === popupElectronicBoardRight) closeModalElectronicBoardRight();
      });
    }
    if (popupElectronicBoardRightClose) {
      popupElectronicBoardRightClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalElectronicBoardRight();
      });
    }
    if (bottomSheetElectronicBoardRight) {
      bottomSheetElectronicBoardRight.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupShinonggongshang) {
      popupShinonggongshang.addEventListener('click', function (e) {
        if (e.target === popupShinonggongshang) closeModalShinonggongshang();
      });
    }
    if (popupShinonggongshangClose) {
      popupShinonggongshangClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalShinonggongshang();
      });
    }
    if (bottomSheetShinonggongshang) {
      bottomSheetShinonggongshang.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar2Orc) {
      popupCar2Orc.addEventListener('click', function (e) {
        if (e.target === popupCar2Orc) closeModalCar2Orc();
      });
    }
    if (popupCar2OrcClose) {
      popupCar2OrcClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar2Orc();
      });
    }
    if (bottomSheetCar2Orc) {
      bottomSheetCar2Orc.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar2Doc2) {
      popupCar2Doc2.addEventListener('click', function (e) {
        if (e.target === popupCar2Doc2) closeModalCar2Doc2();
      });
    }
    if (popupCar2Doc2Close) {
      popupCar2Doc2Close.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar2Doc2();
      });
    }
    if (bottomSheetCar2Doc2) {
      bottomSheetCar2Doc2.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar2Doc3) {
      popupCar2Doc3.addEventListener('click', function (e) {
        if (e.target === popupCar2Doc3) closeModalCar2Doc3();
      });
    }
    if (popupCar2Doc3Close) {
      popupCar2Doc3Close.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar2Doc3();
      });
    }
    if (bottomSheetCar2Doc3) {
      bottomSheetCar2Doc3.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar2Doc4) {
      popupCar2Doc4.addEventListener('click', function (e) {
        if (e.target === popupCar2Doc4) closeModalCar2Doc4();
      });
    }
    if (popupCar2Doc4Close) {
      popupCar2Doc4Close.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar2Doc4();
      });
    }
    if (bottomSheetCar2Doc4) {
      bottomSheetCar2Doc4.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar3Window) {
      popupCar3Window.addEventListener('click', function (e) {
        if (e.target === popupCar3Window) closeModalCar3Window();
      });
    }
    if (popupCar3WindowClose) {
      popupCar3WindowClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar3Window();
      });
    }
    if (bottomSheetCar3Window) {
      bottomSheetCar3Window.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar3Window2) {
      popupCar3Window2.addEventListener('click', function (e) {
        if (e.target === popupCar3Window2) closeModalCar3Window2();
      });
    }
    if (popupCar3Window2Close) {
      popupCar3Window2Close.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar3Window2();
      });
    }
    if (bottomSheetCar3Window2) {
      bottomSheetCar3Window2.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar3Window3) {
      popupCar3Window3.addEventListener('click', function (e) {
        if (e.target === popupCar3Window3) closeModalCar3Window3();
      });
    }
    if (popupCar3Window3Close) {
      popupCar3Window3Close.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar3Window3();
      });
    }
    if (bottomSheetCar3Window3) {
      bottomSheetCar3Window3.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar3Door) {
      popupCar3Door.addEventListener('click', function (e) {
        if (e.target === popupCar3Door) closeModalCar3Door();
      });
    }
    if (popupCar3DoorClose) {
      popupCar3DoorClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar3Door();
      });
    }
    if (bottomSheetCar3Door) {
      bottomSheetCar3Door.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (popupCar3Cart) {
      popupCar3Cart.addEventListener('click', function (e) {
        if (e.target === popupCar3Cart) closeModalCar3Cart();
      });
    }
    if (popupCar3CartClose) {
      popupCar3CartClose.addEventListener('click', function (e) {
        e.stopPropagation();
        closeModalCar3Cart();
      });
    }
    if (bottomSheetCar3Cart) {
      bottomSheetCar3Cart.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    if (car3CartCopyButton && navigator.clipboard && navigator.clipboard.writeText) {
      car3CartCopyButton.addEventListener('click', function () {
        if (car3CartShareUrl && car3CartShareUrl.textContent) {
          navigator.clipboard.writeText(car3CartShareUrl.textContent).catch(function () {});
        }
      });
    }

    // --- 右側漢堡選單：開啟、關閉、分頁、成就 UI ---
    if (menuPanel) {
      menuPanel.addEventListener('click', function (e) { e.stopPropagation(); });
    }
    helpButton.addEventListener('click', function () {
      helpOverlay.classList.remove('hidden');
      if (helpButton) helpButton.classList.add('menu-open');
      updateAchievementUI();
    });
    function closeMenu() {
      helpOverlay.classList.add('hidden');
      if (helpButton) helpButton.classList.remove('menu-open');
    }
    helpClose.addEventListener('click', closeMenu);
    if (menuBackdrop) {
      menuBackdrop.addEventListener('click', closeMenu);
    }
    document.querySelectorAll('.menu-tab').forEach(function (tab) {
      tab.addEventListener('click', function () {
        var t = tab.getAttribute('data-tab');
        if (!menuPanel || !t) return;
        menuPanel.setAttribute('data-active', t);
        document.querySelectorAll('.menu-tab').forEach(function (x) {
          x.classList.toggle('active', x.getAttribute('data-tab') === t);
        });
      });
    });
    if (achievementGrid) {
      achievementGrid.querySelectorAll('.achievement-item').forEach(function (item) {
        item.addEventListener('click', function () {
          achievementGrid.querySelectorAll('.achievement-item').forEach(function (other) {
            other.classList.remove('show-name');
          });
          item.classList.add('show-name');
        });
      });
    }
    updateAchievementUI();

    if (debugBtn && debugPanel) {
      debugBtn.addEventListener('click', () => {
        debugPanel.classList.toggle('hidden');
      });
    }
    if (debugCopyBtn) {
      debugCopyBtn.addEventListener('click', () => {
        const col = Math.floor(player.x / TILE_SIZE);
        const row = Math.floor(player.y / TILE_SIZE);
        const text = [
          '地圖: ' + (currentMapIndex + 1) + '/' + MAP_LIST.length + ' ' + (MAP_LIST[currentMapIndex] ? MAP_LIST[currentMapIndex].name : '?') + (currentMapIndex === 0 && platformCarriageOpen ? ' (車廂開)' : ''),
          'player.x: ' + player.x.toFixed(1),
          'player.y: ' + player.y.toFixed(1),
          '格子 col: ' + col + ', row: ' + row,
          '世界: ' + WORLD_WIDTH + ' x ' + WORLD_HEIGHT,
          'camera: ' + camera.x.toFixed(0) + ', ' + camera.y.toFixed(0)
        ].join('\n');
        const done = () => {
          debugCopyBtn.textContent = '已複製!';
          setTimeout(() => { debugCopyBtn.textContent = '複製座標'; }, 1500);
        };
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(done).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); done(); } catch (e) { debugCopyBtn.textContent = '複製失敗'; setTimeout(() => { debugCopyBtn.textContent = '複製座標'; }, 1500); }
            document.body.removeChild(ta);
          });
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand('copy'); done(); } catch (e) { debugCopyBtn.textContent = '複製失敗'; setTimeout(() => { debugCopyBtn.textContent = '複製座標'; }, 1500); }
          document.body.removeChild(ta);
        }
      });
    }
    helpOverlay.addEventListener('click', function (e) {
      if (e.target === helpOverlay) closeMenu();
    });

    // --- Start overlay behavior ---
    let hasShownStart = false;
    function showStartOverlayIfNeeded() {
      if (!hasShownStart) {
        startOverlay.classList.remove('hidden');
        hasShownStart = true;
      }
    }
    function hideStartOverlay() {
      startOverlay.classList.add('hidden');
    }
    startButton.addEventListener('click', hideStartOverlay);
    startOverlay.addEventListener('click', function(e) {
      if (e.target === startOverlay) hideStartOverlay();
    });
    // 角色選擇
    var selectedCharacter = 'player';
    var characterOptions = document.querySelectorAll('.character-option');
    characterOptions.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var ch = btn.getAttribute('data-character');
        selectedCharacter = ch;
        characterOptions.forEach(function(b) {
          var isSelected = b.getAttribute('data-character') === ch;
          b.classList.toggle('selected', isSelected);
          b.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
        });
      });
    });

    showStartOverlayIfNeeded();
  </script>
</body>
</html>

